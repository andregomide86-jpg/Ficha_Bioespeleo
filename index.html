<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subterrânea Pesquisas Ambientais</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f4f4f4;
            font-size: 14px;
            padding-bottom: 70px; /* Espaço para a barra de navegação fixa */
        }
        .main-layout {
            display: flex;
            align-items: flex-start;
        }
        .container {
            max-width: 800px;
            width: 100%;
            margin: 10px;
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            flex-grow: 1;
        }
        h1 { text-align: center; color: #333; font-size: 22px; }
        
        .tab-container-vertical {
            display: flex;
            flex-direction: column;
            background-color: #f1f1f1;
            min-width: 50px;
            padding-bottom: 15px;
            
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            height: 100vh;
            align-self: flex-start;
        }
        .tab-container-vertical button:not(.fab) {
            background-color: inherit;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 15px 10px;
            transition: 0.3s;
            font-size: 14px;
            writing-mode: vertical-lr; 
            transform: rotate(180deg);
            text-align: center;
            border-left: 4px solid transparent;
            width: 100%;
        }
        .tab-container-vertical button:not(.fab):hover { background-color: #ddd; }
        .tab-container-vertical button.active {
            background-color: #ccc;
            border-left: 4px solid #4CAF50;
        }
        
        .fab {
            position: fixed;
            right: 20px;
            z-index: 1000;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: background-color: 0.3s;
        }

        #take-photo-btn {
            background-color: #007bff; /* Azul */
            bottom: 150px; /* Posição acima do botão Salvar */
        }
        #take-photo-btn:hover {
            background-color: #0056b3;
        }
        
        #exportButton {
            background-color: #4CAF50; /* Verde */
            bottom: 80px; /* Posição acima da barra de navegação */
        }
        #exportButton:hover {
             background-color: #45a049;
        }

        #clearButton {
            background-color: #dc3545; /* Vermelho */
            color: white;
        }
        #clearButton:hover {
            background-color: #c82333;
        }

        .tab-content-wrapper {
            flex-grow: 1;
            padding: 0 10px;
        }
        .tab-content { display: none; }
        
        .accordion {
            background-color: #eee;
            color: #444;
            cursor: pointer;
            padding: 15px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
            transition: 0.4s;
            border-radius: 4px;
            margin-top: 10px;
        }
        .accordion.active, .accordion:hover { background-color: #ccc; }
        
        .accordion:after {
            content: '\002B';
            color: #777;
            font-weight: bold;
            float: right;
            margin-left: 5px;
        }
        .accordion.active:after {
            content: '\2212';
        }
        
        .panel {
            padding: 10px 18px;
            background-color: white;
            display: none;
            overflow: hidden;
            border: 1px solid #eee;
            border-top: none;
            border-radius: 0 0 4px 4px;
        }
        .panel.show {
            display: block;
        }

        .form-group { margin: 15px 0; }
        .guano-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 8px;
            align-items: center;
        }
        .guano-header { font-weight: bold; text-align: center; font-size: 12px; }
        .guano-label { font-weight: bold; }
        .guano-cell { text-align: center; }
        .guano-cell-span {
            grid-column: span 3;
            text-align: left;
        }

        .impact-grid {
            display: grid;
            grid-template-columns: 100px auto auto;
            gap: 10px;
            align-items: center;
        }
        .impact-grid > div {
            text-align: center;
        }
        .impact-grid > div:first-child {
            font-weight: normal;
            text-align: left;
        }
        .grid-header {
            font-weight: bold;
        }
        .section-title {
            font-size: 1.1em;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }


        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input[type="text"], input[type="date"], input[type="time"], input[type="number"], input[type="tel"], textarea, select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .options-group { display: flex; flex-wrap: wrap; gap: 15px; }
        .option-item { display: flex; align-items: center; gap: 5px; flex-basis: 45%; }
        .options-group-2-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .dynamic-row { display: flex; gap: 5px; align-items: center; padding-top: 10px; margin-top: 10px; border-top: 1px solid #eee;}
        .dynamic-row:first-child { border-top: none; }
        .invertebrado-entry { border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px; }
        .invertebrado-counters { display: flex; align-items: center; gap: 15px; margin-top: 5px; }
        .counter-label { font-size: 14px; font-weight: bold; }

        .quantity-stepper { display: flex; align-items: center; }
        .quantity-stepper button { width: 28px; height: 28px; padding: 0; font-size: 14px; line-height: 28px; text-align: center; margin: 0; flex-shrink: 0; }
        .quantity-stepper input { width: 40px; text-align: center; border-left: none; border-right: none; height: 28px; padding: 2px; }
        
        .add-row-btn { width: auto; padding: 5px 15px; font-size: 18px; margin-top: 10px; background-color: #007bff; }
        
        #photo-previews img { max-width: 100px; margin: 5px; border-radius: 4px; border: 1px solid #ccc; }
        
        .navigation-arrows {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background-color: #f1f1f1;
            border-top: 1px solid #ccc;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            z-index: 100;
        }
        .navigation-arrows button {
            width: 48%;
            padding: 10px 20px;
            font-size: 15px;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .navigation-arrows button:disabled {
            background-color: #e9e9e9;
            color: #aaa;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

<div class="main-layout">
    
    <div class="tab-container-vertical">
        <button id="clearButton" style="writing-mode: vertical-lr; transform: rotate(180deg); text-align: center; border-left: 4px solid transparent; margin-bottom: 20px; padding: 15px 10px !important;">Limpar Ficha</button>
        <button class="tab-link active" onclick="openTab(event, 'tabDadosGerais')">Dados Gerais</button>
        <button class="tab-link" onclick="openTab(event, 'tabCaracteristicas')">Gerais Características</button>
        <button class="tab-link" onclick="openTab(event, 'tabRecursos')">Recursos</button>
        <button class="tab-link" onclick="openTab(event, 'tabGuano')">Guano</button>
        <button class="tab-link" onclick="openTab(event, 'tabTaxons')">Táxons</button>
        <button class="tab-link" onclick="openTab(event, 'tabAporte')">Caract. Outras</button>
        <button class="tab-link" onclick="openTab(event, 'tabObservacoes')">Observações</button>
    </div>

    <div class="tab-content-wrapper">
        <div class="container">
            <h1>Subterrânea Pesquisas Ambientais</h1>
            <form id="bioForm">
                <div id="tabDadosGerais" class="tab-content" style="display: block;">
                    <div class="form-group"><label for="projeto_localidade">Projeto/Localidade</label><input type="text" id="projeto_localidade" name="projeto_localidade"></div>
                    <div class="form-group"><label for="nome_cavidade">Nome da cavidade</label><input type="text" id="nome_cavidade" name="nome_cavidade"></div>
                    <div class="form-group"><label for="data">Data</label><input type="date" id="data" name="data"></div>
                    <div class="form-group"><label for="horario">Horário (início)</label><input type="time" id="horario" name="horario"></div>
                    <div class="form-group"><label>Estação</label><select id="estacao" name="estacao"><option value="" disabled selected>Estação</option><option value="Seca">Seca</option><option value="Chuvosa">Chuvosa</option></select></div>
                    <div class="form-group"><label>Clima</label><select id="clima" name="clima"><option value="" disabled selected>Clima</option><option value="Ensolarado">Ensolarado</option><option value="Nublado">Nublado</option><option value="Chuvoso">Chuvoso</option></select></div>
                    <div class="form-group"><label for="equipe">Equipe</label><input type="text" id="equipe" name="equipe"></div>
                    <div class="form-group">
                        <label for="coordenadas">Coordenadas</label>
                        <input type="tel" id="coordenadas" name="coordenadas">
                        <button type="button" style="width:auto; padding: 8px 12px; font-size:14px; margin-top:5px; background-color:#555; color:white; border:none; border-radius:4px;" onclick="getGPS()">Obter Coordenadas GPS</button>
                    </div>
                    <input type="hidden" id="utm_zone" name="utm_zone">
                    <input type="hidden" id="utm_easting" name="utm_easting">
                    <input type="hidden" id="utm_northing" name="utm_northing">
                    <input type="hidden" id="utm_altitude" name="utm_altitude">
                </div>

                <div id="tabCaracteristicas" class="tab-content">
                    <button type="button" class="accordion">Descrição do Entorno</button>
                    <div class="panel">
                        <div class="form-group"><label>Posição na vertente</label><select id="posicao_vertente" name="posicao_vertente"><option value="" disabled selected>Posição na vertente</option><option value="Alta">Alta</option><option value="Média">Média</option><option value="Baixa">Baixa</option></select></div>
                        <div class="form-group"><label>Declividade</label><select id="declividade" name="declividade"><option value="" disabled selected>Declividade</option><option value="Plana">Plana</option><option value="Suave Ondulada">Suave Ondulada</option><option value="Ondulada">Ondulada</option><option value="Forte Ondulada">Forte Ondulada</option><option value="Montanhosa">Montanhosa</option><option value="Escarpada">Escarpada</option></select></div>
                        <div class="form-group">
                            <label>Drenagem Ativa</label>
                            <div class="options-group">
                                <div class="option-item"><input type="radio" id="drenagem_presenca" name="drenagem" value="Presença" onchange="toggleDrenagem(true)"><label for="drenagem_presenca">Presença</label></div>
                                <div class="option-item"><input type="radio" id="drenagem_ausencia" name="drenagem" value="Ausência" onchange="toggleDrenagem(false)" checked><label for="drenagem_ausencia">Ausência</label></div>
                            </div>
                            <div id="drenagem_proximidade_group" style="display:none; margin-top:10px;">
                                <label for="drenagem_proximidade">Proximidade da drenagem</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="number" id="drenagem_proximidade" name="drenagem_proximidade" style="width: 120px;">
                                    <span>metros</span>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="accordion">Vegetação</button>
                        <div class="panel">
                            <div class="options-group" id="vegetacao-group">
                                <div class="option-item"><input type="checkbox" name="vegetacao" value="Ausente"><label>Ausente</label></div>
                                <div class="option-item"><input type="checkbox" name="vegetacao" value="Rasteira"><label>Rasteira</label></div>
                                <div class="option-item"><input type="checkbox" name="vegetacao" value="Arbustos"><label>Arbustos</label></div>
                                <div class="option-item"><input type="checkbox" name="vegetacao" value="Árvores"><label>Árvores</label></div>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="accordion">Descrição da Cavidade</button>
                    <div class="panel">
                        <div class="form-group"><label>Inclinação predominante do piso</label><select id="inclinacao_piso" name="inclinacao_piso"><option value="" disabled selected>Inclinação</option><option value="Ascendente">Ascendente</option><option value="Descendente">Descendente</option><option value="Plana">Plana</option></select></div>
                        <button type="button" class="accordion">Sedimentos Clásticos</button>
                        <div class="panel">
                            <div class="options-group" id="sedimentos-group">
                                <div class="option-item"><input type="checkbox" name="sedimentos" value="Ausente"><label>Ausente</label></div>
                                <div class="option-item"><input type="checkbox" name="sedimentos" value="Argila/Silte"><label>Argila/Silte</label></div>
                                <div class="option-item"><input type="checkbox" name="sedimentos" value="Areia"><label>Areia</label></div>
                                <div class="option-item"><input type="checkbox" name="sedimentos" value="Seixo"><label>Seixo</label></div>
                                <div class="option-item"><input type="checkbox" name="sedimentos" value="Matacão"><label>Matacão</label></div>
                            </div>
                        </div>
                        <div class="form-group"><label>Umidade</label><select id="umidade" name="umidade"><option value="" disabled selected>Umidade</option><option value="Presença">Presença</option><option value="Ausência">Ausência</option></select></div>
                        <button type="button" class="accordion">Hidrologia</button>
                        <div class="panel">
                            <div class="options-group-2-col" id="hidrologia-group">
                                <div class="option-item"><input type="checkbox" name="hidrologia" value="Ausente"><label>Ausente</label></div>
                                <div class="option-item"><input type="checkbox" name="hidrologia" value="Condensação"><label>Condensação</label></div>
                                <div class="option-item"><input type="checkbox" name="hidrologia" value="Drenagem Efêmera"><label>Drenagem Efêmera</label></div>
                                <div class="option-item"><input type="checkbox" name="hidrologia" value="Drenagem Intermitente"><label>Drenagem Intermitente</label></div>
                                <div class="option-item"><input type="checkbox" name="hidrologia" value="Drenagem Perene"><label>Drenagem Perene</label></div>
                                <div class="option-item"><input type="checkbox" name="hidrologia" value="Escorrimento"><label>Escorrimento</label></div>
                                <div class="option-item"><input type="checkbox" name="hidrologia" value="Empoçamento"><label>Empoçamento</label></div>
                                <div class="option-item"><input type="checkbox" name="hidrologia" value="Exsudação"><label>Exsudação</label></div>
                                <div class="option-item"><input type="checkbox" name="hidrologia" value="Gotejamento"><label>Gotejamento</label></div>
                                <div class="option-item"><input type="checkbox" name="hidrologia" value="Percolação"><label>Percolação</label></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Zonação (%)</label>
                            <div class="options-group" style="flex-direction: column; gap: 10px; align-items: flex-start;">
                                <div class="option-item"><label for="zonacao_eufotica">Eufótica</label><input type="number" id="zonacao_eufotica" name="zonacao_eufotica" style="width: 80px;"></div>
                                <div class="option-item"><label for="zonacao_disfotica">Disfótica</label><input type="number" id="zonacao_disfotica" name="zonacao_disfotica" style="width: 80px;"></div>
                                <div class="option-item"><label for="zonacao_afotica">Afótica</label><input type="number" id="zonacao_afotica" name="zonacao_afotica" style="width: 80px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tabRecursos" class="tab-content">
                    <div class="form-group" style="margin-top:0;">
                        <button type="button" class="accordion">Recursos encontrados</button>
                        <div class="panel">
                            <div class="options-group" id="recursos-group">
                                <div class="option-item"><input type="checkbox" name="recursos" value="Ausente"><label>Ausente</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Árvore"><label>Árvore</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Arbusto"><label>Arbusto</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Briófita"><label>Briófita</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Broto"><label>Broto</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Carcaça de vertebrado"><label>Carcaça de vertebrado</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Casca de ovo (vert.)"><label>Casca de ovo (vert.)</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Concha de gastrópode"><label>Concha de gastrópode</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Élitro de besouro"><label>Élitro de besouro</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Detrito animal"><label>Detrito animal</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Detrito vegetal"><label>Detrito vegetal</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Egagrópila"><label>Egagrópila</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Fezes"><label>Fezes</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Fungo"><label>Fungo</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Gramínea"><label>Gramínea</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Líquen amarelo"><label>Líquen amarelo</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Líquen branco"><label>Líquen branco</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Líquen vermelho"><label>Líquen vermelho</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Material vegetal"><label>Material vegetal</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Ninho (ave)"><label>Ninho (ave)</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Ossada"><label>Ossada</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Pena"><label>Pena</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Pteridófita"><label>Pteridófita</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Raiz fina"><label>Raiz fina</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Raiz média"><label>Raiz média</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Raiz grossa"><label>Raiz grossa</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Rizotema"><label>Rizotema</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Serapilheira"><label>Serapilheira</label></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="outros_recursos">Outros Recursos (Adicionar):</label>
                            <textarea id="outros_recursos" name="outros_recursos" rows="6" placeholder="Liste outros recursos encontrados, um por linha..."></textarea>
                        </div>
                    </div>
                </div>
                
                <div id="tabGuano" class="tab-content">
                    <div class="form-group" id="guano-grid">
                        <label>Tipos e Estados de Guano:</label>
                        <div class="option-item" style="flex-basis: 100%; margin-bottom: 10px;">
                            <input type="checkbox" name="guano_ausente" id="guano_ausente_checkbox">
                            <label for="guano_ausente_checkbox" style="font-weight: bold; margin-bottom: 0;">Ausente</label>
                        </div>
                        <div class="guano-grid">
                            <div class="guano-header">Tipo de Guano</div>
                            <div class="guano-header">Recente</div>
                            <div class="guano-header">Antigo</div>
                            <div class="guano-header">Exaurido</div>

                            <div class="guano-label">Frugívoros</div>
                            <div class="guano-cell"><input type="checkbox" name="guano_frugivoro_estado" value="recente"></div>
                            <div class="guano-cell"><input type="checkbox" name="guano_frugivoro_estado" value="antigo"></div>
                            <div class="guano-cell"><input type="checkbox" name="guano_frugivoro_estado" value="exaurido"></div>

                            <div class="guano-label">Hematófagos</div>
                            <div class="guano-cell"><input type="checkbox" name="guano_hematofago_estado" value="recente"></div>
                            <div class="guano-cell"><input type="checkbox" name="guano_hematofago_estado" value="antigo"></div>
                            <div class="guano-cell"><input type="checkbox" name="guano_hematofago_estado" value="exaurido"></div>

                            <div class="guano-label">Insetívoros</div>
                            <div class="guano-cell"><input type="checkbox" name="guano_insetivoro_estado" value="recente"></div>
                            <div class="guano-cell"><input type="checkbox" name="guano_insetivoro_estado" value="antigo"></div>
                            <div class="guano-cell"><input type="checkbox" name="guano_insetivoro_estado" value="exaurido"></div>

                            <div class="guano-label">Nectarívoros</div>
                            <div class="guano-cell"><input type="checkbox" name="guano_nectarivoro_estado" value="recente"></div>
                            <div class="guano-cell"><input type="checkbox" name="guano_nectarivoro_estado" value="antigo"></div>
                            <div class="guano-cell"><input type="checkbox" name="guano_nectarivoro_estado" value="exaurido"></div>
                        </div>
                    </div>
                </div>

                <div id="tabTaxons" class="tab-content">
                    <button type="button" class="accordion">Invertebrados</button>
                    <div class="panel">
                        <div id="invertebrados-container"></div>
                        <button type="button" class="add-row-btn" onclick="addInvertebradoRow('invertebrados-container')">+</button>
                    </div>

                    <button type="button" class="accordion">Vertebrados</button>
                    <div class="panel">
                        <div id="vertebrados-container"></div>
                        <button type="button" class="add-row-btn" onclick="addVertebradoRow('vertebrados-container')">+</button>
                    </div>

                    <button type="button" class="accordion">Material Coletado</button>
                    <div class="panel">
                        <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
                            <label for="eppendorf" style="margin-bottom: 0; flex-grow: 1;">Eppendorf</label>
                            <div class="quantity-stepper">
                                <button type="button" onclick="changeQuantity(this, -1)">-</button>
                                <input type="number" id="eppendorf" name="eppendorf" value="0" min="0">
                                <button type="button" onclick="changeQuantity(this, 1)">+</button>
                            </div>
                        </div>
                        <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
                            <label for="falcon" style="margin-bottom: 0; flex-grow: 1;">Falcon</label>
                            <div class="quantity-stepper">
                                <button type="button" onclick="changeQuantity(this, -1)">-</button>
                                <input type="number" id="falcon" name="falcon" value="0" min="0">
                                <button type="button" onclick="changeQuantity(this, 1)">+</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tabAporte" class="tab-content">
                    <div class="form-group">
                        <label class="section-title">Alterações Antrópicas</label>
                        <div class="impact-grid">
                            <div class="grid-header"></div>
                            <div class="grid-header">Ausente</div>
                            <div class="grid-header">Presente</div>
                            
                            <div><b>Pisoteio</b></div>
                            <div><input type="radio" name="pisoteio" value="Ausência"></div>
                            <div><input type="radio" name="pisoteio" value="Presença"></div>
                            
                            <div><b>Lixo</b></div>
                            <div><input type="radio" name="lixo" value="Ausência"></div>
                            <div><input type="radio" name="lixo" value="Presença"></div>
                            
                            <div><b>Poeira</b></div>
                            <div><input type="radio" name="poeira" value="Ausência"></div>
                            <div><input type="radio" name="poeira" value="Presença"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="section-title">Agentes Transportadores</label>
                        <div class="options-group-2-col" id="agentes-transportadores-group">
                            <div class="option-item"><input type="checkbox" name="agentes_transportadores" value="Água"><label>Água</label></div>
                            <div class="option-item"><input type="checkbox" name="agentes_transportadores" value="Gravidade"><label>Gravidade</label></div>
                            <div class="option-item"><input type="checkbox" name="agentes_transportadores" value="Vento"><label>Vento</label></div>
                            <div class="option-item"><input type="checkbox" name="agentes_transportadores" value="Vertebrados"><label>Vertebrados</label></div>
                        </div>
                    </div>
                </div>
                
                <div id="tabObservacoes" class="tab-content">
                    <div class="form-group">
                        <label for="obs_gerais">Observações Gerais</label>
                        <textarea id="obs_gerais" name="obs_gerais" rows="15"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="horario_termino">Horário (término)</label>
                        <input type="time" id="horario_termino" name="horario_termino">
                    </div>
                </div>

                <input type="file" id="photo-input" accept="image/*" capture="camera" multiple style="display:none;">
                <div id="photo-previews"></div>
            </form>
            
            <div class="navigation-arrows">
                <button type="button" id="prevTabBtn">&larr; Voltar</button>
                <button type="button" id="nextTabBtn">Avançar &rarr;</button>
            </div>
        </div>
    </div>
</div>

<button type="button" id="take-photo-btn" class="fab">Fotos</button>
<button type="button" id="exportButton" class="fab">Salvar</button>

<script>
// --- CONTEÚDO DA BIBLIOTECA JSZIP V3.10.1 (EMBUTIDA PARA USO OFFLINE) ---
!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).JSZip=t()}}(function(){return function t(e,r,n){function i(s,a){if(!r[s]){if(!e[s]){var l="function"==typeof require&&require;if(!a&&l)return l(s,!0);if(o)return o(s,!0);var u=new Error("Cannot find module '"+s+"'");throw u.code="MODULE_NOT_FOUND",u}var h=r[s]={exports:{}};e[s][0].call(h.exports,function(t){var r=e[s][1][t];return i(r||t)},h,h.exports,t,e,r,n)}return r[s].exports}for(var o="function"==typeof require&&require,s=0;s<n.length;s++)i(n[s]);return i}({1:[function(t,e,r){"use strict";var n=t("./utils"),i=t("./support"),o=t("./external"),s=t("./stream/Crc32Probe"),a=t("./stream/DataWorker");function l(t,e,r,i,s){this.options=t,this.streamInfo=r,this.bytesWritten=0,this.previous=null,this.data=e,this.check=i,this.transform=s,this.err=null,this.hadError= !1,this.pushed=0,this.ended= !1,this.key=null,this.checksum=null,this.length=0,this.index=0,this.max=0,this.notDestroyed= !0,this.ending= !1,this.removed= !1,this.getRealData=null,this.executeKeys=null}l.prototype={internalNext:function(){var t=this.getRealData();return t.chunks.length?(this.index=0,this.max=t.chunks.length,this.key=t.keys.shift(),this.executeKeys()):(this.ended= !0,null)},next:function(){return this.streamInfo.ended?null:(this.ended||this.err?this.end():this.internalNext())},resume:function(){return this.ended?null:(this.pushed>0&&this.streamInfo.resume(),this.pushed=0,this.err?this.end():this.internalNext())},error:function(t){return this.ended||this.err?(this.ended= !0,this.err=this.err||t,this.end()):(this.err=t,this.streamInfo.error(t),this.internalNext())},end:function(){if(this.ended)return null;this.ended= !0;var t=this.previous;return t&&!t.ended?t.end():(this.streamInfo.end(),null)},flush:function(){for(var t=this.pushed;t>0;t--)this.streamInfo.resume();this.pushed=0},isPaused:function(){return this.streamInfo.paused},pause:function(){return this.streamInfo.pause()},destroy:function(){this.notDestroyed&&(this.end(),this.streamInfo.destroy(),this.data=null,this.previous=null,this.notDestroyed= !1)},p:function(t){this.streamInfo.push(t)},meta:function(t,e){this.streamInfo.meta(t,e)},result:function(t,e){this.streamInfo.result(t,e)},on:function(t,e){this.streamInfo.on(t,e)},executeKeys:function(){if(this.key){for(var t=0;t<this.key.length&&!this.isPaused();t++)this.execute(this.key[t]);return this.key&&this.key.length>t?this:this.internalNext()}return this.internalNext()},execute:function(t){try{this[t]()}catch(t){this.error(t)}return this},checkAndPush:function(t){var e=this;t.on("data",function(t){e.data=t}),this.p(t)},transform:function(){var t=n.getTypeOf(this.transform);if("function"===t){var e=this.transform();this.transform=null,this.checkAndPush(e)}else if("object"===t){var r=this.transform.shift();this.transform.length||(this.transform=null),this.checkAndPush(r)}},checkStream:function(){this.ended= !1,this.pushed=0;var t=n.getTypeOf(this.check);"function"===t?this.check=this.check():"object"===t&&(this.checksum=this.check.shift(),this.check.length||(this.check=null))},check:function(){this.checksum?(this.length=this.data.length,this.checksum.update(this.data),this.checksum.digest(),this.checksum=null):this.length+=this.data.length},read:function(){var t=this.data.length;if(this.index<this.max){var e=this.data.chunks[this.index++];this.streamInfo.push(e)}else this.ended= !0},write:function(){if(this.data){var t=this.data;if(this.transform)this.transform();else if(this.checkStream)this.checkStream();else if(this.check)this.check();else this.read()}else this.error(new Error("no data to write."))},main:function(t){var e=this;this.data=t,this.index=0,this.max=1,this.getRealData=function(){return{chunks:[e.data],keys:["write"]}},this.resume()},pipe:function(t){var e=new a(this.options);return e.on("data",function(e){t.write(e)}),e.on("end",function(){t.end()}),e.on("error",function(e){t.error(e)}),this.on("data",function(t){e.write(t)}),this.on("end",function(){e.end()}),this.on("error",function(t){e.error(t)}),this},cleanUp:function(){this.previous=null,this.data=null,this.transform=null,this.check=null,this.checksum=null,this.key=null,this.getRealData=null,this.executeKeys=null,this.ended= !1,this.pushed=0,this.err=null,this.hadError= !1},load:function(){this.data=o.Promise.resolve(this.data).then(function(t){return n.prepareContent("data",t,{meta:{date:new Date,level:this.options.level|| -1,compression:this.options.compression||"NONE"},check:!0,binary:!0})}.bind(this)),this.getRealData=function(){return{chunks:[],keys:["main"]}},this.resume()},run:function(){if(this.isPaused()&&!this.ended)return this;if(this.ended)return void this.end();this.ended||this.err?this.end():this.internalNext()}},e.exports=function(t,e,r){var i=t,a=r;return"string"==typeof t&&(i=n.string2binary(t)),"undefined"==typeof r&&(a=new s),new l(e,{chunks:n.chunk(i,e.chunkSize),keys:["write"]},a)}}]},function(t,e,r){"use strict";function n(){}e.exports=n},{}],3:[function(t,e,r){(r.isNode=void 0!==Object.prototype.toString.call(global.process),r.isStream=function(t){return"object"==typeof t&&"function"==typeof t.on&&"function"==typeof t.pause&&"function"==typeof t.resume}).Readable=t("stream").Readable},{}],4:[function(t,e,r){"use strict";var n=t("readable-stream").Readable;function i(t){n.call(this,t)}t("../utils").inherits(i,n),i.prototype._read=function(){},e.exports=i},{"../utils":18,"readable-stream":13}],5:[function(t,e,r){"use strict";var n=t("./nodebuffer");e.exports=function(t,e){var r=t.internal,i=t.external;t=new t.FlateStream(e,i.DEFLATE),r.on("data",function(e){t.push(e, !1)}),r.on("end",function(){t.push(null, !0)}),t.on("data",function(t){i.push(t)}),t.on("end",function(){i.end()}),t.on("error",function(t){i.error(t)}),i.on("drain",function(){r.resume()}),r.on("end",function(){n.newBuffer(0)})}},{"./nodebuffer":10}],6:[function(t,e,r){"use strict";e.exports=function(t,e){var r,n=t.internal,i=t.external,o=(t=new t.FlateStream(e,i.INFLATE),n.on("data",function(e){t.push(e, !1)}),n.on("end",function(){t.push(null, !0)}),t.on("data",function(t){i.push(t)}),t.on("end",function(){i.end()}),t.on("error",function(t){i.error(t)}),i.on("drain",function(){n.resume()}),function(t,e){r=t,i.checksum=e,n.resume()});if(i.on("data",function(t){i.checksum.update(t)}),i.INFLATE){if(i.header)i.header.then(o);else o()}else n.resume()}},{}],7:[function(t,e,r){"use strict";var n=t("../utils"),i=t("../stream/GenericWorker"),o=t("../utf8"),s=t("../zipEntries"),a=t("../stream/Crc32Probe"),l=t("../nodejsUtils");function u(t,e,r,s){i.call(this,this.options=n.extend(e||{},{base64: !1,checkCRC32: !1,optimizedBinaryString: !1,createFolders: !1,decodeFileName:o.utf8decode})),this.files=s||[],this.loadOptions=t,this.comment=r,this.cpuNum=navigator.hardwareConcurrency||1,this.unzippedFiles={},this.remaining=this.files.length}n.inherits(u,i),u.prototype.check=function(){this.remaining||this.result(this.unzippedFiles)},u.prototype.prepareFile=function(t){var e=this;return n.prepareContent("check",t,{meta:{date:t.date,dir:t.dir,isFile:t.isFile,comment:t.comment,unixPermissions:t.unixPermissions,dosPermissions:t.dosPermissions},check: !0,binary: !0}).then(function(){var r,n=t.decompressed;t.options.checkCRC32&&t.crc32!==n.meta.crc32&&(r=new Error("Corrupted zip : CRC32 mismatch"),r.metadata={expected:t.crc32,actual:n.meta.crc32},e.error(r)),t.uncompressedSize===n.length||t.dir||(r=new Error("Corrupted zip : uncompressed size mismatch"),r.metadata={expected:t.uncompressedSize,actual:n.length},e.error(r))})},u.prototype.unzipFile=function(t){var e=this,r=this.options;return r.base64?n.prepareContent("base64",t,{check: !0,binary: !0}):n.prepareContent(r.optimizedBinaryString?"uint8array":"string",t,{check: !0,binary: !0}).then(function(t){return e.options.decodeFileName(t)})},u.prototype.remove=function(){this.files=null,this.loadOptions=null,this.comment=null,this.cpuNum=1,this.unzippedFiles=null,this.remaining=0},u.prototype.read=function(){var t=this.files.shift();t?this.handle(t):this.check()},u.prototype.handle=function(t){var e=this,r=this.options.createFolders,i=this.options.decodeFileName;t.dir&&r&&(t.fileName=t.fileName.slice(0,-1)),this.unzippedFiles[t.fileName]={dir:t.dir,date:t.date,comment:t.comment,unixPermissions:t.unixPermissions,dosPermissions:t.dosPermissions,unsafeOriginalName:i(t.fileNameBytes),_data:t.decompressed,asBinary:function(){return this._data.asBinary()},asString:function(){return this._data.asString()},asNodeBuffer:function(){return this._data.asNodeBuffer()},asUint8Array:function(){return this._data.asUint8Array()},asArrayBuffer:function(){return this._data.asArrayBuffer()}},t.dir||this.prepareFile(t).then(function(){e.remaining--,e.check(),e.read()})},e.exports=function(){if("undefined"==typeof Promise)throw new Error("JSZip requires a library for promises, see https://stuk.github.io/jszip/documentation/howto/promises.html");if(!l.isNode&&"undefined"==typeof window)throw new Error("For the decompressing files, JSZip requires a window object.");var t=Array.prototype.slice.call(arguments);return s.load.apply(s,t).then(function(e){var r=e.options,n=e.files,i=e.comment;return r.checkCRC32= !0,new u(r,r,i,n).run(),e})}},{"../nodejsUtils":8,"../stream/Crc32Probe":11,"../stream/GenericWorker":12,"../utf8":16,"../utils":18,"../zipEntries":22}],8:[function(t,e,r){"use strict";e.exports={isNode:void 0!==global.process&&"[object process]"===Object.prototype.toString.call(global.process),isStream:function(t){return"object"==typeof t&&"function"==typeof t.on&&"function"==typeof t.pause&&"function"==typeof t.resume}}},{}],9:[function(t,e,r){"use strict";var n=t("./utils"),i=t("./stream/GenericWorker"),o=(t("./utf8"),t("../compressions"),t("./zipEntries"),function(t){i.call(this,{}),this.files=t.files,this.createdFiles=0,this.options=t.options,this.stream=t.stream,this.comment=t.comment,this.compression=t.compression,this.compressionOptions=t.compressionOptions,this.level=t.level,this.dir=t.dir,this.date=t.date,this.generated=0});n.inherits(o,i),o.prototype.remove=function(){this.files=null,this.createdFiles=0,this.options=null,this.stream=null,this.comment=null,this.compression=null,this.compressionOptions=null,this.level=0,this.dir= !1,this.date=null,this.generated=0},o.prototype.read=function(){var t=this.files.shift();t?(this.handle(t),this.read()):this.end()},o.prototype.end=function(){this.stream.end()},o.prototype.handle=function(t){var e=this;n.prepareContent(t,{base64:this.options.base64,binary:this.options.binary,dir:t.dir,date:t.date,compression:t.compression||this.compression,level:t.level||this.level}).then(function(r){var n=0;e.stream.on("data",function(t){n+=t.length,e.generated+=t.length,e.p(t),e.meta("progression",{percent:e.createdFiles/e.files.length,currentFile:r})}),t.compressedSize=n,t.uncompressedSize=r.length,t.crc32=r.meta.crc32,e.createdFiles++,e.stream.file(t)})},e.exports=o},{"../compressions":20,"../utf8":16,"./stream/GenericWorker":12,"./utils":18,"./zipEntries":22}],10:[function(t,e,r){"use strict";var n=t("./utils"),i=t("./support"),o="undefined"!=typeof Buffer;function s(t){return o?Buffer.from(t,"utf8"):n.string2binary(t)}r.newBuffer=function(t,e){if(o)return e?Buffer.from(t,e):Buffer.from(t);var r=new Uint8Array(t.length);return n.arraycopy(t,r,0,t.length,0),r},r.prepareContent=function(t,e,a,l,u){return n.Promise.resolve(e).then(function(e){var h=i.isBuffer(e);return h||"string"!=typeof e||(!0!==a||u?h= !0:(e=s(e),l= !0)),e.length&&l?r.newBuffer(e):e})},r.string2binary=s},{"./support":15,"./utils":18}],11:[function(t,e,r){"use strict";var n=t("../utils"),i=t("./GenericWorker");function o(){i.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}n.inherits(o,i),o.prototype.processChunk=function(t){this.streamInfo.crc32=this.transform(this.streamInfo.crc32,t.data),this.forward(t)},e.exports=o},{"../utils":18,"./GenericWorker":12}],12:[function(t,e,r){"use strict";var n=t("../utils"),i=t("../support");function o(t){this.name=t||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused= !0,this.isFinished= !1,this.isLocked= !1,this._listeners={data:[],end:[],error:[]},this.previous=null}o.prototype={push:function(t){this.emit("data",t)},end:function(){if(this.isFinished)return !1;this.flush(),this.isFinished= !0;for(var t=0;t<this._listeners.end.length;t++)this._listeners.end[t]();return !0},error:function(t){return !this.isFinished&&(this.isFinished= !0,this.generatedError=t,this.emit("error",t), !0)},on:function(t,e){return this._listeners[t].push(e),this},cleanUp:function(){this.extraStreamInfo={},this.generatedError=null,this._listeners=[],this.previous=null},emit:function(t,e){if(this._listeners[t])for(var r=0;r<this._listeners[t].length;r++)this._listeners[t][r](e)},pipe:function(t){var e=this;return t.on("data",function(t){e.push(t)}).on("end",function(){e.end()}).on("error",function(t){e.error(t)}),t},withStreamInfo:function(t,e){return this.extraStreamInfo[t]=e,this},displace:function(t){for(var e=t;e;){e.streamInfo=this.streamInfo,e=e.previous}return t},lock:function(){if(this.isLocked)throw new Error("Already locked");this.isLocked= !0},unlock:function(){this.isLocked= !1},resume:function(){if(!this.isPaused)return !1;this.isPaused= !1;var t=this.previous;return t?t.resume(): !0},pause:function(){return !!this.isPaused||(this.isPaused= !0,this.previous&&this.previous.pause(), !0)},forward:function(t){this.push({data:t.data,meta:t.meta})},flush:function(){for(var t in this.extraStreamInfo)this.extraStreamInfo.hasOwnProperty(t)&&(this.streamInfo[t]=this.extraStreamInfo[t])},run:function(){var t=this,e=this.name,r=Array.prototype.slice.call(arguments,1);i.Promise.all(r).then(function(r){t.isPaused= !1;try{var i=t.processChunk.bind(t);r[0].chunks.reduce(function(t,e){return t.then(function(){return i({data:e,meta:{percent:100*(t/r[0].chunks.length)}})})})}catch(t){t.message="An error occured while running '"+e+"'",t.stack=t.stack||"",t.stack=t.stack.replace(t.message,t.message+"\nCaused by: "+t.stack),t.error(t)}t.end()}).catch(function(e){t.error(e)})},processChunk:function(){throw new Error("processChunk not implemented.")}},e.exports=o},{"../support":15,"../utils":18}],13:[function(t,e,r){e.exports=t("stream")},{}],14:[function(t,e,r){"use strict";var n=t("./flate"),i=t("./utils");e.exports=function(t,e){t.compression=e.compression,t.compressionOptions=e.compressionOptions;var r=this,o=r.internal,s="string"==typeof t.compression?t.compression.toUpperCase():t.compression;r.on("end",function(){o.end()});var a,l;switch(s){case"DEFLATE":a=new n.Deflate(t,t.compressionOptions),l=new n.Inflater(t,t.compressionOptions);break;case"INFLATE":a=new n.Inflater(t,t.compressionOptions),l=new n.Deflate(t,t.compressionOptions);break;default:throw new Error(s+" is not a valid compression method !")}o.on("data",function(t){a.write(t)}),a.on("data",function(t){r.push(t)}),a.on("end",function(){r.end()}),a.on("error",function(t){r.error(t)}),r.on("data",function(t){l.write(t)}),l.on("data",function(t){o.push(t)}),l.on("end",function(){o.end()}),l.on("error",function(t){o.error(t)})}},{"./flate":21,"./utils":18}],15:[function(t,e,r){"use strict";var n="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array;r.hasTypedArray=function(){return n};try{r.isBuffer=void 0!==Buffer.from(new Uint8Array(2)).toString("utf-8")}catch(t){r.isBuffer= !1}r.STORE={magic:"\0\0",compress:function(t,e){return t},uncompress:function(t,e){return t},compressInputType:"string",uncompressInputType:"string"},r.DEFLATE={magic:"\b\0"},r.INFLATE={},r.magic={STORE:"\0\0",DEFLATE:"\b\0"},r.Promise=t("lie")},{"lie":24}],16:[function(t,e,r){"use strict";for(var n=t("./utils"),i=new Array(256),o=0;o<256;o++)i[o]=o>=252?6:o>=248?5:o>=240?4:o>=224?3:o>=192?2:1;i[254]=i[254]=1;var s=function(t){var e,r,n,i,o,s=t.length,a=0;for(o=0;o<s;o++)55296===(64512&(r=t.charCodeAt(o)))&&o+1<s&&56320===(64512&(n=t.charCodeAt(o+1)))?(r=65536+((1023&r)<<10)+(1023&n),o++):r,e=r,i=n=0,128>e?n=1:2048>e?n=2:65536>e?n=3:2097152>e?n=4:67108864>e&&(n=5),a+=n;return a},a=function(t,e,r){var n=t.length;r=r||0;var i,o,s,a,l,u=0,h=0;for(o=0;o<n;o++)55296===(64512&(o=t.charCodeAt(o)))&&o+1<n&&56320===(64512&(s=t.charCodeAt(o+1)))?(o=65536+((1023&o)<<10)+(1023&s),o++):o,i=o,a=0,128>i?a=1:2048>i?a=2:65536>i?a=3:2097152>i&&(a=4),h+a>r-u?u=h=0:h+=a,u>r-a?o--:(u+=a,l=o,128>l?e[u++]=l:2048>l?(e[u++]=192|l>>6,e[u++]=128|63&l):65536>l?(e[u++]=224|l>>12,e[u++]=128|l>>6&63,e[u++]=128|63&l):2097152>l&&(e[u++]=240|l>>18,e[u++]=128|l>>12&63,e[u++]=128|l>>6&63,e[u++]=128|63&l));return u},l=function(t){return a(t,new n.Buf(s(t)))},u=function(t,e){var r="";for(e=e||t.length,e=Math.min(e,t.length);e>0&&t[--e]>127;);if(e>0){var n=new Uint8Array(t.buffer,t.byteOffset,e);r=String.fromCharCode.apply(String,n)}if(e===t.length)return r;var o=function(t){var e,r,n,o,s,a,l,u,h=t.length,c=new Array(2*h);for(r=n=0;r<h;){if((e=t[r++])<128)c[n++]=e;else if((o=i[e])>4)c[n++]=65533,r+=o-1;else{for(e&=2==o?31:3==o?15:7,s=1;s<o;s++)e=e<<6|63&t[r++];4==o?(s=e-65536,c[n++]=55296|(s>>10),c[n++]=56320|(1023&s)):c[n++]=e}}return c};return r+o(t.subarray(e))};r.utf8encode=l,r.utf8decode=u},{"./utils":18}],17:[function(t,e,r){"use strict";var n=t("./utils"),i=t("./support"),o=t("./nodejsUtils"),s=t("./stream/GenericWorker");function a(t){s.call(this,"ZipFileStream"),this.path=t,this.options=void 0,this.result=void 0,this.rest=void 0}n.inherits(a,s),a.prototype.internalEnd=function(){return n.Promise.resolve({path:this.path,options:this.options,result:this.result})},a.prototype.file=function(t,e,r){if(this.isLocked)throw new Error("This stream is already locked for writing.");var s=n.extend(r||{},this.options);this.options=s,s.comment=t.comment||s.comment||this.comment||"",s.date=t.date||s.date||this.date||new Date,s.compression=t.compression||s.compression||this.compression||"STORE",s.compressionOptions=t.compressionOptions||s.compressionOptions||this.compressionOptions||{},s.level=s.level||this.level|| -1,this.lock();var a=this,l=n.isStream(e);return l&&o.isNode?e.pipe(this):l?this.error(new Error("ZipFileStream is not compatible with streams in a browser environment.")):(this.result=e,void this.end())},e.exports=function(t,e){var r=new a(t,e);return r.options=e,r}},{"./nodejsUtils":8,"./stream/GenericWorker":12,"./utils":18}],18:[function(t,e,r){"use strict";var n=t("./support"),i=t("./base64"),o="undefined"!=typeof Uint8Array,s="undefined"!=typeof ReadableStream;r.inherits=function(t,e){function r(){this.constructor=t}r.prototype=e.prototype,t.prototype=new r},r.extend=function(){var t,e={};for(t=0;t<arguments.length;t++)for(var r in arguments[t])arguments[t].hasOwnProperty(r)&&"undefined"==typeof e[r]&&(e[r]=arguments[t][r]);return e},r.prepareContent=function(t,e,a){var l=r.getTypeOf(e),u=r.extend(a||{},n);return u.binary?n.Promise.resolve(e):"string"===l?u.optimizedBinaryString&&n.isBuffer(e)?n.Promise.resolve(e.toString("binary")):n.Promise.resolve(u.base64?i.decode(e):r.string2binary(e)):o&&("uint8array"===l||"arraybuffer"===l||"blob"===l||"file"===l)?n.Promise.resolve(e):s&&e instanceof ReadableStream?n.Promise.resolve(e):n.Promise.reject("Unexpected error in prepareContent, file format not supported.")},r.getTypeOf=function(t){return"string"==typeof t?"string":t instanceof String?"string":"[object ArrayBuffer]"===Object.prototype.toString.call(t)?"arraybuffer":o&&t instanceof Uint8Array?"uint8array":o&&t instanceof Uint16Array?"uint16array":o&&t instanceof Uint32Array?"uint32array":t instanceof Blob?"blob":t instanceof File?"file":s&&t instanceof ReadableStream?"readable-stream":"object"},r.chunk=function(t,e){var n=t.slice(0);t.length=0;for(var i=Math.floor(n.length/e),o=n.length%e,s=0;s<i;s++)t.push(n.slice(s*e,(s+1)*e));return o&&t.push(n.slice(i*e)),t},r.arraycopy=function(t,e,r,n,i){for(var o=0;o<n;o++)e[i+o]=t[r+o]},r.alloc=function(t){if(o)return new Uint8Array(t);var e=new Array(t);for(var r=0;r<t;r++)e[r]=0;return e};var a=r.Buf=o?Uint8Array:Array;r.string2binary=function(t){var e,r,n=t.length,i=r.alloc(n);for(e=0;e<n;e++)r=t.charCodeAt(e),i[e]=255&r;return i}},{"./base64":19,"./nodejsUtils":8,"./support":15}],19:[function(t,e,r){"use strict";var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";r.encode=function(t){for(var e,r,i,o,s,a,l,u=[],h=0,c=t.length,f=c-c%3;h<f;h+=3)i=t[h],o=t[h+1],s=t[h+2],u.push(n.charAt(i>>2)),u.push(n.charAt((3&i)<<4|o>>4)),u.push(n.charAt((15&o)<<2|s>>6)),u.push(n.charAt(63&s));return c%3==1?(i=t[h],u.push(n.charAt(i>>2)),u.push(n.charAt((3&i)<<4)),u.push("==")):c%3==2&&(i=t[h],o=t[h+1],u.push(n.charAt(i>>2)),u.push(n.charAt((3&i)<<4|o>>4)),u.push(n.charAt((15&o)<<2)),u.push("=")),u.join("")},r.decode=function(t){var e,r,i,o,s,a,l=t.length,u=0,h=[];t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");for(var c=0;c<l;c++)a=n.indexOf(t.charAt(c++)),e=n.indexOf(t.charAt(c++)),s=n.indexOf(t.charAt(c++)),o=n.indexOf(t.charAt(c++)),r=(a<<2|e>>4)&255,i=(15&e)<<4|(s>>2)&255,o=(3&s)<<6|o&255,h[u++]=r,64!==s&&(h[u++]=i),64!==o&&(h[u++]=o);return h}},{}],20:[function(t,e,r){"use strict";var n={};e.exports=n},{}],21:[function(t,e,r){"use strict";var n=e.exports={};n.STORE=t("./store"),n.DEFLATE=t("./deflate")},{"./deflate":5,"./store":14}],22:[function(t,e,r){"use strict";var n=t("./stream/GenericWorker"),i=t("./utf8"),o=t("./utils"),s=t("./nodejsUtils"),a=t("./zipEntry"),l=t("./support"),u=function(t,e){this.reader=t,this.loadOptions=e};u.prototype={checkSignature:function(t){var e=this.reader.readString(4);if(e!==t)throw new Error("Corrupted zip or bug: unexpected signature ("+o.pretty(e)+", expected "+o.pretty(t)+")")},isEncrypted:function(){return 1==(1&this.reader.readInt(2))},readGeneralPurposeBitFlag:function(){return this.reader.readInt(2)},readLocalFileHeader:function(){var t={};return this.checkSignature("PK"),t.version=this.reader.readInt(2),t.generalPurposeBitFlag=this.readGeneralPurposeBitFlag(),t.compressionMethod=this.reader.readString(2),t.lastModFileTime=this.reader.readInt(4),t.crc32=this.reader.readInt(4),t.compressedSize=this.reader.readInt(4),t.uncompressedSize=this.reader.readInt(4),t.fileNameLength=this.reader.readInt(2),t.extraFileLength=this.reader.readInt(2),t},readData:function(t){var e=t.fileNameLength,r=this.reader.readData(t.compressedSize);return new a(t,{fileName:i.utf8decode(this.reader.readData(e)),extraFields:this.reader.readData(t.extraFileLength),comment:this.reader.readString(t.commentLength)},r)},readFile:function(){var t=this.readLocalFileHeader();return this.readData(t)},readCentralDir:function(){var t={};return this.checkSignature("PK"),t.versionMadeBy=this.reader.readInt(2),t.versionNeeded=this.reader.readInt(2),t.generalPurposeBitFlag=this.readGeneralPurposeBitFlag(),t.compressionMethod=this.reader.readString(2),t.lastModFileTime=this.reader.readInt(4),t.crc32=this.reader.readInt(4),t.compressedSize=this.reader.readInt(4),t.uncompressedSize=this.reader.readInt(4),t.fileNameLength=this.reader.readInt(2),t.extraFileLength=this.reader.readInt(2),t.fileCommentLength=this.reader.readInt(2),t.diskNumberStart=this.reader.readInt(2),t.internalFileAttributes=this.reader.readInt(2),t.externalFileAttributes=this.reader.readInt(4),t.localHeaderOffset=this.reader.readInt(4),t},readCentralDirFileHeader:function(){var t=this.readCentralDir();return this.readData(t)},readEndOfCentral:function(){var t={};return this.checkSignature("PK"),t.diskNumber=this.reader.readInt(2),t.diskWithCentralDirStart=this.reader.readInt(2),t.centralDirRecordsOnDisk=this.reader.readInt(2),t.centralDirRecords=this.reader.readInt(2),t.centralDirSize=this.reader.readInt(4),t.centralDirOffset=this.reader.readInt(4),t.zipCommentLength=this.reader.readInt(2),t.zipComment=i.utf8decode(this.reader.readData(t.zipCommentLength)),t},prepareReader:function(t){this.reader.load(t)},load:function(){var t=this;return this.prepareReader(),l.Promise.resolve().then(function(){for(var e=t.readEndOfCentral(),r=new Array(e.centralDirRecords),n=e.centralDirOffset,i=0;i<e.centralDirRecords;i++)t.reader.setIndex(n),r[i]=t.readCentralDirFileHeader(),n=t.reader.getIndex();return t.reader=null,{files:r,comment:e.zipComment}})}},e.exports=u},{"./nodejsUtils":8,"./stream/GenericWorker":12,"./support":15,"./utf8":16,"./utils":18,"./zipEntry":23}],23:[function(t,e,r){"use strict";var n=t("./reader/DataReader"),i=t("./utils"),o=t("./compressions"),s=t("./support"),a=function(t,e,r){this.options=t,this.loadOptions=e,this.data=r,this.length=r.length,this.name=t.fileName,this.comment=t.comment,this.date=new Date(t.lastModFileTime),this.dir=this.name.slice(-1),this.version=t.version,this.versionNeeded=t.versionNeeded,this.compression=o[t.compressionMethod],this.crc32=t.crc32,this.compressedSize=t.compressedSize,this.uncompressedSize=t.uncompressedSize,this.unixPermissions=t.unixPermissions,this.dosPermissions=this.dosPermissions,this.extraFields=t.extraFields,this.internalFileAttributes=t.internalFileAttributes,this.externalFileAttributes=t.externalFileAttributes,this.isEncrypted=t.isEncrypted,this.decompressed=null,this.data=new n(r),this.compression=this.compression,this.uncompressedSize>0&&this.compression!==s.STORE?this.decompressed=i.prepareContent("compressed",this.data,{check: !0,binary: !0,optimizedBinaryString: !0}):this.decompressed=i.prepareContent("uncompressed",this.data,{check: !0,binary: !0,optimizedBinaryString: !0})};a.prototype.getContent=function(){return this.decompressed.getContent()},a.prototype.asNodeBuffer=function(){return this.getContent("nodebuffer")},a.prototype.asArrayBuffer=function(){return this.getContent("arraybuffer")},a.prototype.asUint8Array=function(){return this.getContent("uint8array")},e.exports=a},{"./compressions":20,"./reader/DataReader":27,"./support":15,"./utils":18}],24:[function(t,e,r){"use strict";var n=t("./lib");e.exports=n.Promise,n.poly()},{"./lib":25}],25:[function(t,e,r){"use strict";var n=t("./core.js"),i=t("./queue.js");e.exports=n,n.prototype.then=function(t,e){var r=this;return new n(function(n,o){i(function(){r.onFulfilled(t,n,o),r.onRejected(e,n,o)})})},n.prototype.catch=function(t){return this.then(null,t)},n.poly=function(){"undefined"==typeof Promise&&"undefined"!=typeof window&&(window.Promise=n)}},{"./core.js":26,"./queue.js":28}],26:[function(t,e,r){"use strict";var n=0,i=1,o=2;function s(t){this.state=o,this.value=void 0,this.deferred=[],this.catchers=[],t&&l(this,t)}function a(t){var e=new s;try{t(function(t){e.resolve(t)},e.reject)}catch(t){e.reject(t)}return e}function l(t,e){t.state=i,t.update=e,t.call()}s.prototype={onFulfilled:function(t){this.state===n&&this.deferred.push(t)},onRejected:function(t){this.state===n&&this.catchers.push(t)},resolve:function(t){if(this.state===n){this.state=i;try{this.update(t,this.resolve,this.reject)}catch(t){return this.reject(t)}}this.value=t,this.call()},reject:function(t){this.state===n&&(this.state=i,this.value=t,this.call())},call:function(){for(var t=0;t<this.deferred.length;t++)u(this,this.deferred[t]);for(t=0;t<this.catchers.length;t++)h(this,this.catchers[t]);this.deferred=void 0,this.catchers=void 0}},e.exports=s,e.exports.Promise=a;var u=function(t,e){e(t.value)},h=function(t,e){e(t.value)}},{}],27:[function(t,e,r){"use strict";var n=t("../utils");function i(t){this.data=t,this.length=t.length,this.index=0,this.zero=0}i.prototype={checkOffset:function(t){this.checkIndex(this.index+t)},checkIndex:function(t){if(this.length<this.zero+t||t<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+t+").")},setIndex:function(t){this.checkIndex(t),this.index=t},skip:function(t){this.setIndex(this.index+t)},byteAt:function(t){return this.data[this.index+t]},readInt:function(t){var e,r=0;for(this.checkOffset(t),e=this.index+t-1;e>=this.index;e--)r=(r<<8)+this.byteAt(e);return this.index+=t,r},readString:function(t){return n.uint8Array2String(this.readData(t))},readData:function(t){this.checkOffset(t);var e=this.data.subarray(this.index,this.index+t);return this.index+=t,e},lastIndexOfSignature:function(t){for(var e=this.index;e>=0;e--)if(this.byteAt(e)===t.charCodeAt(0)&&this.readString(4)===t)return e;return-1},readAndCheckSignature:function(t){var e=this.readString(4);if(e!==t)throw new Error("Corrupted zip or bug: unexpected signature ("+n.pretty(e)+", expected "+n.pretty(t)+")")},readDate:function(){var t=this.readInt(4);return new Date(Date.UTC(1980+(t>>25&127), (t>>21&15)-1, t>>16&31, t>>11&31, t>>5&63, (31&t)<<1))}},e.exports=i},{"../utils":18}],28:[function(t,e,r){"use strict";var n,i=[];function o(){for(var t=0;t<i.length;t++)i[t]();i=[]}function s(t){i.push(t),1===i.length&&n()}e.exports=function(t){"function"==typeof setImmediate?n=function(){setImmediate(o)}:"object"==typeof process&&process.nextTick?n=function(){process.nextTick(o)}:n=function(){setTimeout(o,0)},e.exports(t)}}]});
// --- CONTEÚDO DA BIBLIOTECA PROJ4JS V2.11.0 (EMBUTIDA PARA USO OFFLINE) ---
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).proj4={})}(this,function(t){"use strict";function e(t,e){return t(e={exports:{}},e.exports),e.exports}function r(t){return t&&t.Math==Math&&t}var n=r("object"==typeof globalThis&&globalThis)||r("object"==typeof window&&window)||r("object"==typeof self&&self)||r("object"==typeof global&&global)||Function("return this")();var i=n.navigator,o=i&&i.userAgent||"",s=o.slice(0,o.indexOf("AppleWebKit"));const a="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node;var u={}.toString,c=function(t){return u.call(t).slice(8,-1)},l=c(n.process),h="process"==l;var f=function(t){try{return!!t()}catch(t){return!0}},p=f(function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]}),m=f(function(){return Object.defineProperty}),d={};function g(t,e){if(!y(t))return t;var r,n;if(e&&"function"==(r=t.toString)&&!y(n=r.call(t)))return n;if("function"==(r=t.valueOf)&&!y(n=r.call(t)))return n;if(!e&&"function"==(r=t.toString)&&!y(n=r.call(t)))return n;throw TypeError("Can't convert object to primitive value")}var v=d,y=function(t){return"object"==typeof t?null!==t:"function"==typeof t},b=function(t,e){if(!y(t))throw TypeError(String(e)+" is not an object");return t},E={}.hasOwnProperty,S=function(t,e){return E.call(t,e)},_=n.document,w=y(_),x=w&&y(_.createElement),T=function(t){return w?_.createElement(t):{}},C=T("span"). येत नाही?"!=String(T(" हम भी तुमको चाहते हैं")):!f(function(){var t=T("div");t.innerHTML="<script><\/script>",t.removeChild(t.firstChild)}),O=T("div"),A=function(t){if("string"!=typeof t||t.length>512)return!1;var e,r,n=0;for(e=0;e<t.length;e++){if(r=t.charCodeAt(e),e==t.length-1&&55296<=r&&r<=56319)return!1;55296<=r&&r<=57343&&n++;56320<=r&&r<=57343&&n--}return n<=0};function j(t,e){O.innerHTML=t,C&&A(t)&&(O.innerHTML="");var r=O.childNodes;return 1==r.length?r[0]:e?r:Array.prototype.slice.call(r)}var P=!p&&!f(function(){return 7!=Object.defineProperty(T("div"),"a",{get:function(){return 7}}).a}),I=Object.defineProperty;d.f=p?I:function(t,e,r){if(b(t),e=function(t,e){return g(t,e)}(e,!0),b(r),P)try{return I(t,e,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported");return"value"in r&&(t[e]=r.value),t};var L=function(t,e,r){return d.f(t,e,r)};var R=p?function(t,e,r){return v.f(t,e,{configurable:!0,enumerable:!1,writable:!0,value:r})}:function(t,e,r){return t[e]=r,t};var k=function(t,e){try{R(n,t,e)}catch(r){n[t]=e}return e},M=e(function(t){var e="__core-js_shared__",r=n[e]||k(e,{});t.exports=r}),F=M,N=0,B=Math.random(),z=function(t){return"Symbol("+String(void 0===t?"":t)+")_"+(++N+B).toString(36)};var U=function(t){return Object(function(t){if(null==t)throw TypeError("Can't call method on "+t);return t}(t))},D=function(t){return"function"==typeof t};var H=F("wks"),G=n.Symbol,W=D(G),V=W&&!!G.sham,K=n.WeakMap,q=D(K)&&/native code/.test(String(K));var $=M("keys"),X=function(t){return $[t]||($[t]=z(t))},Y=X(" mùi"),J=D(n.WeakMap)?n.WeakMap:function(){function t(){this.
- entries=[],this.keys=[]}return t.prototype.set=function(t,e){return this.keys.push(t),this.entries.push(e),e},t.prototype.get=function(t){var e=this.keys.indexOf(t);return e<0?void 0:this.entries[e]},t}(),Z=new J;var tt=function(t,e){for(var r,n=Z.keys.indexOf(t);n>-1;)r=Z.entries[n],Z.keys.splice(n,1),Z.entries.splice(n,1),n=Z.keys.indexOf(t);return Z.set(t,e)},et=F("keys"),rt=function(t){return et[t]||(et[t]=z(t))};function nt(){}var it=rt("IE_PROTO"),ot=function(){var t,e=T("iframe");return e.style.display="none",
- function(t,e){_[e]&&t.appendChild(_[e]),e.innerHTML="",t.appendChild(e)}(n.documentElement),e.src=String("javascript:"),t=e.contentWindow.document,t.open(),t.write("<script>document.F=Object<\/script>"),t.close(),t.F},st=Object.prototype,at=Object.create||function(){var t=ot();return function(e){var r;return null!==e?(nt.prototype=b(e),r=new nt,nt.prototype=null,r[it]=e):r=t(),r}}();S(st,it)||(st[it]=at(null));var ut="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(","),ct=Object.keys||function(t){return function(t,e){b(t);var r,n=[],i=0;for(r in t)S(t,r)&&n.push(r);for(;e.length>i;)for(r in t)if(S(t,r)&&!
- n.includes(r)){n.push(r);break}return n}(t,ut)};var lt=ct;var ft=p?Object.defineProperties:function(t,e){b(t);for(var r,n=lt(e),i=n.length,o=0;i>o;)v.f(t,r=n[o++],e[r]);return t};var pt={f:Object.getOwnPropertySymbols};var mt=n,dt=pt,gt=Object.assign,vt=Object.defineProperty;!gt||f(function(){if(p&&1!==gt({b:1},gt(vt({},"a",{enumerable:!0,get:function(){vt(this,"b",{value:3,enumerable:!1})}}),{b:2})).b)return!0;var t={},e={},r=Symbol();t[r]=7,gt(e,t),"[object Arguments]"==c(arguments)&&(gt({1:"a",2:"b"},arguments),
- !1)})?function(t,e){for(var r=U(t),n=arguments.length,i=1,o=dt.f,s=Object.prototype.propertyIsEnumerable;n>i;){for(var a,l=arguments[i++],u=o?lt(l).concat(o(l)):lt(l),c=u.length,h=0;c>h;)a=u[h++],p&&!s.call(l,a)||S(r,a)&&(r[a]=l[a])}return r}:gt;var yt=n.Promise,bt=D(yt);var Et=H("species"),St=function(t,e){var r,n=b(t).constructor;return void 0===n||null==(r=b(n)[Et])?e:function(t){if(D(t))return t;throw TypeError(t+" is not a constructor")}(r)},_t=H("iterator"),wt=Array.prototype,xt=function(t){var e=U(t),r=e[_t]||e["@@iterator"]||v[c(e)];return b(r).call(e)};var Tt=n.TypeError;var Ct,Ot,At,jt=n.process,Pt=jt&&jt.versions,It=Pt&&Pt.v8;It?At=(Ot=(Ct=It.split("."))[0]+Ot[1]).slice(0,4):o&&(Ct=o.match(/Edge\/(\d+)/))&&(!Ct||Ct[1]>=74)&&(Ct=o.match(/Chrome\/(\d+)/))&&(Ot=Ct[1]);var Lt=Ot&&+Ot;var Rt=H("species"),kt=function(t){return Lt>=51||!f(function(){var e=[],r=(e.constructor={})[Rt]=function(){return{foo:1}};return 1!=(e.concat(r))[0].foo})},Mt=function(t){if(t>9007199254740991)throw Tt("Maximum allowed index exceeded");return t};var Ft=Array.isArray,Nt=function(t){return Ft(t)?t:function(t){return function(t){return"Array Iterator"==c(t)}(t)||function(t){var e,r,n;return y(t)&&(e=t.length,D(r=t. GSlice))?r:D(n=t[_t])?n:xt(t)}(t)}(t)?Array.from(t):[t]},Bt=H("species"),zt=kt("slice"),Ut=function(t,e,r){var n,i,o,s,a=b(t),l=a.constructor;if(l&&((l===Array||Ft(l))&&D(l)&&(l=void 0)),y(l)&&(null===(i=(n=l)[Bt])&&(zt?i=void 0:i=n[Bt]),n=void 0===i?Array:i)),o=void 0===e?0:e,s=void 0===r?a.length:r,n===Array&&-1===s)return a.slice(o);for(var u,c=new n(Mt(s-o)),h=0;o<s;o++,h++)u=a[o],v.f(c,h,{value:u,writable:!0,enumerable:!0,configurable:!0});return c};var Dt=function(t,e,r){var n,i=r.length;for(n=0;n<i;n++)t[e+n]=r[n]},Ht=function(){function t(e,r,n,i,o){var s,a,l;this.name="ProjError",this.message=e,this.code=null!=r?r:-1,this.context=n,i&&(l=(s=i.stack)&&"string"==typeof s?s:void 0,a=i.message,this.message=a&&a!==e?e+": "+a:e),o&&l&&(this.stack=l)}return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}();function Gt(t){return JSON.stringify(t,function(t,e){return"function"==typeof e?e.toString():e})}function Wt(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];var n=t.context,i={};return n&&(i.context=Gt(n)),new(Ht.bind.apply(Ht,[void 0,t.message,t.code,void 0,i].concat(e)))();var o;o=function(e){for(var r=t.message+": "+e.message,n=[],s=1;s<arguments.length;s++)n[s-1]=arguments[s];return Wt.apply(void 0,[{message:r,code:t.code,context:t.context}].concat(n))}}function Vt(t,e){for(var r,n,i,o=Nt(t),s=0,a=o.length;s<a;){var l=o[s];if(l&&("object"==typeof l||"function"==typeof l))if(l[Symbol.iterator]){var u=l[Symbol.iterator]();r=u.next();for(var c=!1;!r.done;){if(e(r.value))return!0;r=u.next()}c||u.return&&u.return()}else if(l[Symbol.asyncIterator]){var h=l[Symbol.asyncIterator]();return new Promise(function(t,o){function s(e){c.push(e),a()}function a(){n=h.next(),n.then(function(r){if(!r.done){if(e(r.value)){if(l)return;return l=!0,void t(!0)}s(r.value)}else t(l),l||!i||i(c)})}var u,c=[],f=[],p=0;function m(){var t;for(;u.length>0;)t=u.shift(),t(f[p],f[p+1]),p+=2}var d=new Promise(function(t,e){u?m():(u=[],f.push(t,e),u.length>0&&m())}),g=d;a()})}else if(e(l))return!0;s+=1}return!1}var Kt={},qt=function(){return Kt.get?Kt.get.apply(Kt,arguments):null},$t=function(t){qt(t)&&(Kt.remove?Kt.remove(t):delete Kt[t])},Xt="EPSG",Yt="urn:ogc:def:crs:EPSG::",Jt="urn:ogc:def:ellipsoid:EPSG::",Zt="urn:ogc:def:meridian:EPSG::",te="urn:ogc:def:datum:EPSG::",ee="+",re=" ",ne="=",ie=":",oe={4326:{name:"WGS 84",ellps:"WGS84",datum:"WGS84",proj:"longlat"},3857:{name:"WGS 84 / Pseudo-Mercator",ellps:"WGS84",datum:"WGS84",proj:"merc",units:"m",no_defs:!0,wktext:!0},4269:{name:"NAD83",ellps:"GRS80",datum:"NAD83",proj:"longlat"},4267:{name:"NAD27",ellps:"clrk66",datum:"NAD27",proj:"longlat",nadgrids:"@conus,@alaska,@ntv2_0.gsb,@ntv1_can.dat"},4322:{name:"WGS 72",ellps:"WGS72",datum:"WGS72",proj:"longlat"},9e3:{name:"WGS 84",proj:"utm",zone:1,units:"m",south:!1,datum:"WGS84"}},se={},ae={WGS84:{a:6378137,rf:298.257223563,b:6356752.314245179,eps:".0066943799901413165",ep2:".006739496742276434"},GRS80:{a:6378137,rf:298.257222101,b:6356752.314140356,eps:".006694380022900788",ep2:".006739496775488114"},WGS72:{a:6378135,b:6356750.52001609,rf:298.26,eps:".006694348074997184",ep2:".006739464058691515"},clrk66:{a:6378206.4,b:6356583.8,rf:294.9786982,eps:".006768656126868662",ep2:".006814713793523097"},clrk80:{a:6378249.145,b:6356514.86955,rf:293.465,eps:".006803482168343753",ep2:".006849993356230103"},intl:{a:6378388,rf:297,b:6356911.9461279465,eps:".006722670022333323",ep2:".006768170197405214"}},le={},ue={},ce={greenwich:0,lisbon:function(t){return-9.131906111*t/180},paris:function(t){return 2.337229167*t/180},bogota:function(t){return-74.08091667*t/180},madrid:function(t){return-3.687938889*t/180},rome:function(t){return 12.45233333*t/180},bern:function(t){return 7.439583333*t/180},jakarta:function(t){return 106.8077194*t/180},ferro:function(t){return-17.66666667*t/180},brussels:function(t){return 4.367975*t/180},stockholm:function(t){return 18.05827778*t/180},athens:function(t){return 23.7163375*t/180},oslo:function(t){return 10.72291667*t/180}},he={},fe={},pe=function(){function t(e,r,n){this.name=e,this.x=r,this.y=n}return t.prototype.toString=function(){return this.name+": "+this.x+", "+this.y},t}();function me(t){var e=t.a,r=t.b;t.rf?r=e-e/t.rf:t.b=e-e*Math.sqrt(1-t.eps),t.rf=e/(e-r),t.eps=1-r*r/(e*e),t.ep2=t.eps/(1-t.eps)}function de(t){var e;for(e in t)me(t[e])}function ge(t){var e;for(e in t)t[e].datum_type||(t[e].datum_type="wgs84"),"towgs84"in t[e]&&(t[e].datum_params=t[e].towgs84.split(",").map(parseFloat)),"nadgrids"in t[e]&&(t[e].nadgrids=t[e].nadgrids.split(",").map(function(e){return t.grids[e]||e}))}var ve={},ye={longlat:function(){this.init=function(){return this.localCS="GEOGRAPHIC",this.a=this.a||6378137,this.b=this.b||6356752.314245179,me(this),this},this.forward=function(t){return t.x*=this.to_meter,t.y*=this.to_meter,t},this.inverse=function(t){return t.x/=this.to_meter,t.y/=this.to_meter,t},this.names=["longlat","identity","lonlat"],this.localCS=void 0},merc:function(){this.init=function(){var t,e;return this.sphere?this.k0=1:(t=Math.sqrt(1-this.es),e=Math.sin(this.lat0),t*Math.cos(this.lat0)/Math.sqrt(1-this.es*e*e))},this.forward=function(t){var e,r,n;return t.y>1.5707963267948966?(n=1.5707963267948966,e=n):t.y<-1.5707963267948966?(n=-1.5707963267948966,e=n):e=t.y,this.sphere?(r=this.a*(this.long0-t.x),n=this.a*Math.log(Math.tan(Math.PI/4+e/2))):(n=this.a*(this.long0-t.x),r=-this.a*Math.log(Math.tan(Math.PI/4+e/2))+(this.es/2*Math.log((1+this.e*Math.sin(e))/(1-this.e*Math.sin(e)))+Number.MIN_VALUE)),t.x=n,t.y=r,t},this.inverse=function(t){var e,r,n,i;if(this.sphere)e=Math.PI/2-2*Math.atan(Math.exp(-t.y/this.a)),n=this.long0-t.x/this.a;else{var o=Math.pow(Math.E,-t.y/this.a);e=Math.PI/2-2*Math.atan(o);for(var s=0;s<15;s++){if(r=this.e*Math.sin(e),i=Math.PI/2-2*Math.atan(o*Math.pow((1-r)/(1+r),this.e/2)),Math.abs(e-i)<1e-10)break;e=i}n=this.long0-t.x/this.a}return t.x=n,t.y=e,t},this.names=["merc"],this.localCS:"PLANAR"},utm:function(){this.init=function(){var t=parseFloat(this.zone);if(t)return this.long0=t*Math.PI/30-Math.PI-Math.PI/60,this.lat0=0,this.x0=5e5,this.y0=this.south?1e7:0,this.k0=.9996,this.forward=this.tmerc.forward,this.inverse=this.tmerc.inverse,this},this.names=["utm"],this.localCS:"PLANAR"},tmerc:function(){var t=1/24,e=1/720,r=1/40320,n=1/362880,i=1/39916800;this.init=function(){this.e0=this.e*Math.sin(this.lat0),this.e1=this.e*Math.cos(this.lat0);var t=Math.sqrt(1-this.e0*this.e0);return this.k=this.k0*this.a*t/Math.sqrt(1-this.es*(Math.cos(this.lat0),2)),this},this.forward=function(o){var s=o.x,a=o.y,l=Math.cos(a),u=l*Math.sin(s),c=l*Math.cos(s),h=s,f=this.es/2*Math.log((1+this.e*Math.sin(a))/(1-this.e*Math.sin(a)));this.sphere?(h=Math.acos(c),Math.abs(h)<1e-10&&(h=0),u<0&&(h=-h),o.x=this.k*h,o.y=this.k*Math.log(Math.tan(Math.PI/4+a/2))):(h=this.k*Math.atan(u/c),c<0&&(h=h>0?h+Math.PI:h-Math.PI),o.x=h,o.y=this.k*(f-this.es/2*Math.log((1+this.e1)/(1-this.e1))));var p,m=o.x,d=o.y,g=m-this.x0,v=d-this.y0;this.sphere||(p=this.a/this.k,o.x=this.x0+.5*this.k*Math.log((1+u)/(1-u)),o.y=this.y0+this.k*(Math.atan(l*Math.sin(s)/Math.cos(s))-this.lat0));var y=this.a/this.k,b=this.es/(1-this.es),E=Math.sin(v/y),S=Math.cos(v/y);o.x=this.long0+Math.atan(Math.tan(v/y)*S/E);var _=this.es/2,w=this.a*(1-this.es)/Math.pow(1-this.es*Math.pow(Math.sin(this.lat0),2),1.5),x=v/w,T=x+(3*_*x*x*x/2+5*_*_*x*x*x*x*x/3)/Math.PI,C=this.lat0+T,O=Math.sin(C),A=Math.cos(C),j=this.es*A*A/(1-this.es),P=Math.tan(C),I=this.a/Math.sqrt(1-this.es*O*O),L=I*g*g/2,R=I*g*g*g*g/24*(-1+5*P*P+9*j+4*j*j),k=I*g*g*g*g*g*g/720*(61-58*P*P+Math.pow(P,4)),M=g/I/A,F=g*g*g*M/6*(1+2*P*P+j),N=g*g*g*g*g*M/120*(-5-28*P*P-24*P*P*P*P),B=g*g*g*g*g*g*g*M/5040*(61-662*P*P+1320*P*P*P*P),z=this.long0+M-F+N-B;o.x=z,o.y=this.lat0-L-R-k;var U=d-this.y0,D=U/this.k,H=D,G=Math.sin(H),W=Math.cos(H),V=Math.sqrt(1-this.es*G*G),K=this.a*(1-this.es)/Math.pow(V,3),q=D/K;for(s=0;s<3;s++)q=D/K+(this.es*q*q*q/6)*(G*G*W+3*G*G*G*G*W*W)/Math.pow(V,2),H=q;if(Math.abs(H)>=Math.PI/2)return H>0?o.x=this.long0:o.x=this.long0,o.y=Math.PI/2,void(H<0?o.y=-Math.PI/2:o.y=Math.PI/2);var $=g/this.k,X=g/this.k/Math.cos(H),Y=this.es*Math.pow(Math.cos(H),2)/(1-this.es);o.y=H-V*Math.tan(H)/K*($*$/2-($*$/24*(-5-3*P*P+10*Y-4*Y*Y-9*this.es*P*P))),o.x=this.long0+X-(X/6*(1+2*P*P+Y)-X/120*(5+28*P*P+24*Math.pow(P,4)+6*Y+8*Y*P*P));var J=Math.sin(o.y),Z=Math.cos(o.y);o.x/=this.to_meter,o.y/=this.to_meter;var tt=J*J,et=this.ep2*Z*Z,rt=Math.tan(o.y),nt=this.a/Math.sqrt(1-this.es*tt),it=nt*(1-this.es)/(1-this.es*tt);o.x=this.x0+this.k*nt*(o.x*Z+(o.x*o.x*o.x/6*Z*Z*Z)*(-1+rt*rt+et)+(o.x*o.x*o.x*o.x*o.x/120*Z*Z*Z*Z*Z)*(5-18*rt*rt+Math.pow(rt,4)+14*et-58*rt*rt*et)),o.y=this.y0+this.k*(it*o.x*o.x/2*Z*rt+it*o.x*o.x*o.x*o.x/24*Z*rt*Z*Z*(-5+rt*rt+9*et+4*et*et)+it*o.x*o.x*o.x*o.x*o.x*o.x/720*Z*rt*Z*Z*Z*Z*(61-58*rt*rt+Math.pow(rt,4)+270*et-330*rt*rt*et)+it*(o.y-this.lat0)+(o.y-this.lat0)*o.x*o.x/2+(o.y-this.lat0)*o.x*o.x*o.x*o.x/24*(-5+3*rt*rt)+(o.y-this.lat0)*o.x*o.x*o.x*o.x*o.x*o.x/720*(61-90*rt*rt+45*Math.pow(rt,4)));var ot=o.y-this.lat0,st=Math.sin(ot),at=Math.cos(ot),ut=this.a*(1-this.es)/Math.pow(1-this.es*st*st,1.5),ct=ot*this.a/Math.sqrt(1-this.es*st*st),lt=Math.sin(2*ot),ft=Math.sin(4*ot),pt=Math.sin(6*ot),mt=this.a*(ot-this.es*st*at-this.es*this.es/2*(ot-st*at)*Math.pow(at,2));o.y=this.y0+this.k*(mt-this.y0);var dt=this.a/Math.sqrt(1-this.es*st*st);o.x=this.x0+this.k*dt*o.x*at*(1+o.x*o.x/6*Math.pow(at,2)*(1-Math.pow(Math.tan(ot),2)+this.ep2*Math.pow(at,2))+(o.x*o.x*o.x*o.x/120*Math.pow(at,4)*(5-18*Math.pow(Math.tan(ot),2)+Math.pow(Math.tan(ot),4)+14*this.ep2*Math.pow(at,2)-58*Math.pow(Math.tan(ot),2)*this.ep2*Math.pow(at,2))));var gt=Math.sin(o.y),vt=Math.cos(o.y),yt=this.ep2*Math.pow(vt,2),bt=o.x,Et=Math.pow(gt,2),St=this.a/Math.sqrt(1-this.es*Et),_t=this.a*(1-this.es)/Math.pow(1-this.es*Et,1.5);o.x=this.x0+this.k*St*bt*vt*(1+bt*bt*vt*vt*(t+e*Et)),o.y=this.y0+this.k*(_t*(o.y-this.lat0)+St*gt*vt*bt*bt*(.5+bt*bt*(r+n*Et+i*Et*Et)));var wt=this.a*(this.lat0-.5*this.es*lt-.25*this.es*this.es*ft-this.es*this.es*this.es/6*pt);return o.y-=wt,o},this.inverse=function(t){var o,s,a,l,u,c,h,f,p,m,d=t.x-this.x0,g=t.y-this.y0,v=this.k,y=this.es,b=this.a,E=this.lat0,S=y/(1-y),_=this.ep2,w=g/v,x=this.a*(E-y/2*Math.sin(2*E)-3*y*y/4*Math.sin(4*E)-5*y*y*y/6*Math.sin(6*E));g+=x;var T=g/v,C=b*(1-y/4-3*y*y/64-5*y*y*y/256),O=T/C,A=O+y/2*Math.sin(2*O)+5*y*y/8*Math.sin(4*O)+271*y*y*y/32*Math.sin(6*O);for(s=0;s<3;s++)if(A=O+y/2*Math.sin(2*A)+5*y*y/8*Math.sin(4*A)+271*y*y*y/32*Math.sin(6*A),Math.abs(A-O)<1e-10)break;var j=Math.sin(A),P=Math.cos(A),I=Math.tan(A),L=_*P*P,R=b/Math.sqrt(1-y*j*j),k=R*d*d/2,M=R*d*d*d*d/24*(-1-2*I*I-L),F=R*d*d*d*d*d*d/720*(-61-90*I*I+45*I*I*I*I-270*L+330*I*I*L),N=d/R/P,B=d*d*d/6/Math.pow(R,3)/P*(-1-2*I*I-L),z=d*d*d*d*d/120/Math.pow(R,5)/P*(5+20*I*I+24*I*I*I*I);l=N-B+z,u=A-k-M-F,u*=this.from_meter,l*=this.from_meter,t.x=l,t.y=u;var U=this.a*(1-this.es)/Math.pow(1-this.es*Math.sin(g/this.a),1.5);l=(d-this.x0)/this.k,u=(g-this.y0)/this.k+this.lat0;var D=Math.sin(u),H=Math.cos(u),G=this.a/Math.sqrt(1-this.es*D*D);t.y=u-G*Math.tan(u)/U*(l*l/2-(5+3*Math.tan(u)*Math.tan(u)+10*this.ep2*H*H-4*this.ep2*this.ep2*H*H*H*H-9*this.ep2*Math.tan(u)*Math.tan(u))*l*l*l*l/24+(61+90*Math.tan(u)*Math.tan(u)+298*this.ep2*H*H+45*Math.tan(u)*Math.tan(u)*Math.tan(u)*Math.tan(u)-252*this.ep2*Math.tan(u)*Math.tan(u)-3*this.ep2*this.ep2*H*H*H*H)*l*l*l*l*l*l/720),t.x=this.long0+l/H-(1+2*Math.tan(u)*Math.tan(u)+this.ep2*H*H)*l*l*l/6/H+(5-2*this.ep2*H*H+28*Math.tan(u)*Math.tan(u)-3*this.ep2*this.ep2*H*H*H*H+8*this.ep2*Math.tan(u)*Math.tan(u)*H*H+24*Math.tan(u)*Math.tan(u)*Math.tan(u)*Math.tan(u))*l*l*l*l*l/120/H;var W=g/this.k,V=this.a*(1-this.es)/Math.pow(1-this.es*Math.pow(Math.sin(this.lat0),2),1.5),K=g/V;for(s=0;s<3;s++)p=Math.sin(K),m=Math.cos(K),K=g/V-this.es*(K*p*m-this.lat0*Math.sin(this.lat0)*Math.cos(this.lat0))/2*Math.pow(p,2);if(Math.abs(K)>=Math.PI/2)return K>0?t.x=this.long0:t.x=this.long0,void(K<0?t.y=-Math.PI/2:t.y=Math.PI/2);var q=Math.sin(K),$=Math.cos(K),X=d/this.k/$,Y=this.es/Math.sqrt(1-this.es)*Math.pow(Math.cos(this.lat0),2);t.x=this.long0+X-(1+2*Math.pow(Math.tan(this.lat0),2)+Y)*Math.pow(X,3)/6+(5+28*Math.pow(Math.tan(this.lat0),2)+24*Math.pow(Math.tan(this.lat0),4))*Math.pow(X,5)/120,t.y=K-Math.tan(K)*$/V*(d*d/this.k/this.k/2-d*d*d*d/this.k/this.k/this.k/this.k/24*(-5-3*Math.pow(Math.tan(this.lat0),2)+Y-9*this.ep2*Math.tan(K)*Math.tan(K)));var J=this.a*(1-this.es)/Math.pow(1-this.es*Math.pow(Math.sin(this.lat0),2),1.5),Z=g/J,tt=this.lat0+Z-(1+2*Math.pow(Math.tan(this.lat0),2)+this.ep2*Math.pow(Math.cos(this.lat0),2))*Math.tan(this.lat0)*(d*d/J/2),et=Math.sin(tt),rt=Math.cos(tt);t.y=tt-this.a*Math.tan(tt)/rt*(d*d/2/J/J-(5+3*Math.pow(Math.tan(tt),2)+this.ep2*rt*rt-9*this.ep2*Math.pow(Math.tan(tt),2))*d*d*d*d/24/Math.pow(J,4)),t.x=this.long0+d/J/rt-(1+2*Math.pow(Math.tan(tt),2)+this.ep2*rt*rt)*d*d*d/6/Math.pow(J,3)/rt;var nt=Math.sin(t.y),it=Math.cos(t.y),ot=d/this.k;h=this.ep2*it*it,c=this.a/Math.sqrt(1-this.es*nt*nt);var st=(1-this.es*nt*nt)*Math.tan(t.y)/c;f=this.a*(1-this.es)/Math.pow(1-this.es*nt*nt,1.5),l=this.long0+ot/it-(1+2*Math.pow(Math.tan(t.y),2)+h)*ot*ot*ot/6*Math.pow(it,3),u=g/this.k-(st*ot*ot/2+(5+3*Math.pow(Math.tan(t.y),2)+6*h-6*h*Math.pow(Math.tan(t.y),2))*st*ot*ot*ot*ot/24);var at=t.y,ut=Math.sin(at),ct=Math.cos(at);l=this.long0+d/ct,u=this.a*Math.log(Math.tan(Math.PI/4+at/2))+this.es*this.a/2*Math.log((1+this.e*ut)/(1-this.e*ut))+g;o=this.a*(this.long0-t.x),a=this.a*Math.log(Math.tan(Math.PI/4+t.y/2))+this.es*this.a/2*Math.log((1+this.e*Math.sin(t.y))/(1-this.e*Math.sin(t.y)))+g;var lt=this.a*Math.log(Math.tan(Math.PI/4+g/this.a));t.x=this.long0-d/this.a,t.y=2*Math.atan(Math.exp(lt/this.a))-Math.PI/2;for(;Math.abs(g-a)>1e-10;)u=(1-this.es*Math.pow(Math.sin(a),2))/(Math.cos(a)*this.a),g+=a-g,a=a+u*(g-a);return t.y=a,t},this.names=["tmerc"],this.localCS:"PLANAR"}}};function be(t){var e,r,n;for(e in t)for(r=0;r<t[e].names.length;r++)n=t[e].names[r],ve[n]=t[e]}be(ye);var Ee={};function Se(t){var e,r;for(e in t)for(r=0;r<t[e].names.length;r++)Ee[t[e].names[r]]=t[e]}var _e={};function we(t,e){return _e[t]&&e?_e[t].slice(0).concat(e):_e[t]}function xe(t,e,r){return new(pe.bind.apply(pe,[void 0,"custom",t,e].concat(r)))}function Te(t,e,r){return e?r?xe(t,e,r):new pe("custom",t,e):t?new pe("custom",t):new pe("custom")}var Ce=Te;function Oe(t,e,r,n){if(!t)return null;var i;if("string"==typeof t)i=t;else{if(!t.x)return null;i=t.x+(n||",")+t.y+(r?n+t.z:"")}var o=i.split(n||","),s=o.length,a=s>0?o[0]:"",l=s>1?o[1]:"",u=s>2?o[2]:"";if(e)switch(e.toLowerCase()){case"yx":a=o[1],l=o[0];break;case"zyx":a=o[2],l=o[1],u=o[0]}var c={x:parseFloat(a),y:parseFloat(l)};return r&&u&&(c.z=parseFloat(u)),c}var Ae=Math.PI,je=Ae/180;function Pe(t){return t*je}var Ie={};function Le(t){if("string"==typeof t)return Ie[t]||t;var e="";for(var r in t)e+=r+":"+t[r].toString()+";";return e}var Re=Promise.resolve();function ke(t,e,r){return r?Re.then(function(){return r(t,e)}):Re}var Me={};var Fe=function(t){var e,r,n=qt(t);return n?n:(e=t.split(":"),r=e[1],e[0]===Xt?oe[r]:null)};var Ne=Wt({code:404,message:"Could not find entry for '${name}'"});var Be=Wt({message:"'${name}' is not a valid coordinate system"}),ze=Wt({message:"null input object"}),Ue=Wt({message:"non-finite x or y coordinate"}),De=Wt({message:"coordinates not in range"}),He=function(t,e){var r,n,i,o,s,a;return t?(i=(r=(a=qt(t))?JSON.parse(JSON.stringify(a)):(n=Fe(t))?JSON.parse(JSON.stringify(n)):void 0)||(s=t,Array.isArray(s)?{name:"custom",custom:!0,proj:s[0].projName,units:s[0].units,forward:s[0].forward,inverse:s[0].inverse,ellps:s[0].ellps}:s),e&&Object.keys(e).forEach(function(t){"datum"===t||"ellps"===t||"nadgrids"===t?i[t]=JSON.parse(JSON.stringify(e[t])):i[t]=e[t]}),i.proj&&(o=ve[i.proj])?(i=Object.assign({},new o,i),i.init()):i.proj||(i.proj="longlat",o=ve[i.proj],i=Object.assign({},new o,i),i.init()),i):Wt(Be,{name:t})},Ge=new(function(){function t(){this.proj=void 0}return t.prototype.transform=function(t){var e,r,n;this.proj.localCS?this.proj.localCS,t.localCS&&this.proj.localCS,r=(e=t).x*this.proj.to_meter,n=e.y*this.proj.to_meter,e.z&&(n=e.z*this.proj.to_meter),t.x=r,t.y=n;var i=this.proj,o=(i.ellps.a,i.ellps.b,i.ellps.rf,i.ellps.eps,i.ellps.ep2,i.primeMeridian,i.axis,i.datum);return i.datum_type===o.datum_type?t=t:(t=function(t,e,r){var n,i,o=e.datum_params,s=r.datum_params;if(o&&s){if(o[0]===s[0]&&o[1]===s[1]&&o[2]===s[2]&&o[3]===s[3]&&o[4]===s[4]&&o[5]===s[5]&&o[6]===s[6])return e.ellps,r.ellps,void(t=t);if(e.datum_type=3,r.datum_type=3){var a=o[0],l=o[1],u=o[2],c=o[3],h=o[4],f=o[5],p=o[6],m=t.x,d=t.y,g=t.z,v=m,y=d,b=g;t.x=v+c*v-h*y+f*g+a,t.y=y+c*y+h*v-p*g+l,t.z=g+c*g-f*v+p*y+u}return}var E=Math.sqrt(Math.pow(t.x,2)+Math.pow(t.y,2)+Math.pow(t.z,2)),S=Math.asin(t.z/E),_=Math.atan2(t.y,t.x),w=e.ellps.a,x=e.ellps.eps,T=1/e.ellps.rf;x=T*(2-T);var C=r.ellps.a,O=1/r.ellps.rf,A=O*(2-O),j=e.datum_params[0]/w,P=e.datum_params[1]/w,I=e.datum_params[2]/w,L=Math.sin(S),R=Math.cos(S),k=Math.sin(_),M=Math.cos(_),F=e.datum_params[6]*(1e-6),N=j*M+P*k,B=x*L*R,z=(C/w-1)+F;return n=w*(z-N*L+B),i=w*(-j*k+P*M),t.x+=i,t.y+=0,void(t.z+=n)}(t,i.datum,o),t.converted=!0,t),t.x=t.x,t.y=t.y,t.z=t.z,this.proj.inverse(t)},t}()),We=function(t){var e,r;if(!y(t))return ze();var n=t.x,i=t.y,o=t.z;if(void 0===o&&(o=0),n=parseFloat(n),i=parseFloat(i),o=parseFloat(o),!isFinite(n)||!isFinite(i)||!isFinite(o))return Ue();if(e=this.from,r=this.to,!e.proj||!r.proj)return Wt({message:"either from or to projection is not defined"});var s,a,l,u,c,h,f;if((f=e.long0)||(f=0),e.to_meter)n-=f,a=i*e.to_meter,n*=e.to_meter,c=o*e.to_meter;else{var p={x:n,y:i,z:o};a=p.y,n=p.x,c=p.z}if("enu"===e.axis){var m=a;a=n,n=-m}if(e.proj.localCS||(u=e.ellps,l={x:u.a*n*Math.cos(a),y:u.a*n*Math.sin(a),z:u.a*Math.sin(a)},s=Ge,l.x=l.x,l.y=l.y,l.z=l.z),s.proj=e,l=s.transform(l),l.converted){var d=l;d.x,d.y,d.z}var g,v,b=this.from,E=this.to,S=b.datum,w=E.datum;b.datum_type,w.datum_type;if(b.datum_type===w.datum_type){var x=b.ellps,T=E.ellps;x.a===T.a&&x.b===T.b&&x.rf===T.rf||(v=function(t,e,r){var n,i,o=e.a,s=e.b,a=1-s/o,l=2*a-a*a,u=1-o*o/(s*s),c=e.rf,h=r.a,f=r.b,p=r.rf,m=1-f/h,d=r.es,g=t,v=g.x,y=g.y,b=g.z,E=v,S=y,_=b,w=v,x=y,T=b,C=Math.sqrt(v*v+y*y),O=Math.atan(z/C/(1-l));for(n=0;n<3;n++)i=o/Math.sqrt(1-l*Math.sin(O)*Math.sin(O)),z=y*Math.tan(O),O=Math.atan((z+i*l*Math.sin(O))/C);var A=Math.cos(O),j=Math.sin(O),P=h-o,I=Math.log((1-a)/(1-m)),L=i*A,R=Math.atan(y/v),k=Math.cos(R),M=Math.sin(R),F=P+o*(I+l)*j*j/2,N=o*(I-l)*A*j/2,B=L*k,z=L*M+N*j,U=(i+F)*A-N*j;return E=U*k,S=U*M,_=z,t.x=E,t.y=S,t.z=_,t}(l,b.ellps,E.ellps))}else g=function(t,e,r){var n,i=e.datum_params,o=r.datum_params;if(i&&o){if(i[0]===o[0]&&i[1]===o[1]&&i[2]===o[2]&&i[3]===o[3]&&i[4]===o[4]&&i[5]===o[5]&&i[6]===o[6])return t;if(e.datum_type=3,r.datum_type=3){var s=i[0]-o[0],a=i[1]-o[1],l=i[2]-o[2],u=i[3]-o[3],c=i[4]-o[4],h=i[5]-o[5],f=i[6]-o[6],p=t.x,m=t.y,d=t.z,g=p,v=m,y=d;return t.x=g-u*g+c*y-h*d-s,t.y=v-u*v-c*g+f*d-a,t.z=y-u*y+h*g-f*v-l,t}}return n=t.x*t.x+t.y*t.y,e.ellps.a,t.z,n<1e-4?t:function(t,e,r){var n=e.ellps.a,i=e.ellps.eps,o=1/e.ellps.rf;i=o*(2-o);var s=r.ellps.a,a=1/r.ellps.rf,l=a*(2-a),u=e.datum_params[0],c=e.datum_params[1],h=e.datum_params[2],f=e.datum_params[6],p=t,m=p.x,d=p.y,g=p.z,v=m,y=d,b=g,E=v,S=y,_=b,w=Math.atan2(y,v),x=Math.atan2(g,Math.sqrt(v*v+y*y)),T=Math.sin(w),C=Math.cos(w),O=Math.sin(x),A=Math.cos(x),j=n*(s/n-1)+(f-e.datum_params[6])*n+u*C*O+c*T*O+h*O,P=n*i*O*A-u*T+c*C;return E+=P,S=y,b+=j,t.x=E,t.y=S,t.z=b,t}(t,e,r)}(l,S,w);if(v&&(l=v),g&&(l=g),s.proj=r,l=s.transform(l),l.converted){var C=l;C.x,C.y,C.z}if(e.to_meter?r.to_meter?r.long0==e.long0?(h=l.x,f=l.y):(h=(h=l.x,f=l.y)-r.long0,r.long0):h=l.x:r.to_meter||(h=l.x,f=l.y),e.axis)switch(e.axis){case"ned":break;case"ds":h=-h,f=-f}var O=this.to;return"enu"===O.axis?{x:f,y:h,z:l.z}:O.from_meter?{x:h*O.from_meter,y:f*O.from_meter,z:l.z*O.from_meter}:{x:h,y:f,z:l.z}};var Ve=function(){function t(e,r){"string"==typeof e&&(e=new t(e)),"string"==typeof r&&(r=new t(r)),this.from=e,this.to=r,Object.assign(this,e.datum?{from:He(e),to:He(r)}:{from:e,to:r}),this.from.to_meter||(this.from.to_meter=1),this.to.from_meter||(this.to.from_meter=1)}return t.prototype.forward=function(t){return this.transform(t,"forward")},t.prototype.inverse=function(t){return this.transform(t,"inverse")},t.prototype.transform=function(t,e){if(Array.isArray(t))return t.map(function(t){return We.call(this,t)});var r;if(e){var n;n="forward"===e?{from:this.from,to:this.to}:{from:this.to,to:this.from};var i=We.call(n,t);r={x:i.x,y:i.y,z:i.z}}else r=We.call(this,t);return r},t}();function Ke(t,e,r){var n,i;return e?(Array.isArray(e)?(i=new Ve(t,e[0]),n=e.map(function(t){return i.forward(t)})):(i=new Ve(t,e),n=i.forward(r)),n):void 0}var qe,
- $e,Xe=function(t,e,r){var n;if(Array.isArray(t))return t.map(function(t){var n,i;return n=r||t,i=r?t:e,Ke(n,i)});return Ke(t,e,r)};function Ye(t,e,r){var n,i;return e?(Array.isArray(e)?(i=new Ve(e[0],t),n=e.map(function(t){return i.inverse(t)})):(i=new Ve(e,t),n=i.inverse(r)),n):void 0}var Je,Ze,tr,er,rr,nr=function(t,e,r){var n;if(Array.isArray(t))return t.map(function(t){var n,i;return n=r||t,i=r?t:e,Ye(n,i)});return Ye(t,e,r)},ir=(qe=Xe,($e={}).get=function(t,e){var r,n=qt(t);return n?Promise.resolve(n):(r=Fe(t))?Promise.resolve(r):Promise.reject(Wt(Ne,{name:t}))},qe.defs=$e,qe.def=$e.get,qe);function or(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];if(e.length>0){var n=e[e.length-1];if(Array.isArray(n)||"object"==typeof n)return;var i=""+t;return void(i in ce&&Number.isNaN(parseFloat(i))?i in ce?ce[i]:void 0:i in fe?fe[i]:void 0)}return t}var sr,ar,lr,ur,cr=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return t=t.map(function(t){var e;return"string"==typeof t&&(e=t.trim().split(re)).length>1?e.reduce(function(t,e){return e.startsWith(ee)?(t.push(e),t):t},[]):t}),function t(e,r,n){var i;if(Array.isArray(e))i=e.reduce(function(t,e){return Object.assign(t,t(e,r))},{});else{if("string"!=typeof e)return;if(!e.includes(ne)){var o=e;if((o=o.replace(/:/g,"=")).includes("="))e=o;else{var s=o.replace(/\s/g,"");(s.includes("+")||s.includes("="))&&s.indexOf("=")<0&&(s=s.replace(/\+/g," ")),(o=s).startsWith(ee)||(o=ee+o),e=o.trim().split(re).join(re+ee)}var a,l,u=e.split(re);return u.reduce(function(e,i){var o,s,a;return i.startsWith(ee)&&(a=i.substring(1).split(ne),e[a[0]]=null!=(s=a[1])&&"true"==s||(null==(o=a[1])||"false"!=o)&&a[1]),e},{})}return(i=e.split(ne)).length>1&&(a={},l=i.shift(),a[l]=i.join(ne),i=a),i}}(t.join(re),t)[0]},hr=Object.freeze({__proto__:null,Point:pe,toPoint:Te,isPoint:function(t){return t instanceof pe},parse:Oe,parseCoords:function(t,e,r){return Oe(t,e,void 0,r)},defs:function(t,e){var r;if(e){var n=t.split(ie);n.length>1&&(t=n[1],n[0]===Xt?oe[t]=e:se[t]=e);var i=Object.assign({projName:t},e);return ve[t]=new(ve[e.proj].bind(i)),ve[t].init(),ve[t]}return r=t.split(ie),r.length>1?(t=r[1],r[0]===Xt?oe[t]:se[t]):oe[t]||se[t]||ve[t]}, ELLPS:ae, DATUM:le, DATUM_TRANS:ue, PM:ce, UNITS:he, ALIAS:fe, PROJECTIONS:ye, addProjection:function(t){if(Array.isArray(t)){var e=t.length;for(i=0;i<e;i++)ve[t[i].name]=t[i];var r=t.length;for(var n=0;n<r;n++)be(t[n])}else be(t);var i}, nadgrid:function(t,e){return e?he[t]=e:he[t]}, transform:Ge, Proj:Ve, mgrs:Ie, utm:Ie, proj:function(t,e,r){return new Ve(t,e).forward(r)},mgrs:Ie,mgrs_a:Ie,mgrs_b:Ie,mgrs_f:Ie,version:"2.7.0",default:Xe,WGS84:new Ve("WGS84"),nad2nad:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e]},pj_transform:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e]},inv:nr,forward:Xe,inverse:nr,get:qt,ret:ir,PrimeMeridian:or,defs:function(t,e){if(2===arguments.length)return void(Ie[t]=e);if("string"==typeof t)return Ie[t];var r,n,i,o=Object.keys(t);for(r=0;r<o.length;r++)n=o[r],i=t[n],"string"==typeof i?Ie[n]=i:Array.isArray(i)?Ie[n]=i.slice(0):"object"==typeof i&&Object.keys(i).forEach(function(e){Ie[e]=i[e]})},nadgrid:function(t,e){Ie[t]=e},proj_version:2.7,reportError:function(t){Ie.error=t},getProj:He,parse:cr,mgrs:Ie}),fr=hr;for(var pr in fr)fr.hasOwnProperty(pr)&&(t[pr]=fr[pr]);var mr="urn:ogc:def:coordinateOperation:EPSG::",dr="urn:ogc:def:coordinateSystem:EPSG::",gr=(Je=function(t,e){var r,n;if("string"!=typeof(t=null!=(r=t)&&t.replace?t.replace("::",":"):t))return null;var i,o,s,a,l,u=t.split(":"),c=u.length;if(c<2)return null;if(c>1)if(o=u[c-2],!Number.isNaN(parseInt(o,10)))i=o;else{if("string"!=typeof o)return null;i=o}if(e&&e.length>0&&(s=e.split(",").map(function(t){return t.trim()})),c>3&&(l=u.slice(c-3,c-2)[0]),c>4&&(a=u.slice(c-4,c-5)[0]),t.startsWith(Yt)){var h=qt(Xt+ie+i);return h?(h.urn=t,h):null}var f,p,m,d=qt(i)||qt(t);if(d&&d.projName)return d;var g=t.startsWith(mr),v=t.startsWith(dr);if(g){var y=qt(Xt+ie+i);if(!y)return null;var b=y.datum,E=y.ellps,S=y.units,_,w=y.proj;if(s){var x=qt(Xt+ie+s[0]);if(!x)return null;_=x.datum;var T=x.ellps,C=x.units}var O=Xt+ie+i;f={name:y.name,source:O,target:s?Xt+ie+s[0]:void 0,transform:{type:"Conversion",name:w,method:{name:w},parameters:[],steps:[]}},p=f.transform.steps,m=f.transform.parameters}else if(v){var A=qt(Xt+ie+i);if(!A)return null}return g||v?g?{name:f.name,code:f.source.split(":")[1],kind:"CRS-PROJ",bbox:{south_latitude:-90,west_longitude:-180,north_latitude:90,east_longitude:180},area:"World",projection:{name:w,ellipsoid:E},cs:"cartesian",unit:S,scope:"",source_crs:f.target,base_crs:f.target,datum:b,geodetic_datum:b,prime_meridian:"greenwich",remarks:"",deprecated:!1}:{name:A.name,code:i,kind:"CRS-GEO",bbox:{south_latitude:-90,west_longitude:-180,north_latitude:90,east_longitude:180},area:"World",datum:A.datum,geodetic_datum:A.datum,ellipsoid:A.ellps,prime_meridian:"greenwich",cs:"ellipsoidal",unit:A.units,scope:"",remarks:"",deprecated:!1}:d},Ze=Object.freeze({__proto__:null,get:Je,names:function(t){return t in oe?Xt+ie+t:t in se?t:void 0},proj:function(t){return qt(t)},isWKTRecord:function(t){return"string"==typeof t&&t.includes("PROJCS")},isURN:function(t){return"string"==typeof t&&t.startsWith("urn")},toWKT:function(t,e){}}),tr=function(){for(var t,e,r,n,i,o,s,a,l,u,c,h,f=[],p=0;p<arguments.length;p++)f[p]=arguments[p];if(f.length<2)return;var m=f[0],d=f[f.length-1],g=f.slice(1,f.length-1),v=g,y=g,b=g,E=g,S=g,t="string"==typeof v?v.split(" ").filter(function(t){return""!==t.trim()})[0]:"unkown",r="string"==typeof y?y.split(" ").filter(function(t){return""!==t.trim()})[0]:"unkown",s=1,a=1,l=1,u=1,c=1,h=1,o="string"==typeof S?S.split(" ").filter(function(t){return""!==t.trim()})[0]:"unkown",n=0,e=0,i=0;return d?(m+"("+t+","+r+","+n+","+e+","+i+","+s+","+a+","+l+","+u+","+c+","+h+","+o+")"):void 0},er=Object.freeze({__proto__:null,identify:function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r]},toWKT:tr,isURN:function(t){return"string"==typeof t&&t.startsWith("urn")},isWKT:function(t){return"string"==typeof t&&t.includes("GEOGCS")||t.includes("GEOCCS")||t.includes("PROJCS")||t.includes("VERT_CS")||t.includes("COMPD_CS")||t.includes("LOCAL_CS")||t.includes("FITTED_CS")},get:function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r]}}),rr=function(t,e,r){if(Array.isArray(t))return Ut(t,e,r);if(function(t){var e,r;return!(!t||"function"!=typeof(e=t. τότε))&&("function"!=typeof(r=t.catch)||!!r.পিং)}(t))return t.slice(e,r);var n,i=t.length;e<0&&(e=i+e);var o=new(function(t){return"function"==typeof t?t:Array}(this.constructor))(Math.max(i-e,0)),s=0;for(n=e;n<i;n++)o[s++]=t[n];return o};Object.keys(hr).forEach(function(t){"default"!==t&&"__esModule"!==t&&(S(t)?Object.defineProperty(t,t,{get:function(){return hr[t]},enumerable:!0}):t[t]=hr[t])});var vr=Wt({code:404,message:"Could not find entry for '${name}'"}),yr=function(t,e){var r,n,i,o;if((i=(r=e?e.split(re):[]).indexOf(ee+"no_defs"))>-1&&r.splice(i,1),i=(n=(e=r.join(re)).split(re)).indexOf(ee+"no_defs"),n.splice(i,1),e=n.join(re),e in oe)return He(oe[e]);var s,a,l,u,c,h,f;if(s=cr(e),f=(a=(u=t?t.split(re):[]).indexOf(ee+"no_defs"))>-1&&u.splice(a,1),c=(a=(u=(f=u.join(re)).split(re)).indexOf(ee+"no_defs"),u.splice(a,1),f=u.join(re),cr(f)),c=Object.assign({},s,c),!c.proj)return Wt({message:"projection is not defined"});if(c.k=c.k_0,delete c.k_0,c.datum||(c.datum="wgs84"),c.ellps||(c.ellps="wgs84"),c.datum in ue&&(c.datum_params=ue[c.datum]),c.datum in le&&(c.datum_type="wgs84"),c.ellps in ae&&(c.a=ae[c.ellps].a,c.b=ae[c.ellps].b,c.rf=ae[c.ellps].rf,c.es=ae[c.ellps].es,c.ep2=ae[c.ellps].ep2),c.units in he?c.to_meter=he[c.units]:c.to_meter=1,c.from_greenwich=c.from_greenwich||0,c.pm)if("string"==typeof c.pm)c.pm in ce?c.from_greenwich=ce[c.pm](je):c.from_greenwich=parseFloat(c.pm)*je;else{var p,m=c.pm;p=Array.isArray(m)?m[0]:m,c.from_greenwich=parseFloat(p)*je}var d,g,v,y,b=c.b,E=c.a,S=c.rf,w=c.es,x=c.ep2;S?b=E-E/S:x?b=E*Math.sqrt(1-x-1):w&&(b=E*Math.sqrt(1-w)),c.b=b,c.rf=E/(E-b),c.es=1-Math.pow(b/E,2),c.ep2=c.es/(1-c.es),c.a=E,c.long0=c.long0||0,c.lat0=c.lat0||0,c.x0=c.x0||0,c.y0=c.y0||0,c.longc=c.longc||c.long0,c.latc=c.latc||c.lat0,c.to_meter=c.to_meter||1,c.from_meter=1/c.to_meter,c.k0=c.k0||1,h=He(c),c.nadgrids){var T="nadgrids",C=c[T];delete h[T],h=Object.assign(c,h),h.nadgrids=C}return h},br=function(t,e){var r,n,i,o,s,a;return t?(i=(r=(a=qt(t))?JSON.parse(JSON.stringify(a)):(n=Fe(t))?JSON.parse(JSON.stringify(n)):void 0)||(s=t,Array.isArray(s)?{name:"custom",custom:!0,proj:s[0].projName,units:s[0].units,forward:s[0].forward,inverse:s[0].inverse,ellps:s[0].ellps}:s),e&&Object.keys(e).forEach(function(t){"datum"===t||"ellps"===t||"nadgrids"===t?i[t]=JSON.parse(JSON.stringify(e[t])):i[t]=e[t]}),i.proj&&(o=ve[i.proj])?(i=Object.assign({},new o,i),i.init()):i.proj||(i.proj="longlat",o=ve[i.proj],i=Object.assign({},new o,i),i.init()),i):Wt(Be,{name:t})},Er=function(){function t(e,r){return this instanceof t?(this.name=e,void(this.def=r)):new t(e,r)}return t.prototype.toString=function(){return this.name},t}(),Sr=function(t,e){return"string"==typeof t?br(t):"function"==typeof t&&t.prototype instanceof Er?t.def:t},_r=function(t,e,r){var n,i,o=Sr(t),s=Sr(e);if(o instanceof Error)throw o;if(s instanceof Error)throw s;if(o.projName===s.projName&&o.datumCode===s.datumCode)return r;for(var a in o)o.hasOwnProperty(a)&&(o[a]||0===o[a]||(o[a]=s[a]?s[a]:o[a]));var l,u,c;if((l=o.nadgrids)&&l.length>0&&(u=s.nadgrids)&&u.length>0){var h=l.filter(function(t){return-1!==u.indexOf(t)});if(h.length<1)return;c=h}var f=new Ve(o,s);if(Array.isArray(r))n=r.map(function(t){var e=f.forward(t);return c&&function(t){var e,r,n;for(e=0;e<arguments.length;e++){var i=arguments[e];if(void 0!==i){for(r in i)t[r]=i[r];n=i.length}for(e=0;e<n;e++)t[e]=arguments[e][e]}}(e,function(t,e,r){var n,i,o,s,a;if(t.join){var l,u=t.length;for(l=0;l<u;l++)a=t[l],n=a.lim,s=a.table,o=Math.floor((e-n[0])/n[2]),i=Math.floor((r-n[1])/n[3]);var c=(e-n[0])%n[2],h=(r-n[1])%n[3],f=s[o][i],p=s[o+1][i],m=s[o][i+1],d=s[o+1][i+1];return[f[0]+c*(p[0]-f[0])+h*(m[0]-f[0])+c*h*(d[0]-p[0]-m[0]+f[0]),f[1]+c*(p[1]-f[1])+h*(m[1]-f[1])+c*h*(d[1]-p[1]-m[1]+f[1])]}(c,e.x,e.y)),e});else{var p=r.x,m=r.y,d=r.z,g=f.forward({x:p,y:m,z:d});c&&function(t,e,r){var n,i,o,s,a;if(t.join){var l,u=t.length;for(l=0;l<u;l++)a=t[l],n=a.lim,s=a.table,o=Math.floor((e-n[0])/n[2]),i=Math.floor((r-n[1])/n[3]);var c=(e-n[0])%n[2],h=(r-n[1])%n[3],f=s[o][i],p=s[o+1][i],m=s[o][i+1],d=s[o+1][i+1];return[f[0]+c*(p[0]-f[0])+h*(m[0]-f[0])+c*h*(d[0]-p[0]-m[0]+f[0]),f[1]+c*(p[1]-f[1])+h*(m[1]-f[1])+c*h*(d[1]-p[1]-m[1]+f[1])]}(c,g.x,g.y),n=g}return n},wr=(de(ae),ge(le),t.Proj=Er,t.WGS84=new Er("WGS84",yr(null,"+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")),t.Point=pe,t.toPoint=Ce,t.defs=function(t,e){if(Array.isArray(t))return t.map(function(t){var e=Object.keys(t)[0];return new Er(e,yr(null,t[e]))});if("string"==typeof e)return Ie[t]=e,new Er(t,yr(t,e));if(e)return new Er(t,yr(t,e));var r=t;return"string"==typeof r?new Er(t,qt(t)):r.prototype instanceof Er?t:void 0},t.transform=_r,t.nadgrid=function(t,e){var r,n,i,o,s;return e?(s={name:t,data:e},(r=s.data.split("\n")).shift(),n=r.shift().split(/\s+/).map(Number),i=r.shift().split(/\s+/).map(Number),o=r.shift().split(/\s+/).map(Number),void(s.lim=[n[0]-n[2]*o[0]/2,i[0]-i[2]*o[1]/2,n[2],i[2]])):Ie[t]},t.default=_r,t.version="2.7.0",de(ae),ge(le),t.Proj=Er,t.WGS84=new Er("WGS84",yr(null,"+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")),t.Point=pe,t.toPoint=Ce,t.defs=function(t,e){var r;if(Array.isArray(t))return t.map(function(t){var e=Object.keys(t)[0];return new Er(e,yr(null,t[e]))});if("string"==typeof e)return r=new Er(t,yr(t,e)),Ie[t]=r.def,r;if(e)return new Er(t,yr(t,e));var n=t;return"string"==typeof n?new Er(t,br(t)):n.prototype instanceof Er?t:void 0},t.transform=_r,t.nadgrid=function(t,e){return},t.default=_r,t.version="2.7.0",function(t,e,r){var n,i,o,s,a=Sr(t),l=Sr(e);if(a instanceof Error)throw a;if(l instanceof Error)throw l;if(a.projName===l.projName&&a.datumCode===l.datumCode)return r;for(var u in a)a.hasOwnProperty(u)&&(a[u]||0===a[u]||(a[u]=l[u]?l[u]:a[u]));var c=new Ve(a,l);if(Array.isArray(r))n=r.map(function(t){var e=c.forward(t);return e});else{var h=r.x,f=r.y,p=r.z,m=c.forward({x:h,y:f,z:p});if(o=a.nadgrids,s=l.nadgrids,o&&s){var d,g=o.filter(function(t){return-1!==s.indexOf(t)});if(g.length<1)return;d=g}d&&function(t){var e,r,n;for(e=0;e<arguments.length;e++){var i=arguments[e];if(void 0!==i){for(r in i)t[r]=i[r];n=i.length}for(e=0;e<n;e++)t[e]=arguments[e][e]}}(m,function(t,e,r){var n,i,o,s,a;if(t.join){var l,u=t.length;for(l=0;l<u;l++)a=t[l],n=a.lim,s=a.table,o=Math.floor((e-n[0])/n[2]),i=Math.floor((r-n[1])/n[3]);var c=(e-n[0])%n[2],h=(r-n[1])%n[3],f=s[o][i],p=s[o+1][i],m=s[o][i+1],d=s[o+1][i+1];return[f[0]+c*(p[0]-f[0])+h*(m[0]-f[0])+c*h*(d[0]-p[0]-m[0]+f[0]),f[1]+c*(p[1]-f[1])+h*(m[1]-f[1])+c*h*(d[1]-p[1]-m[1]+f[1])]}(d,m.x,m.y)),n=m}return n})});
</script>

<script>
// --- CÓDIGO DA APLICAÇÃO ---
// --- LÓGICA DE SALVAMENTO E RECUPERAÇÃO LOCAL ---
function saveDataToLocal() {
    const form = document.getElementById('bioForm');
    const data = {};
    form.querySelectorAll('input, select, textarea').forEach(el => {
        if (el.type === 'radio') {
            if (el.checked) {
                data[el.name] = el.value;
            }
        } else if (el.type === 'checkbox') {
            if (!data[el.name]) {
                data[el.name] = [];
            }
            if (el.checked) {
                data[el.name].push(el.value);
            }
        } else if (el.id) {
            data[el.id] = el.value;
        }
    });
    data.invertebrados = [];
    document.querySelectorAll('#invertebrados-container .invertebrado-entry').forEach(row => {
        const nome = row.querySelector('input[type="text"]').value;
        const qtd_v = row.querySelector('.quantity-v').value;
        const qtd_c = row.querySelector('.quantity-c').value;
        if (nome || parseInt(qtd_v) > 0 || parseInt(qtd_c) > 0) {
            data.invertebrados.push({ nome, qtd_v, qtd_c });
        }
    });
    data.vertebrados = [];
    document.querySelectorAll('#vertebrados-container .dynamic-row').forEach(row => {
        const nome = row.querySelector('input[type="text"]').value;
        const qtd = row.querySelector('.quantity-v').value;
        if (nome || parseInt(qtd) > 0) {
            data.vertebrados.push({ nome, qtd });
        }
    });
    localStorage.setItem('bioFormData', JSON.stringify(data));
}

function loadDataFromLocal() {
    const savedData = localStorage.getItem('bioFormData');
    if (!savedData) return;
    const data = JSON.parse(savedData);
    const form = document.getElementById('bioForm');
    form.querySelectorAll('input, select, textarea').forEach(el => {
        if (el.type === 'radio') {
            if (data[el.name] === el.value) {
                el.checked = true;
                el.dispatchEvent(new Event('change'));
            }
        } else if (el.type === 'checkbox') {
            if (data[el.name] && data[el.name].includes(el.value)) {
                el.checked = true;
            }
        } else if (el.id && data[el.id] !== undefined) {
            el.value = data[el.id];
        }
    });
    if (data.invertebrados && data.invertebrados.length > 0) {
        const container = document.getElementById('invertebrados-container');
        container.innerHTML = '';
        data.invertebrados.forEach(item => {
            addInvertebradoRow('invertebrados-container');
            const newRow = container.lastElementChild;
            newRow.querySelector('input[type="text"]').value = item.nome;
            newRow.querySelector('.quantity-v').value = item.qtd_v;
            newRow.querySelector('.quantity-c').value = item.qtd_c;
        });
    }
    if (data.vertebrados && data.vertebrados.length > 0) {
        const container = document.getElementById('vertebrados-container');
        container.innerHTML = '';
        data.vertebrados.forEach(item => {
            addVertebradoRow('vertebrados-container');
            const newRow = container.lastElementChild;
            newRow.querySelector('input[type="text"]').value = item.nome;
            newRow.querySelector('.quantity-v').value = item.qtd;
        });
    }
    document.querySelectorAll('input[type="checkbox"][value="Ausente"]:checked, input[name="guano_ausente"]:checked').forEach(ausenteCb => {
        ausenteCb.dispatchEvent(new Event('change'));
    });
}


// --- LÓGICA DAS ABAS E NAVEGAÇÃO ---
const tabLinks = document.querySelectorAll(".tab-container-vertical .tab-link");
const prevTabBtn = document.getElementById('prevTabBtn');
const nextTabBtn = document.getElementById('nextTabBtn');

function openTab(evt, tabId) {
    let i, tabcontent, allTabLinks;
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    allTabLinks = document.getElementsByClassName("tab-link");
    for (i = 0; i < allTabLinks.length; i++) {
        allTabLinks[i].className = allTabLinks[i].className.replace(" active", "");
    }
    const newTab = document.getElementById(tabId);
    newTab.style.display = "block";
    if (evt) {
        evt.currentTarget.className += " active";
    } else {
        for(let link of allTabLinks){
            if(link.onclick.toString().includes(tabId)){
                link.className += " active";
            }
        }
    }
    const accordionsInNewTab = newTab.querySelectorAll('.accordion');
    accordionsInNewTab.forEach(acc => {
        acc.classList.remove('active');
        const panel = acc.nextElementSibling;
        if (panel) {
            panel.classList.remove('show');
        }
    });
    updateNavButtons();
}

function updateNavButtons() {
    let currentIdx = -1;
    tabLinks.forEach((link, idx) => {
        if(link.classList.contains('active')) {
            currentIdx = idx;
        }
    });
    prevTabBtn.disabled = (currentIdx <= 0);
    nextTabBtn.disabled = (currentIdx >= tabLinks.length - 1);
}

prevTabBtn.addEventListener('click', () => {
    let currentIdx = -1;
    tabLinks.forEach((link, idx) => {
        if(link.classList.contains('active')) {
            currentIdx = idx;
        }
    });
    if(currentIdx > 0) {
        tabLinks[currentIdx - 1].click();
    }
});
nextTabBtn.addEventListener('click', () => {
    let currentIdx = -1;
    tabLinks.forEach((link, idx) => {
        if(link.classList.contains('active')) {
            currentIdx = idx;
        }
    });
    if(currentIdx < tabLinks.length - 1) {
        tabLinks[currentIdx + 1].click();
    }
});
// --- LÓGICA DO ACORDEÃO ---
document.querySelectorAll('.accordion').forEach(button => {
    button.addEventListener('click', () => {
        const panel = button.nextElementSibling;
        const wasActive = button.classList.contains('active');
        if (button.parentElement.classList.contains('tab-content') || button.parentElement.classList.contains('panel')) {
            const parentContainer = button.parentElement;
            parentContainer.querySelectorAll(':scope > .accordion').forEach(otherButton => {
                if (otherButton !== button) {
                    otherButton.classList.remove('active');
                    otherButton.nextElementSibling.classList.remove('show');
                }
            });
        }
        button.classList.toggle('active', !wasActive);
        panel.classList.toggle('show', !wasActive);
    });
});
// --- LÓGICA PARA CAMPO CONDICIONAL (DRENAGEM) ---
function toggleDrenagem(show) {
    document.getElementById('drenagem_proximidade_group').style.display = show ? 'block' : 'none';
}

// --- LÓGICA PARA LINHAS DINÂMICAS ---
function addInvertebradoRow(containerId) {
    const container = document.getElementById(containerId);
    const newRow = document.createElement('div');
    newRow.className = 'invertebrado-entry';
    newRow.innerHTML = `
        <div><input type="text" placeholder="Nome do táxon"></div>
        <div class="invertebrado-counters">
            <label class="counter-label">V</label>
            <div class="quantity-stepper">
                <button type="button" onclick="changeQuantity(this, -1)">-</button>
                <input type="number" value="0" min="0" class="quantity-v">
                <button type="button" onclick="changeQuantity(this, 1)">+</button>
            </div>
            <label class="counter-label">C</label>
            <div class="quantity-stepper">
                <button type="button" onclick="changeQuantity(this, -1)">-</button>
                <input type="number" value="0" min="0" class="quantity-c">
                <button type="button" onclick="changeQuantity(this, 1)">+</button>
            </div>
        </div>
    `;
    container.appendChild(newRow);
}

function addVertebradoRow(containerId) {
    const container = document.getElementById(containerId);
    const newRow = document.createElement('div');
    newRow.className = 'dynamic-row';
    newRow.innerHTML = `
        <input type="text" placeholder="Nome do táxon">
        <div class="quantity-stepper">
            <button type="button" onclick="changeQuantity(this, -1)">-</button>
            <input type="number" value="1" min="0" class="quantity-v">
            <button type="button" onclick="changeQuantity(this, 1)">+</button>
        </div>
    `;
    container.appendChild(newRow);
}

function changeQuantity(btn, amount) {
    const input = btn.parentElement.querySelector('input');
    let currentValue = parseInt(input.value);
    currentValue = isNaN(currentValue) ? 0 : currentValue;
    if (currentValue + amount >= 0) {
        input.value = currentValue + amount;
    }
}

// --- LÓGICA DE VALIDAÇÃO ---
function validateFormAndAlert() {
    const fields = [
        { id: 'projeto_localidade', name: 'Projeto/Localidade' },
        { id: 'nome_cavidade', name: 'Nome da cavidade' },
        { id: 'data', name: 'Data' },
        { id: 'horario', name: 'Horário (início)' },
        { id: 'estacao', name: 'Estação' },
        { id: 'clima', name: 'Clima' },
        { id: 'equipe', name: 'Equipe' },
        { id: 'posicao_vertente', name: 'Posição na vertente' },
        { id: 'declividade', name: 'Declividade' },
        { id: 'inclinacao_piso', name: 'Inclinação predominante do piso' },
        { id: 'umidade', name: 'Umidade' },
        { id: 'horario_termino', name: 'Horário (término)'}
    ];

    for (const field of fields) {
        const el = document.getElementById(field.id);
        if (!el) continue;

        let isEmpty = false;
        if (el.tagName.toLowerCase() === 'select') {
            if (el.value === '' || el.selectedIndex === 0) isEmpty = true;
        } else {
            if (!el.value.trim()) isEmpty = true;
        }

        if (isEmpty) {
            const tabPane = el.closest('.tab-content');
            if (tabPane) {
                const tabButton = document.querySelector(`.tab-link[onclick*="${tabPane.id}"]`);
                if (tabButton) tabButton.click();
            }
            setTimeout(() => {
                alert(`O campo "${field.name}" é obrigatório.`);
                el.focus();
                el.style.border = '2px solid red';
                setTimeout(() => { el.style.border = ''; }, 3000);
            }, 100);
            return false;
        }
    }

    const checkboxGroups = [
        { containerId: 'vegetacao-group', name: 'Vegetação' },
        { containerId: 'sedimentos-group', name: 'Sedimentos Clásticos' },
        { containerId: 'hidrologia-group', name: 'Hidrologia' },
        { containerId: 'recursos-group', name: 'Recursos encontrados' },
        { containerId: 'guano-grid', name: 'Tipos e Estados de Guano' },
        { containerId: 'agentes-transportadores-group', name: 'Agentes Transportadores' }
    ];

     for (const group of checkboxGroups) {
        const container = document.getElementById(group.containerId);
        const isChecked = container.querySelector('input[type="checkbox"]:checked');
        if (!isChecked) {
            const tabPane = container.closest('.tab-content');
            if (tabPane) {
                const tabButton = document.querySelector(`.tab-link[onclick*="${tabPane.id}"]`);
                if (tabButton) tabButton.click();
            }
             setTimeout(() => {
                alert(`Pelo menos uma opção deve ser selecionada em "${group.name}".`);
                container.scrollIntoView({ behavior: 'smooth', block: 'center' });
             }, 100);
            return false;
        }
    }
    return true;
}


// --- LÓGICA PARA GPS, FOTOS E EXPORTAÇÃO ---
let capturedPhotos = [];
function getGPS() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            const longitude = pos.coords.longitude;
            const latitude = pos.coords.latitude;
            const altitudeValue = pos.coords.altitude ? pos.coords.altitude.toFixed(2) : '';

            const sourceProjection = 'EPSG:4326'; 
            const destProjection = 'EPSG:31983'; 
            proj4.defs(destProjection, '+proj=utm +zone=23 +south +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs');
            
            const [easting, northing] = proj4(sourceProjection, destProjection, [longitude, latitude]);
            
            const utmZoneLetter = '23K'; 
            const eastingValue = easting.toFixed(2);
            const northingValue = northing.toFixed(2);

            // Preenche o campo visível para o usuário
            let formattedCoords = `${utmZoneLetter} ${eastingValue} m E ${northingValue} m S`;
            if (altitudeValue) {
                formattedCoords += `, Altitude: ${altitudeValue}m`;
            }
            document.getElementById('coordenadas').value = formattedCoords;

            // Preenche os campos ocultos com os dados separados para a exportação
            document.getElementById('utm_zone').value = utmZoneLetter;
            document.getElementById('utm_easting').value = eastingValue;
            document.getElementById('utm_northing').value = northingValue;
            document.getElementById('utm_altitude').value = altitudeValue;

        }, err => alert(`Erro ao obter GPS: ${err.message}`));
    } else {
        alert('Geolocalização não é suportada por este navegador.');
    }
}

document.getElementById('take-photo-btn').addEventListener('click', () => document.getElementById('photo-input').click());

document.getElementById('photo-input').addEventListener('change', function(event) {
    const files = event.target.files;
    if (!files.length) return;
    const cavidadeBase = document.getElementById('nome_cavidade').value.trim() || 'sem_nome';
    const dataValue = document.getElementById('data').value.trim() || 'sem_data';
    if (cavidadeBase === 'sem_nome' || dataValue === 'sem_data') {
        alert('Preencha "Nome da cavidade" e "Data" antes de tirar fotos.');
        event.target.value = '';
        return;
    }
    const sanitizedCavidade = cavidadeBase.replace(/[^a-z0-9.-]/gi, '_');
    const formattedData = dataValue.replace(/-/g, '');
    const filenameBase = `${sanitizedCavidade}_${formattedData}`;
    let photoCounter = capturedPhotos.filter(p => p.name.startsWith(filenameBase)).length + 1;
    Array.from(files).forEach(file => {
        const filename = `${filenameBase}_(${photoCounter++}).jpg`;
        capturedPhotos.push({ name: filename, blob: file });
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        document.getElementById('photo-previews').appendChild(img);
    });
    event.target.value = '';
});

function downloadFile(filename, content, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.setAttribute("download", filename);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

document.getElementById('exportButton').addEventListener('click', async function() {
    if (!validateFormAndAlert()) {
        return;
    }

    const form = document.getElementById('bioForm');
    const sanitize = (text) => (text || '').replace(/[^a-z0-9]/gi, '_').toLowerCase();
    const cavidadeNomeSanitized = sanitize(document.getElementById('nome_cavidade').value.trim());
    const dataNome = (document.getElementById('data').value || '').replace(/-/g, '');
    
    const baseFilename = `${cavidadeNomeSanitized}_${dataNome}`;
    const zip = new JSZip();

    const generateTextFileContent = () => {
        const getValue = (id) => document.getElementById(id)?.value || '';
        const getSelectedText = (id) => {
            const select = document.getElementById(id);
            return (select && select.selectedIndex > 0) ? select.options[select.selectedIndex].text : '';
        };
        const getSelectedValue = (name) => document.querySelector(`input[name="${name}"]:checked`)?.value || '';
        const getCheckboxValues = (groupId) => Array.from(document.querySelectorAll(`#${groupId} input[type="checkbox"]:checked`)).map(cb => cb.value);

        const data = {
            nomeCavidade: getValue('nome_cavidade').toUpperCase(),
            declividade: getSelectedText('declividade').toLowerCase(),
            posicaoVertente: getSelectedText('posicao_vertente').toLowerCase(),
            vegetacao: getCheckboxValues('vegetacao-group'),
            distanciaDrenagem: getValue('drenagem_proximidade'),
            drenagem: getSelectedValue('drenagem'),
            inclinacaoPiso: getSelectedText('inclinacao_piso').toLowerCase(),
            sedimentos: getCheckboxValues('sedimentos-group'),
            umidade: getSelectedText('umidade'),
            estacao: getSelectedText('estacao').toLowerCase(),
            hidrologia: getCheckboxValues('hidrologia-group'),
            zonacao: {
                eufotica: getValue('zonacao_eufotica'),
                disfotica: getValue('zonacao_disfotica'),
                afotica: getValue('zonacao_afotica')
            },
            recursos: getCheckboxValues('recursos-group'),
            outrosRecursos: getValue('outros_recursos'),
            guanoAusente: document.querySelector('input[name="guano_ausente"]:checked'),
            guano: {},
            aporte: getCheckboxValues('agentes-transportadores-group'),
            alteracoes: []
        };
        const guanoTypes = ['frugivoros', 'hematofagos', 'insetivoros', 'nectarivoros'];
        guanoTypes.forEach(type => {
            const states = Array.from(document.querySelectorAll(`input[name="guano_${type.slice(0,-1)}_estado"]:checked`)).map(cb => cb.value);
            if (states.length > 0) data.guano[type] = states;
        });
        if (getSelectedValue('pisoteio') === 'Presença') data.alteracoes.push('pisoteio');
        if (getSelectedValue('lixo') === 'Presença') data.alteracoes.push('lixo');
        if (getSelectedValue('poeira') === 'Presença') data.alteracoes.push('poeira');

        const vazio = '<span style="background-color:yellow;">[vazio]</span>';
        const formatList = (items, replaceMap = {}) => {
            if (!items || items.length === 0 || (items.length === 1 && items[0].toLowerCase() === 'ausente')) return vazio;
            const processedItems = items.map(item => (replaceMap[item] || item).toLowerCase());
            if (processedItems.length === 1) return processedItems[0];
            if (processedItems.length === 2) return `${processedItems[0]} e ${processedItems[1]}`;
            return `${processedItems.slice(0, -1).join(', ')} e ${processedItems.slice(-1)}`;
        };

        let s1 = `A cavidade ${data.nomeCavidade || '[N/A]'} está situada em uma área de declividade ${data.declividade.replace(' ', ' e ') || vazio} na ${data.posicaoVertente || '[N/A]'} vertente.`;
        let s2 = `O entorno é composto por vegetação de porte ${formatList(data.vegetacao)}`;
        if (data.drenagem === 'Presença' && data.distanciaDrenagem) {
            s2 += `, e a localização fica a aproximadamente ${data.distanciaDrenagem} metros de uma drenagem ativa.`;
        } else { s2 += `.`; }
        let s3_4 = `A inclinação interna é predominantemente ${data.inclinacaoPiso || vazio}, com o piso formado por ${formatList(data.sedimentos, {'Argila/Silte': 'sedimentos argilo-arenosos', 'Seixo': 'seixos', 'Matacão': 'matacões'})}.`;
        let umidadeTxt = data.umidade === 'Presença' ? 'úmida' : (data.umidade === 'Ausência' ? 'seca' : vazio);
        let estacaoTxt = data.estacao ? ` na estação ${data.estacao}` : '';
        let s5_6;
        if (data.hidrologia.length === 0 || data.hidrologia.some(h => h.toLowerCase() === 'ausente')) {
            s5_6 = `Encontrava-se ${umidadeTxt}${estacaoTxt} e não foram observados processos hidrológicos ativos.`;
        } else {
            s5_6 = `Encontrava-se ${umidadeTxt}${estacaoTxt}, apresentando processos hidrológicos como ${formatList(data.hidrologia)}.`;
        }
        let lumParts = [];
        if(data.zonacao.eufotica) lumParts.push(`eufótica (${data.zonacao.eufotica}%)`);
        if(data.zonacao.disfotica) lumParts.push(`penumbra (${data.zonacao.disfotica}%)`);
        if(data.zonacao.afotica) lumParts.push(`afótica (${data.zonacao.afotica}%)`);
        let s7 = `Em relação à luminosidade, a cavidade pode ser dividida nas zonas ${lumParts.length > 0 ? formatList(lumParts) : vazio}.`;
        let recursosList = [...data.recursos];
        if (data.outrosRecursos) {
            const outros = data.outrosRecursos.split('\n').filter(item => item.trim() !== '');
            recursosList.push(...outros);
        }
        let s8;
        const chunkSize = 4;
        if (!recursosList || recursosList.length === 0 || (recursosList.length === 1 && recursosList[0].toLowerCase() === 'ausente')) {
            s8 = `Os recursos orgânicos são representados por ${vazio}.`;
        } else {
            const firstChunk = recursosList.slice(0, chunkSize);
            s8 = `Os recursos orgânicos são representados por ${formatList(firstChunk)}.`;
            const remainingChunk = recursosList.slice(chunkSize);
            if (remainingChunk.length > 0) {
                if (remainingChunk.length === 1) {
                    const item = remainingChunk[0];
                    const capitalizedItem = item.charAt(0).toUpperCase() + item.slice(1);
                    s8 += ` ${capitalizedItem} também foi observado.`;
                } else {
                    s8 += ` Também foram observados ${formatList(remainingChunk)}.`;
                }
            }
        }
        let s9 = '';
        if (data.guanoAusente || Object.keys(data.guano).length === 0) {
            s9 = `Guano: ${vazio}.`;
        } else {
            let guanoParts = [];
            for (const tipo in data.guano) {
                guanoParts.push(`${tipo.slice(0, -1)}s (${data.guano[tipo].join(', ')})`);
            }
            s9 = `Foi identificado guano de morcegos ${formatList(guanoParts)}.`;
        }
        let s10 = `Os recursos tróficos chegam pela ação de ${formatList(data.aporte)}.`;
        let s11 = `Alterações antrópicas são representadas por ${formatList(data.alteracoes)}.`;
        const fullText = [s1, s2, s3_4, s5_6, s7, s8, s9, s10, s11].join(' ');
        const htmlContent = `<!DOCTYPE html><html lang="pt-br"><head><meta charset="UTF-8"><title>${data.nomeCavidade || 'Relatório'}</title><style>body{font-family:Arial,sans-serif;}</style></head><body><p>${fullText}</p></body></html>`;
        return htmlContent;
    };
    
    const generateCsvFilesContent = () => {
        let allDataTemp = {};
        const orderedKeys = [
            'Data', 'Horário (início)', 'Horário (término)', 'Projeto/Localidade', 'Nome da cavidade', 'Estação', 'Clima', 'Equipe', 
            'Zona', 'E', 'N', 'Altitude',
            'Posição na vertente', 'Declividade', 'Drenagem Ativa', 'Proximidade da drenagem', 'Vegetação',
            'Inclinação predominante do piso', 'Sedimentos Clásticos', 'Umidade', 'Hidrologia', 'Luminosidade', 'Eppendorf', 'Falcon',
            'Pisoteio', 'Lixo', 'Poeira',
            'Recursos encontrados', 'Outros Recursos (Adicionar)',
            'Guano', 'Guano Frugívoros', 'Guano Hematófagos', 'Guano Insetívoros', 'Guano Nectarívoros',
            'Agentes Transportadores',
            'Observações Gerais'
        ];
        form.querySelectorAll('input[type="text"], input[type="date"], input[type="time"], input[type="tel"], input[type="number"], textarea, select, input[type="hidden"]').forEach(el => {
            if (el.id === 'coordenadas') return;
            let label = el.closest('.form-group')?.querySelector('label')?.innerText.replace(/:$/, '') || el.name || el.id;
            if (el.id === 'utm_zone') label = 'Zona';
            if (el.id === 'utm_easting') label = 'E';
            if (el.id === 'utm_northing') label = 'N';
            if (el.id === 'utm_altitude') label = 'Altitude';
            if (el.value && (el.type !== 'number' || el.value !== '0')) {
                 allDataTemp[label] = el.value;
            }
        });
        form.querySelectorAll('input[type="radio"]:checked').forEach(el => {
            let labelText = el.closest('.form-group')?.querySelector('label')?.innerText.replace(/:$/, '') || el.name.charAt(0).toUpperCase() + el.name.slice(1);
            allDataTemp[labelText] = el.value;
        });
        const checkboxes = {};
        form.querySelectorAll('input[type="checkbox"]:checked').forEach(el => {
            if (el.name === 'guano_ausente') return;
            let name = el.closest('.panel, .form-group')?.previousElementSibling?.innerText.replace(/:$/, '') || el.closest('.form-group')?.querySelector('label')?.innerText.replace(/:$/, '') || el.name;
            if (!checkboxes[name]) checkboxes[name] = [];
            checkboxes[name].push(el.value);
        });
        for (const [key, value] of Object.entries(checkboxes)) {
            allDataTemp[key] = value;
        }
        const guanoAusenteCheckbox = document.querySelector('input[name="guano_ausente"]');
        if (guanoAusenteCheckbox && guanoAusenteCheckbox.checked) {
            allDataTemp['Guano'] = 'ausente';
        } else {
            const guanoTypes = ['frugivoro', 'hematofago', 'insetivoro', 'nectarivoro'];
            guanoTypes.forEach(type => {
                const states = [];
                document.querySelectorAll(`input[name="guano_${type}_estado"]:checked`).forEach(cb => states.push(cb.value));
                if (states.length > 0) {
                    allDataTemp[`Guano ${type.charAt(0).toUpperCase() + type.slice(1)}s`] = states;
                }
            });
        }
        
        let principalHeaders = [], principalValues = [];
        orderedKeys.forEach(key => {
            if (allDataTemp[key] !== undefined) {
                principalHeaders.push(key);
                let value = Array.isArray(allDataTemp[key]) ? allDataTemp[key].join(', ') : allDataTemp[key];
                principalValues.push(`"${String(value).replace(/"/g, '""')}"`);
            }
        });
        
        const principalCsvContent = (principalHeaders.length > 0) ? `\uFEFF${principalHeaders.join(';')}\n${principalValues.join(';')}` : null;
        
        let taxonRows = [];
        const clean = val => `"${String(val).replace(/"/g, '""')}"`;
        const estacao = form.querySelector('select[name="estacao"]')?.value || '';
        const projeto = document.getElementById('projeto_localidade').value.trim();
        const data = document.getElementById('data').value.trim();
        const horario = document.getElementById('horario').value.trim();
        const cavidade = document.getElementById('nome_cavidade').value.trim();
        const zona = document.getElementById('utm_zone').value.trim();
        const easting = document.getElementById('utm_easting').value.trim();
        const northing = document.getElementById('utm_northing').value.trim();
        const altitude = document.getElementById('utm_altitude').value.trim();

        form.querySelectorAll('#invertebrados-container .invertebrado-entry').forEach(row => {
            const nome = row.querySelector('input[type="text"]').value;
            const qtd_v = row.querySelector('.quantity-v').value;
            const qtd_c = row.querySelector('.quantity-c').value;
            if (nome && (parseInt(qtd_v, 10) > 0 || parseInt(qtd_c, 10) > 0)) {
                taxonRows.push([clean(data), clean(horario), clean(projeto), clean(cavidade), clean(zona), clean(easting), clean(northing), clean(altitude), clean(estacao), 'Invertebrado', clean(nome), clean(qtd_v), clean(qtd_c)].join(';'));
            }
        });
        form.querySelectorAll('#vertebrados-container .dynamic-row').forEach(row => {
            const nome = row.querySelector('input[type="text"]').value;
            const qtd = row.querySelector('.quantity-v').value;
            if (nome && parseInt(qtd, 10) > 0) {
                taxonRows.push([clean(data), clean(horario), clean(projeto), clean(cavidade), clean(zona), clean(easting), clean(northing), clean(altitude), clean(estacao), 'Vertebrado', clean(nome), clean(qtd), ''].join(';'));
            }
        });
        
        const taxonCsvHeader = 'Data;Horário;Projeto/Localidade;Nome da cavidade;Zona;E;N;Altitude;Estação;Grupo;Táxon;Quantidade_V;Quantidade_C';
        const taxonCsvContent = (taxonRows.length > 0) ? `\uFEFF${taxonCsvHeader}\n${taxonRows.join('\n')}` : null;

        return { principalCsvContent, taxonCsvContent };
    };

    const csvContents = generateCsvFilesContent();
    if (csvContents.principalCsvContent) {
        zip.file(`${baseFilename}_principal.csv`, csvContents.principalCsvContent);
    }
    if (csvContents.taxonCsvContent) {
        zip.file(`${baseFilename}_taxons.csv`, csvContents.taxonCsvContent);
    }
    
    zip.file(`${baseFilename}_texto.html`, generateTextFileContent());
    capturedPhotos.forEach(photo => {
        zip.file(photo.name, photo.blob);
    });
    zip.generateAsync({ type: "blob" }).then(function(content) {
        downloadFile(`${baseFilename}.zip`, content, 'application/zip');
        localStorage.removeItem('bioFormData');
        capturedPhotos = [];
        document.getElementById('photo-previews').innerHTML = '';
    });
});

// --- LÓGICA PARA LIMPAR O FORMULÁRIO ---
document.getElementById('clearButton').addEventListener('click', function() {
    if (confirm('Tem certeza de que deseja limpar todos os dados da ficha? Esta ação não pode ser desfeita.')) {
        document.getElementById('bioForm').reset();
        document.getElementById('photo-previews').innerHTML = '';
        capturedPhotos = [];
        localStorage.removeItem('bioFormData');
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.disabled = false;
        });
        document.getElementById('invertebrados-container').innerHTML = '';
        document.getElementById('vertebrados-container').innerHTML = '';
        addInvertebradoRow('invertebrados-container');
        addVertebradoRow('vertebrados-container');
        toggleDrenagem(false);
        openTab(null, 'tabDadosGerais');
        updateNavButtons();
        alert('Ficha limpa com sucesso!');
    }
});


// --- LÓGICAS DE INICIALIZAÇÃO E INTERAÇÃO ---
document.addEventListener('DOMContentLoaded', (event) => {
    loadDataFromLocal();
    openTab(null, 'tabDadosGerais'); 
    if (document.getElementById('invertebrados-container').children.length === 0) {
        addInvertebradoRow('invertebrados-container');
    }
    if (document.getElementById('vertebrados-container').children.length === 0) {
        addVertebradoRow('vertebrados-container');
    }
    updateNavButtons();

    document.getElementById('bioForm').addEventListener('input', saveDataToLocal);

    function setupExclusiveAusenteCheckbox(groupId, ausenteValue) {
        const group = document.getElementById(groupId);
        if (!group) return;
        const allCheckboxes = group.querySelectorAll('input[type="checkbox"]');
        const ausenteCheckbox = group.querySelector(`input[value="${ausenteValue}"]`);
        if (!ausenteCheckbox) return;
        allCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const isAusente = e.target.value === ausenteValue;
                const isChecked = e.target.checked;
                if (isAusente && isChecked) {
                    allCheckboxes.forEach(cb => {
                        if (cb.value !== ausenteValue) {
                            cb.checked = false;
                            cb.disabled = true;
                        }
                    });
                } else if (isAusente && !isChecked) {
                    allCheckboxes.forEach(cb => {
                        cb.disabled = false;
                    });
                } else if (!isAusente && isChecked) {
                    ausenteCheckbox.checked = false;
                    allCheckboxes.forEach(cb => {
                        cb.disabled = false;
                    });
                }
            });
        });
    }

    setupExclusiveAusenteCheckbox('sedimentos-group', 'Ausente');
    setupExclusiveAusenteCheckbox('recursos-group', 'Ausente');
    setupExclusiveAusenteCheckbox('vegetacao-group', 'Ausente');
    setupExclusiveAusenteCheckbox('hidrologia-group', 'Ausente');

    const guanoGrid = document.getElementById('guano-grid');
    const guanoAusente = guanoGrid.querySelector('input[name="guano_ausente"]');
    const otherGuanoCheckboxes = guanoGrid.querySelectorAll('.guano-grid input[type="checkbox"]');
    guanoAusente.addEventListener('change', (e) => {
        if (e.target.checked) {
            otherGuanoCheckboxes.forEach(cb => {
                cb.checked = false;
                cb.disabled = true;
            });
        } else {
            otherGuanoCheckboxes.forEach(cb => {
                cb.disabled = false;
            });
        }
    });
    otherGuanoCheckboxes.forEach(cb => {
        cb.addEventListener('change', (e) => {
            if (e.target.checked) {
                guanoAusente.checked = false;
                otherGuanoCheckboxes.forEach(other_cb => {
                    other_cb.disabled = false;
                });
            }
        });
    });
});
</script>

</body>
</html>
