<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subterrânea - Bioespeleologia</title>
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --light-gray: #f4f4f4;
            --medium-gray: #ddd;
            --dark-gray: #555;
            --white: #fff;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--light-gray);
            font-size: 16px;
            line-height: 1.5;
            padding-bottom: 80px;
        }
        .main-layout { display: flex; align-items: flex-start; }
        .container {
            max-width: 900px;
            width: 100%;
            margin: 10px;
            background: var(--white);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            flex-grow: 1;
        }
        h2 {
            font-size: 18px;
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 5px;
            margin-top: 20px;
            margin-bottom: 15px;
        }
        .tab-container-vertical {
            display: flex;
            flex-direction: column;
            background-color: #fff;
            min-width: 65px;
            position: sticky;
            top: 0;
            height: 100vh;
            align-self: flex-start;
            border-right: 1px solid var(--medium-gray);
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            padding-top: 10px;
        }
        .tab-link {
            background-color: inherit;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 15px 10px;
            transition: 0.3s;
            font-size: 14px;
            writing-mode: vertical-lr; 
            transform: rotate(180deg);
            text-align: center;
            border-left: 4px solid transparent;
            width: 100%;
            color: var(--dark-gray);
            font-weight: 500;
        }
        .tab-link:hover { background-color: var(--light-gray); }
        .tab-link.active {
            background-color: var(--light-gray);
            border-left: 4px solid var(--secondary-color);
            font-weight: bold;
            color: var(--secondary-color);
        }
        #clearButton {
            background-color: var(--danger-color);
            writing-mode: initial;
            transform: none;
            color: white;
            margin: 0 5px 15px 5px;
            border-radius: 4px;
            padding: 8px;
            border: none;
            cursor: pointer;
            width: calc(100% - 10px);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 6px; color: #333; }
        input[type="text"], input[type="date"], input[type="time"], input[type="number"], select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
            font-size: 16px;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
        }
        .grid-columns-3 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .options-group { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 10px; }
        .option-item { display: flex; align-items: center; gap: 8px; }
        .option-item label { font-weight: normal; margin-bottom: 0; }
        .guano-grid, .impact-grid {
            display: grid;
            gap: 10px;
            align-items: center;
            font-size: 14px;
        }
        .guano-grid { grid-template-columns: 2fr repeat(3, 1fr); }
        .impact-grid { grid-template-columns: 2fr repeat(2, 1fr); text-align: center; }
        .grid-header { font-weight: bold; text-align: center; }
        .grid-cell { text-align: center; }
        .dynamic-row { 
            padding-bottom: 15px; 
            margin-bottom: 15px; 
            border-bottom: 1px solid var(--light-gray); 
        }
        .dynamic-row:last-child { border-bottom: none; }
        .quantity-stepper-wrapper { display: flex; gap: 20px; margin-top: 8px; }
        .quantity-stepper { display: flex; align-items: center; }
        .quantity-stepper label { font-weight: bold; margin-right: 5px; }
        .quantity-stepper button, .dynamic-row button { width: 30px; height: 30px; border: 1px solid var(--medium-gray); background: var(--light-gray); font-size: 18px; cursor: pointer; }
        .quantity-stepper input { width: 40px; height: 30px; text-align: center; border: 1px solid var(--medium-gray); border-left: none; border-right: none; -moz-appearance: textfield; }
        .quantity-stepper input::-webkit-outer-spin-button, .quantity-stepper input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .fab {
            position: fixed;
            right: 20px;
            z-index: 1000;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            text-align: center;
        }
        .fab:hover { transform: scale(1.05); }
        #take-photo-btn { background-color: var(--secondary-color); bottom: 150px; }
        #saveButton { background-color: var(--success-color); bottom: 80px; }
        #photo-previews { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px; }
        .photo-preview-item { position: relative; }
        .photo-preview-item img { width: 100px; height: 100px; border-radius: 4px; border: 2px solid var(--medium-gray); object-fit: cover; }
        .remove-photo-btn { position: absolute; top: -5px; right: -5px; background: var(--danger-color); color: white; border: none; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; font-weight: bold; }
        .navigation-arrows {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background-color: var(--light-gray);
            border-top: 1px solid var(--medium-gray);
            z-index: 999;
        }
        .navigation-arrows button {
            width: 48%;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
            background-color: var(--white);
        }
        .navigation-arrows button:disabled {
            background-color: #e9e9e9;
            color: #aaa;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

<div class="main-layout">
    <div class="tab-container-vertical">
        <button id="clearButton" title="Limpar todo o formulário">Limpar</button>
        <button class="tab-link active" onclick="openTab(event, 'tabDadosGerais')">Dados gerais</button>
        <button class="tab-link" onclick="openTab(event, 'tabCaracteristicas')">Caract. externas</button>
        <button class="tab-link" onclick="openTab(event, 'tabDescricao')">Descr. da cavidade</button>
        <button class="tab-link" onclick="openTab(event, 'tabRecursos')">Recursos</button>
        <button class="tab-link" onclick="openTab(event, 'tabGuano')">Guano</button>
        <button class="tab-link" onclick="openTab(event, 'tabAlteracoes')">Alterações</button>
        <button class="tab-link" onclick="openTab(event, 'tabTaxons')">Táxons</button>
        <button class="tab-link" onclick="openTab(event, 'tabMaterialColetado')">Material coletado</button>
        <button class="tab-link" onclick="openTab(event, 'tabObservacoes')">Obs.</button>
    </div>

    <div class="container">
        <form id="bioForm">
            <div id="tabDadosGerais" class="tab-content active">
                <h2>Dados Gerais</h2>
                <div class="form-group"><label for="projeto_localidade">Projeto/Localidade</label><input type="text" id="projeto_localidade" name="projeto_localidade"></div>
                <div class="form-group"><label for="equipe">Equipe</label><input type="text" id="equipe" name="equipe"></div>
                <div class="form-group"><label for="nome_cavidade">Nome da cavidade</label><input type="text" id="nome_cavidade" name="nome_cavidade"></div>
                <div class="form-group"><label for="data">Data</label><input type="date" id="data" name="data"></div>
                <div class="form-group"><label for="horario_inicio">Horário (início)</label><input type="time" id="horario_inicio" name="horario_inicio"></div>
                <div class="form-group"><label>Estação</label><div class="options-group"><div class="option-item"><input type="radio" name="estacao" value="Seca" id="est_seca"><label for="est_seca">Seca</label></div><div class="option-item"><input type="radio" name="estacao" value="Chuvosa" id="est_chuvosa"><label for="est_chuvosa">Chuvosa</label></div></div></div>
                <div class="form-group"><label>Clima</label><div class="options-group"><div class="option-item"><input type="radio" name="clima" value="Ensolarado" id="clima_sol"><label for="clima_sol">Ensolarado</label></div><div class="option-item"><input type="radio" name="clima" value="Nublado" id="clima_nublado"><label for="clima_nublado">Nublado</label></div><div class="option-item"><input type="radio" name="clima" value="Chuvoso" id="clima_chuva"><label for="clima_chuva">Chuvoso</label></div></div></div>
                <div class="form-group"><label for="coordenadas">Coordenadas (UTM 23S, WGS84)</label><input type="text" id="coordenadas" name="coordenadas"><button type="button" onclick="getGPS()" style="margin-top: 5px; padding: 8px;">Obter GPS</button></div>
                <div class="form-group"><label for="altitude">Altitude (m)</label><input type="text" id="altitude" name="altitude"></div>
                <div id="photo-previews"></div>
            </div>
            <div id="tabCaracteristicas" class="tab-content">
                <h2>Caract. externas</h2>
                <div class="form-group"><label>Posição na vertente</label><div class="options-group"><div class="option-item"><input type="radio" name="posicao_vertente" value="Alta"><label>Alta</label></div><div class="option-item"><input type="radio" name="posicao_vertente" value="Média"><label>Média</label></div><div class="option-item"><input type="radio" name="posicao_vertente" value="Baixa"><label>Baixa</label></div></div></div>
                <div class="form-group"><label>Declividade</label><select name="declividade"><option value="" disabled selected>Selecione</option><option value="plana">Plana</option><option value="suave e ondulada">Suave Ondulada</option><option value="ondulada">Ondulada</option><option value="forte e ondulada">Forte Ondulada</option><option value="montanhosa">Montanhosa</option><option value="escarpada">Escarpada</option></select></div>
                <div class="form-group"><label>Drenagem ativa</label><div class="options-group"><div class="option-item"><input type="radio" name="drenagem_ativa" value="Ausente" checked onchange="toggleConditionalText(this, 'drenagem_presenca_texto', true)"><label>Ausente</label></div><div class="option-item"><input type="radio" name="drenagem_ativa" value="Presença" onchange="toggleConditionalText(this, 'drenagem_presenca_texto', false)"><label>Presença:</label><input type="text" id="drenagem_presenca_texto" name="drenagem_presenca_texto" disabled></div></div></div>
                <div class="form-group"><label>Vegetação</label><div class="option-item"><input type="checkbox" id="vegetacao_ausente" name="vegetacao" value="Ausente" onchange="handleAusente(this, 'vegetacao_opcoes')"><label for="vegetacao_ausente">Ausente</label></div><div id="vegetacao_opcoes" class="options-group"><div class="option-item"><input type="checkbox" name="vegetacao" value="rasteira" onchange="uncheckAusente(this, 'vegetacao_ausente')"><label>Rasteira</label></div><div class="option-item"><input type="checkbox" name="vegetacao" value="arbustos" onchange="uncheckAusente(this, 'vegetacao_ausente')"><label>Arbusto</label></div><div class="option-item"><input type="checkbox" name="vegetacao" value="árvores" onchange="uncheckAusente(this, 'vegetacao_ausente')"><label>Árvore</label></div></div></div>
            </div>
            <div id="tabDescricao" class="tab-content">
                <h2>Descr. da cavidade</h2>
                <div class="form-group"><label>Inclinação predominante do piso</label><div class="options-group"><div class="option-item"><input type="radio" name="inclinacao_piso" value="ascendente"><label>Ascendente</label></div><div class="option-item"><input type="radio" name="inclinacao_piso" value="descendente"><label>Descendente</label></div><div class="option-item"><input type="radio" name="inclinacao_piso" value="plana"><label>Plana</label></div></div></div>
                <div class="form-group"><label>Sedimentos clásticos</label><div class="option-item"><input type="checkbox" id="sedimentos_ausente" name="sedimentos" value="Ausente" onchange="handleAusente(this, 'sedimentos_opcoes')"><label for="sedimentos_ausente">Ausente</label></div><div id="sedimentos_opcoes" class="options-group"><div class="option-item"><input type="checkbox" name="sedimentos" value="argilo" onchange="uncheckAusente(this, 'sedimentos_ausente')"><label>Argila/Silte</label></div><div class="option-item"><input type="checkbox" name="sedimentos" value="arenosos" onchange="uncheckAusente(this, 'sedimentos_ausente')"><label>Areia</label></div><div class="option-item"><input type="checkbox" name="sedimentos" value="seixos" onchange="uncheckAusente(this, 'sedimentos_ausente')"><label>Seixo</label></div><div class="option-item"><input type="checkbox" name="sedimentos" value="matacões" onchange="uncheckAusente(this, 'sedimentos_ausente')"><label>Matacão</label></div></div></div>
                <div class="form-group"><label>Umidade</label><div class="options-group"><div class="option-item"><input type="radio" name="umidade" value="úmida"><label>Presença</label></div><div class="option-item"><input type="radio" name="umidade" value="seca"><label>Ausência</label></div></div></div>
                <div class="form-group"><label>Hidrologia</label><div class="option-item"><input type="checkbox" id="hidrologia_ausente" name="hidrologia" value="Ausente" onchange="handleAusente(this, 'hidrologia_opcoes')"><label for="hidrologia_ausente">Ausente</label></div><div id="hidrologia_opcoes" class="options-group"><div class="option-item"><input type="checkbox" name="hidrologia" value="condensação" onchange="uncheckAusente(this, 'hidrologia_ausente')"><label>Condensação</label></div><div class="option-item"><input type="checkbox" name="hidrologia" value="drenagem efêmera" onchange="uncheckAusente(this, 'hidrologia_ausente')"><label>Drenagem efêmera</label></div><div class="option-item"><input type="checkbox" name="hidrologia" value="drenagem intermitente" onchange="uncheckAusente(this, 'hidrologia_ausente')"><label>Drenagem intermitente</label></div><div class="option-item"><input type="checkbox" name="hidrologia" value="drenagem perene" onchange="uncheckAusente(this, 'hidrologia_ausente')"><label>Drenagem perene</label></div><div class="option-item"><input type="checkbox" name="hidrologia" value="escorrimento" onchange="uncheckAusente(this, 'hidrologia_ausente')"><label>Escorrimento</label></div><div class="option-item"><input type="checkbox" name="hidrologia" value="empoçamento" onchange="uncheckAusente(this, 'hidrologia_ausente')"><label>Empoçamento</label></div><div class="option-item"><input type="checkbox" name="hidrologia" value="exsudação" onchange="uncheckAusente(this, 'hidrologia_ausente')"><label>Exsudação</label></div><div class="option-item"><input type="checkbox" name="hidrologia" value="gotejamento" onchange="uncheckAusente(this, 'hidrologia_ausente')"><label>Gotejamento</label></div><div class="option-item"><input type="checkbox" name="hidrologia" value="percolação" onchange="uncheckAusente(this, 'hidrologia_ausente')"><label>Percolação</label></div></div></div>
                <div class="form-group"><label>Zonação (%)</label><div class="options-group"><div class="option-item"><label for="zonacao_eufotica">Eufótica:</label><input type="number" id="zonacao_eufotica" name="zonacao_eufotica" min="0" max="100"></div><div class="option-item"><label for="zonacao_disfotica">Disfótica:</label><input type="number" id="zonacao_disfotica" name="zonacao_disfotica" min="0" max="100"></div><div class="option-item"><label for="zonacao_afotica">Afótica:</label><input type="number" id="zonacao_afotica" name="zonacao_afotica" min="0" max="100"></div></div></div>
            </div>
            <div id="tabRecursos" class="tab-content">
                <h2>Recursos</h2>
                <div class="form-group"><div class="option-item"><input type="checkbox" id="recursos_ausente" name="recursos" value="Ausente" onchange="handleAusente(this, 'recursos_opcoes')"><label for="recursos_ausente">Ausente</label></div></div>
                <div id="recursos_opcoes" class="grid-columns-3">
                    <div class="option-item"><input type="checkbox" name="recursos" value="árvore" onchange="uncheckAusente(this, 'recursos_ausente')"><label>Árvore</label></div>
                    <div class="option-item"><input type="checkbox" name="recursos" value="arbusto" onchange="uncheckAusente(this, 'recursos_ausente')"><label>Arbusto</label></div>
                    <div class="option-item"><input type="checkbox" name="recursos" value="briófita" onchange="uncheckAusente(this, 'recursos_ausente')"><label>Briófita</label></div>
                    <div class="option-item"><input type="checkbox" name="recursos" value="broto" onchange="uncheckAusente(this, 'recursos_ausente')"><label>Broto</label></div>
                    <div class="option-item"><input type="checkbox" name="recursos" value="carcaça de vertebrado" onchange="uncheckAusente(this, 'recursos_ausente')"><label>Carcaça de vertebrado</label></div>
                    <div class="option-item"><input type="checkbox" name="recursos" value="casca de ovo (vert.)" onchange="uncheckAusente(this, 'recursos_ausente')"><label>Casca de ovo (vert.)</label></div>
                    <div class="option-item"><input type="checkbox" name="recursos" value="concha de gastrópode" onchange="uncheckAusente(this, 'recursos_ausente')"><label>Concha de gastrópode</label></div>
                    <div class="option-item"><input type="checkbox" name="recursos" value="élitro de besouro" onchange="uncheckAusente(this, 'recursos_ausente')"><label>Élitro de besouro</label></div>
                    <div class="option-item"><input type="checkbox" name="recursos" value="detrito animal" onchange="uncheckAusente(this, 'recursos_ausente')"><label>Detrito animal</label></div>
                    <div class="option-item"><input type="checkbox" name="recursos" value="detrito vegetal" onchange="uncheckAusente(this, 'recursos_ausente')"><label>Detrito vegetal</label></div>
                    <div class="option-item"><input type="checkbox" name="recursos" value="fezes" onchange="uncheckAusente(this, 'recursos_ausente')"><label>Fezes</label></div>
                    <div class="option-item"><input type="checkbox" name="recursos" value="fungos" onchange="uncheckAusente(this, 'recursos_ausente')"><label>Fungos</label></div>
                    <div class="option-item"><input type="checkbox" name="recursos" value="gramíneas" onchange="uncheckAusente(this, 'recursos_ausente')"><label>Gramíneas</label></div>
                    <div class="option-item"><input type="checkbox" name="recursos" value="líquen" onchange="uncheckAusente(this, 'recursos_ausente')"><label>Líquen</label></div>
                    <div class="option-item"><input type="checkbox" name="recursos" value="material vegetal" onchange="uncheckAusente(this, 'recursos_ausente')"><label>Material vegetal</label></div>
                    <div class="option-item"><input type="checkbox" name="recursos" value="ninho (ave)" onchange="uncheckAusente(this, 'recursos_ausente')"><label>Ninho (ave)</label></div>
                    <div class="option-item"><input type="checkbox" name="recursos" value="ossada" onchange="uncheckAusente(this, 'recursos_ausente')"><label>Ossada</label></div>
                    <div class="option-item"><input type="checkbox" name="recursos" value="pena" onchange="uncheckAusente(this, 'recursos_ausente')"><label>Pena</label></div>
                    <div class="option-item"><input type="checkbox" name="recursos" value="pteridófita" onchange="uncheckAusente(this, 'recursos_ausente')"><label>Pteridófita</label></div>
                    <div class="option-item"><input type="checkbox" name="recursos" value="raiz fina" onchange="uncheckAusente(this, 'recursos_ausente')"><label>Raiz fina</label></div>
                    <div class="option-item"><input type="checkbox" name="recursos" value="raiz média" onchange="uncheckAusente(this, 'recursos_ausente')"><label>Raiz média</label></div>
                    <div class="option-item"><input type="checkbox" name="recursos" value="raiz grossa" onchange="uncheckAusente(this, 'recursos_ausente')"><label>Raiz grossa</label></div>
                    <div class="option-item"><input type="checkbox" name="recursos" value="rizotema" onchange="uncheckAusente(this, 'recursos_ausente')"><label>Rizotema</label></div>
                    <div class="option-item"><input type="checkbox" name="recursos" value="serapilheira" onchange="uncheckAusente(this, 'recursos_ausente')"><label>Serapilheira</label></div>
                </div>
            </div>
            <div id="tabGuano" class="tab-content">
                <h2>Guano</h2>
                <div class="form-group">
                    <div class="option-item"><input type="checkbox" id="guano_ausente_cb" name="guano_geral" value="Ausente" onchange="handleAusente(this, 'guano_grid_container')"><label for="guano_ausente_cb">Ausente</label></div>
                </div>
                <div id="guano_grid_container">
                    <div class="guano-grid">
                        <div class="grid-header">Tipos de guano</div>
                        <div class="grid-header">Recente</div>
                        <div class="grid-header">Antigo</div>
                        <div class="grid-header">Exaurido</div>
                        <div>Frugívoro</div>
                        <div class="grid-cell"><input type="checkbox" name="guano_frugivoro" value="recente" onchange="uncheckAusente(this, 'guano_ausente_cb')"></div>
                        <div class="grid-cell"><input type="checkbox" name="guano_frugivoro" value="antigo" onchange="uncheckAusente(this, 'guano_ausente_cb')"></div>
                        <div class="grid-cell"><input type="checkbox" name="guano_frugivoro" value="exaurido" onchange="uncheckAusente(this, 'guano_ausente_cb')"></div>
                        <div>Hematófago</div>
                        <div class="grid-cell"><input type="checkbox" name="guano_hematofago" value="recente" onchange="uncheckAusente(this, 'guano_ausente_cb')"></div>
                        <div class="grid-cell"><input type="checkbox" name="guano_hematofago" value="antigo" onchange="uncheckAusente(this, 'guano_ausente_cb')"></div>
                        <div class="grid-cell"><input type="checkbox" name="guano_hematofago" value="exaurido" onchange="uncheckAusente(this, 'guano_ausente_cb')"></div>
                        <div>Insetívoro</div>
                        <div class="grid-cell"><input type="checkbox" name="guano_insetivoro" value="recente" onchange="uncheckAusente(this, 'guano_ausente_cb')"></div>
                        <div class="grid-cell"><input type="checkbox" name="guano_insetivoro" value="antigo" onchange="uncheckAusente(this, 'guano_ausente_cb')"></div>
                        <div class="grid-cell"><input type="checkbox" name="guano_insetivoro" value="exaurido" onchange="uncheckAusente(this, 'guano_ausente_cb')"></div>
                        <div>Nectarívoro</div>
                        <div class="grid-cell"><input type="checkbox" name="guano_nectarivoro" value="recente" onchange="uncheckAusente(this, 'guano_ausente_cb')"></div>
                        <div class="grid-cell"><input type="checkbox" name="guano_nectarivoro" value="antigo" onchange="uncheckAusente(this, 'guano_ausente_cb')"></div>
                        <div class="grid-cell"><input type="checkbox" name="guano_nectarivoro" value="exaurido" onchange="uncheckAusente(this, 'guano_ausente_cb')"></div>
                    </div>
                </div>
            </div>
            <div id="tabAlteracoes" class="tab-content">
                <h2>Alterações Antrópicas</h2>
                <div class="impact-grid">
                    <div class="grid-header"></div>
                    <div class="grid-header">Ausente</div>
                    <div class="grid-header">Presente</div>
                    <div>Lixo</div>
                    <div class="grid-cell"><input type="radio" name="alteracoes_lixo" value="Ausente"></div>
                    <div class="grid-cell"><input type="radio" name="alteracoes_lixo" value="lixo"></div>
                    <div>Pisoteio</div>
                    <div class="grid-cell"><input type="radio" name="alteracoes_pisoteio" value="Ausente"></div>
                    <div class="grid-cell"><input type="radio" name="alteracoes_pisoteio" value="pisoteio"></div>
                    <div>Poeira</div>
                    <div class="grid-cell"><input type="radio" name="alteracoes_poeira" value="Ausente"></div>
                    <div class="grid-cell"><input type="radio" name="alteracoes_poeira" value="poeira"></div>
                </div>
            </div>
            <div id="tabTaxons" class="tab-content">
                <h2>Táxons</h2>
                <div class="form-group">
                    <label>Invertebrados</label>
                    <div id="invertebrados-container"></div>
                    <button type="button" onclick="addTaxonRow('invertebrados-container')">+</button>
                </div>
                <div class="form-group">
                    <label>Vertebrados</label>
                    <div id="vertebrados-container"></div>
                    <button type="button" onclick="addTaxonRow('vertebrados-container')">+</button>
                </div>
            </div>
            <div id="tabMaterialColetado" class="tab-content">
                <h2>Material Coletado</h2>
                <div class="form-group">
                    <label>Eppendorf</label>
                    <div class="quantity-stepper">
                        <button type="button" onclick="changeQuantity(this, -1)">-</button>
                        <input type="number" name="eppendorf" value="0" min="0">
                        <button type="button" onclick="changeQuantity(this, 1)">+</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Falcon</label>
                    <div class="quantity-stepper">
                        <button type="button" onclick="changeQuantity(this, -1)">-</button>
                        <input type="number" name="falcon" value="0" min="0">
                        <button type="button" onclick="changeQuantity(this, 1)">+</button>
                    </div>
                </div>
            </div>
            <div id="tabObservacoes" class="tab-content">
                <h2>Observações</h2>
                <div class="form-group">
                    <label for="observacoes_gerais">Observações Gerais</label>
                    <textarea id="observacoes_gerais" name="observacoes_gerais" rows="10"></textarea>
                </div>
                <div class="form-group">
                    <label for="horario_termino">Horário (término)</label>
                    <input type="time" id="horario_termino" name="horario_termino">
                </div>
            </div>
            <input type="file" id="photo-input" accept="image/*" capture="camera" multiple style="display:none;">
        </form>
    </div>
</div>

<div class="navigation-arrows">
    <button type="button" id="prevTabBtn">&larr; Voltar</button>
    <button type="button" id="nextTabBtn">Seguir &rarr;</button>
</div>

<button type="button" id="take-photo-btn" class="fab" title="Adicionar Fotos">Fotos</button>
<button type="button" id="saveButton" class="fab" title="Salvar Ficha como .ZIP">Salvar</button>
<div id="status-container" style="display:none; position:fixed; bottom: 70px; left: 10px; right: 10px; background: #28a745; color: white; padding: 15px; border-radius: 8px; z-index: 2000; text-align: center; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>

<script>
// ***** INÍCIO DAS BIBLIOTECAS EMBUTIDAS (PARA FUNCIONAR OFFLINE) *****
// --- Biblioteca JSZip (para criar arquivos .zip) ---
!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).JSZip=t()}}(function(){return function t(e,r,n){function i(s,a){if(!r[s]){if(!e[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(o)return o(s,!0);var h=new Error("Cannot find module '"+s+"'");throw h.code="MODULE_NOT_FOUND",h}var f=r[s]={exports:{}};e[s][0].call(f.exports,function(t){var r=e[s][1][t];return i(r||t)},f,f.exports,t,e,r,n)}return r[s].exports}for(var o="function"==typeof require&&require,s=0;s<n.length;s++)i(n[s]);return i}({1:[function(t,e,r){"use strict";var n=t("./utils"),i=t("./support"),o="undefined"!=typeof ArrayBuffer&&"[object ArrayBuffer]"===Object.prototype.toString.call(new ArrayBuffer);r.newBlob=function(t,e){r.checkSupport("blob");try{return new Blob(t,{type:e})}catch(n){try{var i=self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder,s=new i;return s.append(t),s.getBlob(e)}catch(n){throw new Error("Bug : can't construct the Blob.")}}};var s={application:"application/octet-stream",text:function(t){var e=t||"us-ascii",r={};return r["utf-8"]="text/plain;charset=UTF-8",r["utf8"]="text/plain;charset=UTF-8",r[e]&&(r[e]="text/plain;charset="+e.toLowerCase()),function(t){return r[n.uint8Array2String(t).toLowerCase()]||"text/plain"}}};function a(t,e){var r,n=t.split("/"),i=n[0],s=n[1];return e&&"text"===i?(r=s.toLowerCase().replace(/_/g,"-").replace(/-\d\d\d\d/,""),Object.prototype.hasOwnProperty.call(e,r)?e[r](t):e.text(t)):t}r.transformTo=function(t,e){if(!e)return t;var i=e.split(";")[0].toLowerCase();return(i=a(i,s[i]))+";"+e.substring(i.length+1)},r.getTypeOf=function(t){return"string"==typeof t?"string":o&&t instanceof ArrayBuffer?"arraybuffer":"uint8array"},r.checkSupport=function(t){var e=i[t.toLowerCase()];if(!e)throw new Error(t+" is not supported by this browser");return e},r.MAX_VALUE_16BITS=65535,r.MAX_VALUE_32BITS=-1,r.pretty=function(t){var e,r,n="";for(r=0;r<(t||"").length;r++)e=t.charCodeAt(r),n+="\\x"+(e<16?"0":"")+e.toString(16).toUpperCase();return n},r.delay=function(t,e,r){(self.setTimeout||self.setImmediate)(function(){t.call(r||self)},e)},r.inherits=function(t,e){var r=function(){};r.prototype=e.prototype,t.prototype=new r},r.extend=function(){var t,e,r={};for(t=0;t<arguments.length;t++)for(e in arguments[t])Object.prototype.hasOwnProperty.call(arguments[t],e)&&void 0===r[e]&&(r[e]=arguments[t][e]);return r},r.prepareContent=function(t,e,s,a,u){var h=n.getTypeOf(e),f=n.transformTo(t,u);return i.string&&"string"===h&&"text"!==f.substring(0,4)?r.Promise.resolve(e).then(function(t){return n.string2binary(t)}):r.Promise.resolve(e).then(function(t){var e=n.transformTo(t,s);return r.transform(f,e,s,a)})}},{2:[function(t,e,r){e.exports=t("core-js/library/fn/promise")},{"core-js/library/fn/promise":11}],3:[function(t,e,r){"use strict";e.exports=t("./internal/fs")},{"./internal/fs":4}],4:[function(t,e,r){"use strict";var n=t("../utils"),i=t("../stream/GenericWorker");function o(t,e){i.call(this,t),this._sources=e||[]}o.prototype=Object.create(i.prototype),o.prototype.constructor=o,o.prototype.add=function(t){this._sources.push(t)},o.prototype.processChunk=function(t){for(var e=0;e<this._sources.length;e++)this._sources[e].processChunk(t)},o.prototype.isPaused=function(){if(i.prototype.isPaused.call(this))return!0;for(var t=0;t<this._sources.length;t++)if(this._sources[t].isPaused())return!0;return!1},o.prototype.resume=function(){var t=i.prototype.resume.call(this);if(t)for(var e=0;e<this._sources.length;e++)this._sources[e].resume();return t},o.prototype.pause=function(){i.prototype.pause.call(this);for(var t=0;t<this._sources.length;t++)this._sources[t].pause()},r.exports=o},{"../stream/GenericWorker":28,"../utils":32}],5:[function(t,e,r){"use strict";var n=t("./utils"),i=t("./stream/GenericWorker"),o=t("./utf8"),s=t("./crc32"),a=t("./signature");function u(t,e,r,n){this.name=t,this.dir=r,this.date=e,this.comment=n,this.unixPermissions=null,this.dosPermissions=null,this._data={},this._dataBinary=!1,this.options={}}u.prototype={setUnixPermissions:function(t){this.unixPermissions="string"==typeof t?parseInt(t,8):t},setDosPermissions:function(t){this.dosPermissions=t},_initialMetadata:function(){this.options={compression:null,compressionOptions:null,comment:null,date:null,dir:!1,dosPermissions:null,unixPermissions:null},this._data=null,this._dataBinary=!1},_prepareStream:function(){var t=new i("ZipObject stream");return this._data instanceof i?(this._data.on("data",function(e){t.push({data:e,meta:{percent:100}})}),this._data.on("end",function(){t.push({data:null,meta:{}})}),this._data.on("error",function(e){t.error(e)})):this._data instanceof n.Promise?this._data.then(function(e){t.push({data:e,meta:{percent:100}}),t.push({data:null,meta:{}})},function(e){t.error(e)}):t.push({data:this._data,meta:{percent:100}}),t.push({data:null,meta:{}}),t},internalStream:function(t){var e=this,r=n.getTypeOf(t);this._initialMetadata(),this.options.compression=null,this.options.compressionOptions=null,this.options.date=this.date,this.options.dir=this.dir,this.options.unixPermissions=this.unixPermissions,this.options.dosPermissions=this.dosPermissions,this.options.comment=this.comment,this._data=t,this._dataBinary="string"!==r&&"uint8array"!==r&&"arraybuffer"!==r;var i=this._prepareStream();return i.on("end",function(){e._data=null,e._dataBinary=!1}).on("error",function(t){throw t}),i}},u.prototype.async=function(t,e){return this.internalStream(t,e).async(t,e)},u.prototype.nodeStream=function(t,e){return this.internalStream(t||"string").nodeStream(t,e)},r.exports=u},{}]},{},{}));
// --- Biblioteca Proj4js (para conversão de coordenadas) ---
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.proj4=t()}(this,function(){"use strict";var e={WGS84:{"+proj":"longlat","+ellps":"WGS84","+datum":"WGS84","+no_defs":!0},EPSG:4326:{"-axis":"enu","+proj":"longlat","+ellps":"WGS84","+datum":"WGS84","+no_defs":!0}};function t(t,o){if(!(o=o||e)[t])throw new Error("projection '"+t+"' is not defined");return o[t]}var o=6378137,a=1/298.257223563,r=Math.sqrt(2*a-a*a),s=r*r;function n(e,t){var a,n,i,l,d,p,c=t[0],m=t[1],u=(a=c,n=m,"sphere"===a.projName?a.a:a.k0_?a.k0_*a.a:a.a);if(u){var h=m.length;if(h>0){l=a.from_greenwich||0,d=a.axis||"enu";var f=!1;for(p=0;p<h;++p)if(a.axis){var g=m[p];"string"==typeof g&&(m[p]=parseFloat(g))}else if(f||isNaN(m[p])){if(f)continue;m[p]=m[p].toLowerCase(),f=!0}else m[p]=parseFloat(m[p]);for("en"===d.substr(0,2).toLowerCase()?(i=m[0],m[0]=m[1],m[1]=i):"ne"===d.substr(0,2).toLowerCase()&&(i=m[0],m[0]=m[1],m[1]=-i),p=0;p<h;++p)if(isNaN(m[p]))return;if(2===h)m[2]=0;m[0]%=360,m[1]%=360;var v=Math.PI/180;return l&&(m[0]+=l),m[0]*=v,m[1]*=v,m[2]*=v,e.transform(a,m)}}var i=1e-12;function l(e){return Math.abs(e)<=i?0:e}function d(e,t){var o=Math.floor(e/t);return e-o*t}function p(e){return Math.log(Math.tan(.5*(.5*Math.PI+e)))}function c(e,o,a){var r,s,n;o*=o,a*=a*a;var i=(e*e-o)/a;return r=Math.cbrt(i+Math.sqrt(i*i+1)),s=Math.cbrt(i-Math.sqrt(i*i+1)),l(r+s)}function m(e,t){var o,a;if(t.k0_?o=t.k0_*t.a:t.a,a=t.es,e[0]>Math.PI&&(e[0]-=2*Math.PI),e[1]>Math.PI/2&&(e[1]-=Math.PI),"merc"===t.projName){var r=o,s=a?p(e[1])/Math.pow(1-a*Math.sin(e[1])*Math.sin(e[1]),.5):p(e[1]),n=r*s,i=r*e[0];return[i,n]}return e}function u(e,t){var o,a;if(t.k0_?o=t.k0_*t.a:t.a,a=t.es,"merc"===t.projName){var r=a,s=o,n=Math.PI/2,i=t.R_A,l=.001,d=90*Math.PI/180,p=s*Math.log(Math.tan(Math.PI/4)),c=e[0],m=e[1];if(p-m>-1e-6&&p-m<0)return[c/s,0];if(m-p>-1e-6&&m-p<0)return[c/s,0];var u,h,f=c/s;h=n-2*Math.atan(1/Math.exp(m/s));for(var g=0;g<30;++g){if(u=r*Math.sin(h),Math.abs(h-((i?Math.asin:function(e){return 2*Math.atan(e)-n})(Math.pow((1+u)/(1-u),.5*r)*Math.exp(m/s))-(n-2*Math.atan(1))))<l)break;h=n-2*Math.atan(Math.pow((1-u)/(1-u),.5*r)*Math.exp(m/s))}if(h<-d&&(h=-d),h>d&&(h=d),i){var v,y,b,k,w,M;w=(e[1]/o+Math.log(Math.tan(.25*Math.PI+.5*h)))/((1-s*Math.sin(h)*Math.sin(h))/(o*Math.cos(h))),y=h,b=50;do{v=s*Math.sin(y),k=o*(1-v*v*s)/Math.cos(y),w=y-(o*Math.log(Math.tan(.25*Math.PI+.5*y))-s*Math.log(Math.tan(.25*Math.PI+.5*Math.asin(Math.sin(y)*Math.sqrt(s))))-e[1])/k}while(--b&&Math.abs(w)>1e-12&&(y-=w));if(b)h=y}return[f,h]}return e}var h={};var f,g,v,y,b,k,w,M,P=Math.PI,S=P/180,x=.5*P,z=2*P,D=P/4,T=P/2;function E(e){return e.R_A?e.a:Math.sqrt(e.a*e.a*(1-e.es))}function _(e,t){var o=Math.sin(t),a=Math.cos(t),r=e.e*o;return P*e.a*a/Math.sqrt(1-r*r)}function A(e,t){var o=Math.sin(t),a=e.e*o;return e.a*(1-e.es)/(Math.pow(1-a*a,1.5))}function O(e,t){var o=p(t)-e.e*Math.atanh(e.e*Math.sin(t));return isNaN(o)?null:o}function C(e,t,o){var a=Math.exp(t);return 2*Math.atan(a)-x}function I(e,t,o){var a=o/e.a,r=(e.es*e.es,e.es*e.es*e.es,e.es,e.one_es,t),s=e.es,n=Math.sin(r),i=Math.pow(1-s*n*s*n,.5);return e.a*(1-s*s)/(Math.pow(1-s*n*s*n,1.5))}function L(e,t,o){var a,r=Math.cos(2*t),s=Math.sin(2*t),n=Math.cos(4*t),i=Math.sin(4*t),l=Math.cos(6*t),d=Math.sin(6*d);return a=e.a*(e.A0*o-e.A2/2*s+e.A4/4*i-e.A6/6*d),e.b_?e.b*o*(1-e.es/4*(1+e.es/4*(1-16/3*Math.pow(Math.cos(o),2))))-3/8*e.es*e.es*(s-e.es/4*i):a}function R(e,t,o){var a=t,r=0;for(;r<15&&1e-12<Math.abs(a-t);)a=t,t-=(t-(1-e.one_es*Math.pow(Math.sin(t),2))*Math.sin(t)-o)/(1-e.one_es*(2*Math.sin(t)*Math.cos(t)*Math.sin(t)+(1-e.one_es*Math.pow(Math.sin(t),2))*Math.cos(t)));return t}function N(e){this.projName="longlat",this.ellps=e.ellps,this.datum=e.datum,this.a=e.a,this.b=e.b,this.es=e.es,this.e=e.e,this.f=e.f}function F(e){e=e||{};var t,o={a:e.a,b:e.b,rf:e.rf,es:e.es,e:e.e,f:e.f};if(void 0===o.a)if(void 0!==e.datum&&h[e.datum]){var a=h[e.datum];void 0!==e.ellps&&a.ellps[e.ellps]?(o=a.ellps[e.ellps],t=a.towgs84):o=a.ellps.WGS84}else if(void 0!==e.ellps&&f[e.ellps])o=f[e.ellps];else{if(!(void 0!==e.datum&&"WGS84"===e.datum))throw new Error("No ellps or datum given");o.a=6378137,o.rf=298.257223563}if(void 0===o.b&&void 0===o.rf)o.b=o.a;else if(void 0===o.rf)o.rf=o.a/(o.a-o.b);else if(void 0===o.b)o.b=o.a*(1-1/o.rf);if(void 0===o.es&&void 0===o.f){o.f=1/o.rf;var r=2*o.f-o.f*o.f;o.e=Math.sqrt(r),o.es=r}else if(void 0===o.e){var s=Math.sqrt((o.a-o.b)*(o.a+o.b))/o.a;o.es=s*s}else o.es=o.e*o.e;return o.one_es=1-o.es,o.rone_es=1/o.one_es,o.radius=Math.sqrt(o.one_es),o.f||(o.f=1-Math.sqrt(1-o.es)),o.k0=e.k0||e.k,e.axis=e.axis||"enu",e.from_greenwich=e.from_greenwich||0,e=Object.assign({},e,o),t&&!e.towgs84&&(e.towgs84=t),e}function j(e){var t=d(e,2*Math.PI);return t<-Math.PI?t+2*Math.PI:t>Math.PI?t-2*Math.PI:t}function G(e,t,o){return l(e)+l(t)+l(o)}function B(e,t){var o=Math.sin(t);return Math.cos(t)/Math.sqrt(1-e.es*o*o)}function U(e,t,o){var a=o,r=t,s=Math.cos(r),n=Math.sin(r),i=s,l=n;return e.axis&&(s=(i=(n=s)*Math.sin(a)+(i=n)*Math.cos(a))*Math.cos(a)-l*Math.sin(a),l=i,i=s),i=l,l=n,[i,l]}var V={};function q(e,t,o,a,r,s,n,i,l,d){var p;return e.a*t-e.b*s-e.c*l-e.d*n+e.e*i-e.f*r+e.g*d}function W(e,t,o,a,r,s,n,i,l,d){var p;return-e.a*o+e.b*r-e.g*l+e.d*i+e.e*n-e.f*d+e.c*s}function X(e,t,o,a,r,s,n,i,l,d){var p;return e.c*r-e.d*s+e.e*l+e.f*n+e.g*o-e.b*i-e.a*d}f={"MERIT":{a:6378137,rf:298.257},"SGS885":{a:6378136,rf:298.257},"GRS80":{a:6378137,rf:298.257222101},"IAU76":{a:6378140,rf:298.257},"Airy":{a:6377563.396,rf:299.3249646},"APL4.9":{a:6378137,rf:298.25},"NWL9D":{a:6378145,rf:298.25},"mod_airy":{a:6377340.189,rf:299.3249646},"andrae":{a:6377104.43,rf:300},"aust_SA":{a:6378160,rf:298.25},"bessel":{a:6377397.155,rf:299.1528128},"bess_nam":{a:6377483.865,rf:299.1528128},"clrk66":{a:6378206.4,b:6356583.8},"clrk80":{a:6378249.145,rf:293.4663},"clrk80ign":{a:6378249.2,rf:293.4660212936265},"cpm":{a:6375738.7,rf:334.29},"delmbr":{a:6376456,rf:315},"engelis":{a:6378136.05,rf:298.257222101},"evrst30":{a:6377276.345,rf:300.8017},"evrst48":{a:6377304.063,rf:300.8017},"evrst56":{a:6377301.243,rf:300.8017},"evrst69":{a:6377295.664,rf:300.8017},"evrstSS":{a:6377298.556,rf:300.8017},"fschr60":{a:6378166,rf:298.3},"fschr60m":{a:6378155,rf:298.3},"fschr68":{a:6378150,rf:298.3},"helmert":{a:6378200,rf:298.3},"hough":{a:6378270,rf:297},"intl":{a:6378388,rf:297},"krass":{a:6378245,rf:298.3},"kaula":{a:6378163,rf:298.24},"lerch":{a:6378139,rf:298.257},"mprts":{a:6397300,rf:191},"new_intl":{a:6378157.5,b:6356772.2},"plessis":{a:6376523,rf:308.64},"SEasia":{a:6378155,b:6356773.3205},"walbeck":{a:6376896,b:6355834.8467},"WGS60":{a:6378165,rf:298.3},"WGS66":{a:6378145,rf:298.25},"WGS72":{a:6378135,rf:298.26},"WGS84":{a:6378137,rf:298.257223563},"sphere":{a:6370997,b:6370997}},h={"Adindan":{towgs84:"-162,-12,206",ellps:"clrk80",country:"Burkina Faso, Cameroon, Mali, Niger, Senegal, Togo"},"Agadez":{towgs84:"-162,-12,206",ellps:"clrk80",country:"Niger"},"Ain_el_Abd_1970":{towgs84:"-156.46,-212.55,14.07",ellps:"intl",country:"Bahrain, Kuwait, Saudi Arabia"},"Accra":{towgs84:"-199,32,328",ellps:"clrk80",country:"Ghana"},"Afgooye":{towgs84:"-62,427,-135",ellps:"krass",country:"Somalia"},"Agd_1948":{towgs84:"-127,-42,135",ellps:"intl",country:"Greenland"},"Aratu":{towgs84:"-153.5,-1.3, -20.5",ellps:"intl",country:"Brazil"},"Arc_1950":{towgs84:"-143,-90,-294",ellps:"clrk80",country:"Botswana, Lesotho, Malawi, Swaziland, Zaire, Zambia, Zimbabwe"},"Arc_1960":{towgs84:"-160,-8,-300",ellps:"clrk80",country:"Kenya, Tanzania"},"Ascension_Is_1958":{towgs84:"-207,107,52",ellps:"intl",country:"Ascension Island"},"ASTRO_Beacon_E":{towgs84:"145,185.3,101.4",ellps:"intl",country:"Iwo Jima"},"Australian_Geodetic_1966":{towgs84:"-133,-48,148",ellps:"aust_SA",country:"Australia"},"Australian_Geodetic_1984":{towgs84:"-134,-48,149",ellps:"aust_SA",country:"Australia"},"Ayabelle_Lighthouse":{towgs84:"-79.31,-145.87,173.86",ellps:"clrk80",country:"Djibouti"},"Bab_Saad_1995":{towgs84:"-225,-265,22",ellps:"clrk80",country:"Libya"},"Batavia":{towgs84:"-377,681,-50",ellps:"bessel",country:"Indonesia (Sumatra)"},"Bermuda_1957":{towgs84:"-73,213,296",ellps:"clrk66",country:"Bermuda"},"Bissau":{towgs84:"-176,260,33",ellps:"clrk80",country:"Guinea-Bissau"},"Bogota":{towgs84:"307,304,-318",ellps:"intl",country:"Colombia"},"Bukoba":{towgs84:"-170,36,252",ellps:"clrk80",country:"Tanzania"},"Camp_Area_Astro":{towgs84:"-104,-129,239",ellps:"intl",country:"Antarctica"},"Campo_Inchauspe":{towgs84:"-148,136,90",ellps:"intl",country:"Argentina"},"Canton_Astro_1966":{towgs84:"298, -304, -375",ellps:"intl",country:"Phoenix Islands"},"Cape":{towgs84:"-136,-108,-292",ellps:"clrk80",country:"South Africa"},"Cape_Canaveral":{towgs84:"-2,151,181",ellps:"clrk66",country:"Florida, Bahama Islands"},"Carthage":{towgs84:"-263,6,431",ellps:"clrk80",country:"Tunisia"},"CH-1903":{towgs84:"674.374,15.056,405.346",ellps:"bessel",country:"Switzerland, Liechtenstein"},"Chatham_1971":{towgs84:"54,-19,165",ellps:"intl",country:"New Zealand (Chatham Island)"},"Chua_Astro":{towgs84:"-134,229,-29",ellps:"intl",country:"Paraguay"},"Corrego_Alegre":{towgs84:"-206,172,-6",ellps:"intl",country:"Brazil"},"Dabola":{towgs84:"-90, -2, 117",ellps:"clrk80",country:"Guinea"},"Datum_73":{towgs84:"-80.5,81.4,-41.2",ellps:"intl",country:"Sao Miguel, Santa Maria Islands (Azores)"},"Dealul_Piscului_1933":{towgs84:"-124,-331,-151",ellps:"intl",country:"Romania"},"Dealul_Piscului_1970":{towgs84:"-124,-331,-151",ellps:"krass",country:"Romania"},"DHDN":{towgs84:"598.1,73.7,418.2,0.202,0.045,-2.455,6.7",ellps:"bessel",country:"Germany"},"Djibouti":{towgs84:"-79,-145,173",ellps:"clrk80",country:"Djibouti"},"DOS_1968":{towgs84:"-352.9,-337.8,321.7",ellps:"WGS72",country:"Gizo Island (New Georgia Group)"},"Easter_Island_1967":{towgs84:"211,147,111",ellps:"intl",country:"Easter Island"},"ED50":{towgs84:"-87,-98,-121",ellps:"intl",country:"Europe, Middle East, and Asia"},"ED79":{towgs84:"-86,-98,-119",ellps:"intl",country:"Europe"},"Egypt_1907":{towgs84:"-130,110,-13",ellps:"helmert",country:"Egypt"},"Estonia_1937":{towgs84:"385.1,162.9,451.7,-3.72,2.02,-4.55,17.9",ellps:"bessel",country:"Estonia"},"European_1950":{towgs84:"-87,-98,-121",ellps:"intl",country:"Europe, Middle East, and Asia"},"European_1979":{towgs84:"-86,-98,-119",ellps:"intl",country:"Europe"},"Fahud":{towgs84:"-244, -196, 421",ellps:"clrk80",country:"Oman"},"FK89":{towgs84:"-415.7,-60,-337.3",ellps:"bessel",country:"Faroe Islands"},"Fort_Thomas_1955":{towgs84:"-273,-139,330",ellps:"clrk80",country:"Nevis, St. Christopher"},"Gan_1970":{towgs84:"-66,543,-219",ellps:"intl",country:"Republic of Maldives"},"Geodetic_Datum_1949":{towgs84:"84,-22,209",ellps:"intl",country:"New Zealand"},"Ghana":{towgs84:"-204,36,334",ellps:"clrk80",country:"Ghana"},"Graciosa_Base_SW_1948":{towgs84:"-45,163,123",ellps:"intl",country:"Faial, Graciosa, Pico, Sao Jorge, Terceira Islands (Azores)"},"Grand_Comoros":{towgs84:"135,-325,-56",ellps:"intl",country:"Grand Comoros, Anjouan, and Moheli Islands"},"Guam_1963":{towgs84:"-100,-248,259",ellps:"clrk66",country:"Guam"},"Gux_1_Astro":{towgs84:"-45,193,-49",ellps:"intl",country:"Guadalcanal Island"},"Hanoi_1972":{towgs84:"-191.90441429,-39.30318279,-111.45032835,0.00928836,-0.00753431,0.00039363,0.0",ellps:"krass",country:"Vietnam"},"Herat_North":{towgs84:"-333,-222,-113",ellps:"intl",country:"Afghanistan"},"Hito_XVIII_1963":{towgs84:"-34,226,71",ellps:"intl",country:"Chile"},"Hjorsey_1955":{towgs84:"-73, -46, 86",ellps:"intl",country:"Iceland"},"Hong_Kong_1963":{towgs84:"-156,-271,-189",ellps:"intl",country:"Hong Kong"},"IGN53":{towgs84:"-108,137,354",ellps:"clrk80",country:"Reunion"},"IGN56":{towgs84:"-108,137,354",ellps:"clrk80",country:"Madagascar"},"IGN63":{towgs84:"-65, -1, 148",ellps:"intl",country:"Tahiti"},"IGN72_Nuku_Hiva":{towgs84:"-84,-26,-150",ellps:"intl",country:"Marquesas Islands"},"IGN72_Grande_Terre":{towgs84:"-305.19,255.42,-44.62",ellps:"intl",country:"Guadeloupe"},"IKB_1992":{towgs84:"682, -203, 480",ellps:"bessel",country:"Indonesia"},"Indian":{towgs84:"289,734,257",ellps:"evrst48",country:"Bangladesh, India, Nepal"},"Indian_1954":{towgs84:"289,734,257",ellps:"evrst48",country:"Thailand"},"Indian_1960":{towgs84:"210,814,289",ellps:"evrst48",country:"Con Son Island (Vietnam)"},"Indian_1975":{towgs84:"217,752,274",ellps:"evrst48",country:"Thailand"},"Indonesia_1974":{towgs84:"-24,-16,5",ellps:"GRS80",country:"Indonesia"},"ISTS_061_Astro_1968":{towgs84:"-204,133,189",ellps:"intl",country:"South Georgia Island"},"ISTS_073_Astro_1969":{towgs84:"-273,-139,330",ellps:"intl",country:"Diego Garcia"},"Ireland_1965":{towgs84:"506,-122,611",ellps:"mod_airy",country:"Ireland"},"Israel":{towgs84:"-234.02,-92.4,213.25",ellps:"clrk80ign",country:"Israel, Palestine"},"JGD2000":{towgs84:"0,0,0",ellps:"GRS80",country:"Japan"},"Johnston_Island_1961":{towgs84:"-176,-134,167",ellps:"intl",country:"Johnston Island"},"Kandawala":{towgs84:"-97,787,86",ellps:"evrst30",country:"Sri Lanka"},"Kerguelen_Island_1949":{towgs84:"145,-187,-103",ellps:"intl",country:"Kerguelen Island"},"Kertau_1948":{towgs84:"-11,851,5",ellps:"evrst48",country:"Malaysia (West), Singapore"},"Kusaie_Astro_1951":{towgs84:"647,1777, -1123",ellps:"intl",country:"Caroline Islands"},"L.C.5_Astro_1961":{towgs84:"-31,219,82",ellps:"clrk80",country:"Cayman Brac Island"},"Leigon":{towgs84:"-130,29,364",ellps:"clrk80",country:"Ghana"},"Liberia_1964":{towgs84:"-90,40,88",ellps:"clrk80",country:"Liberia"},"Lisbon_1890":{towgs84:"-303.4, -63.3, 104.9",ellps:"bessel",country:"Portugal"},"Luzon":{towgs84:"-133,-77,-51",ellps:"clrk66",country:"Philippines (excluding Mindanao)"},"Mahe_1971":{towgs84:"41, -220, -134",ellps:"clrk80",country:"Mahe Island"},"Makassar":{towgs84:"-393,678,-46",ellps:"bessel",country:"Indonesia (Celebes)"},"Malongo_1987":{towgs84:"-189,24,96",ellps:"WGS72",country:"Cabinda (Angola)"},"Manoca_1962":{towgs84:"-96,400,285",ellps:"clrk80",country:"Sao Tome and Principe"},"Massawa":{towgs84:"-308, -3, 378",ellps:"bessel",country:"Eritrea (Ethiopia)"},"Merchich":{towgs84:"31,146,47",ellps:"clrk80",country:"Morocco"},"Mhast":{towgs84:"-152,43,118",ellps:"clrk80",country:"Brunei, Malaysia (Sarawak, Sabah)"},"Midway_Astro_1961":{towgs84:"912, -58, 1227",ellps:"intl",country:"Midway Islands"},"Mindanao":{towgs84:"-133,-79,-72",ellps:"clrk66",country:"Philippines (Mindanao)"},"Minna":{towgs84:"-92,-93,122",ellps:"clrk80",country:"Nigeria"},"Montserrat_Is_Astro_1958":{towgs84:"-176,17,44",ellps:"clrk80",country:"Montserrat"},"MOP78":{towgs84:"-111, -26, 127",ellps:"intl",country:"Macau"},"Mount_Dillon":{towgs84:"-78,48,157",ellps:"clrk80",country:"Tobago"},"Moznet":{towgs84:"-145,15,-295",ellps:"WGS84",country:"Mozambique"},"NAD27":{towgs84:"-8,160,176",ellps:"clrk66",country:"North America (USA, Canada, Mexico, Central America)"},"NAD83":{towgs84:"0,0,0",ellps:"GRS80",country:"North America (USA, Canada, Mexico, Central America)"},"Nahrwan":{towgs84:"-246, -145, 340",ellps:"clrk80",country:"Saudi Arabia, UAE"},"Naparima_BWI":{towgs84:"-4,292,236",ellps:"intl",country:"Trinidad and Tobago"},"NGO_1948":{towgs84:"-415.7,-60,-337.3",ellps:"bessel",country:"Norway"},"NGN":{towgs84:"-92,-93,122",ellps:"clrk80",country:"Nigeria"},"Nord_de_Guerre":{towgs84:"-168,-60,320",ellps:"plessis",country:"France"},"NTF":{towgs84:"-168,-60,320",ellps:"plessis",country:"France, Germany"},"Observatorio_1966":{towgs84:"-426, -299, 442",ellps:"intl",country:"Flores Island (Azores)"},"Old_Hawaiian":{towgs84:"61, -285, -181",ellps:"clrk66",country:"Hawaii"},"OSGB_1936":{towgs84:"446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894",ellps:"airy",country:"United Kingdom (Great Britain, Shetland and Orkney Islands, Isle of Man), Ireland"},"OSGB_1970_SN":{towgs84:"370,-111,434",ellps:"airy",country:"United Kingdom (England, Isle of Man, Scotland, Wales)"},"Padang_1884":{towgs84:"-377,681,-50",ellps:"bessel",country:"Indonesia (Sumatra)"},"Palestine_1923":{towgs84:"-127.3,-41.8,143.2",ellps:"clrk80ign",country:"Israel, Palestine, Jordan, Lebanon, Syria"},"Pico_De_Las_Nieves":{towgs84:"-307, -92, 471",ellps:"intl",country:"Canary Islands"},"Pointe_Noire_1948":{towgs84:"-148,51, -291",ellps:"clrk80",country:"Congo"},"Porto_Santo_1936":{towgs84:"-499,249,314",ellps:"intl",country:"Porto Santo, Madeira Islands"},"Potsdam":{towgs84:"598.1,73.7,418.2,0.202,0.045,-2.455,6.7",ellps:"bessel",country:"Germany"},"Provisional_S_American_1956":{towgs84:"-288,175,-376",ellps:"intl",country:"South America"},"Puerto_Rico":{towgs84:"11,72,-101",ellps:"clrk66",country:"Puerto Rico, Virgin Islands"},"Pulkovo_1942":{towgs84:"24,-123,-94",ellps:"krass",country:"Russia"},"Qatar_National":{towgs84:"-128, -283, 22",ellps:"intl",country:"Qatar"},"Qornoq":{towgs84:"164,138,-189",ellps:"intl",country:"Greenland (South)"},"Reunion":{towgs84:"-94, -948, -1262",ellps:"intl",country:"Mascarene Islands"},"Rikstrakverket_1938":{towgs84:"-415.7,-60,-337.3",ellps:"bessel",country:"Sweden"},"Rome_1940":{towgs84:"-225,-65,9",ellps:"intl",country:"Italy (Sardinia)"},"RT38":{towgs84:"-415.7,-60,-337.3",ellps:"bessel",country:"Sweden"},"S-42":{towgs84:"24,-123,-94",ellps:"krass",country:"Russia"},"Sapper_Hill_1943":{towgs84:"-355,16,72",ellps:"intl",country:"Falkland Islands"},"Schwarzeck":{towgs84:"-616, -97, 251",ellps:"bess_nam",country:"Namibia"},"Selvagem_Grande_1938":{towgs84:"-311,61,65",ellps:"intl",country:"Salvage Islands"},"Serindung":{towgs84:"-419,692,-40",ellps:"bessel",country:"Indonesia (Borneo)"},"Sierra_Leone_1960":{towgs84:"-66,88,141",ellps:"clrk80",country:"Sierra Leone"},"South_American_1969":{towgs84:"-57,1,-41",ellps:"aust_SA",country:"South America"},"South_Asia":{towgs84:"7, -10, -26",ellps:"mod_airy",country:"Singapore"},"Southeast_Base":{towgs84:"50,213,97",ellps:"intl",country:"Porto Santo, Madeira Islands"},"Southwest_Base":{towgs84:"-91,250,91",ellps:"intl",country:"Faial, Graciosa, Pico, Sao Jorge, Terceira Islands (Azores)"},"TC_1948":{towgs84:"-289,124,59",ellps:"clrk80",country:"Turks and Caicos Islands"},"Tern_Island_Astro_1961":{towgs84:"-119,-251,326",ellps:"intl",country:"Hawaiian Islands"},"Timbalai_1948":{towgs84:"-689,691,-46",ellps:"evrst48",country:"Brunei, Malaysia (Sarawak, Sabah)"},"TM65":{towgs84:"506,-122,611",ellps:"mod_airy",country:"Ireland"},"Tokyo":{towgs84:"-148,507,685",ellps:"bessel",country:"Japan, Korea, Okinawa"},"Tristan_Astro_1968":{towgs84:"-632,438, -609",ellps:"intl",country:"Tristan da Cunha"},"Viti_Levu_1916":{towgs84:"51,391,-36",ellps:"clrk80",country:"Fiji (Viti Levu Island)"},"Voirol_1875":{towgs84:"-121.2,-77.5,148.9",ellps:"clrk80",country:"Algeria"},"Wake-Eniwetok_1960":{towgs84:"101,52, -29",ellps:"hough",country:"Marshall Islands"},"WGS72":{towgs84:"0,0,4.5",ellps:"WGS72",country:"World"},"WGS84":{towgs84:"0,0,0",ellps:"WGS84",country:"World"},"Yacare":{towgs84:"-155,171,37",ellps:"intl",country:"Uruguay"},"Zanderij":{towgs84:"-265,120,-358",ellps:"intl",country:"Suriname"}},g={longlat:N,merc:function(e){var t=e.long0||0,o=e.lat0||0,a=e.x0||0,r=e.y0||0,s=e.k0||1,n=e.a,i=e.es;this.init=function(){e.R_A&&(n*=s,e.a=n,e.k0_=1)},this.forward=function(e){var l,d,p=s;return e[0]-=t,"sphere"!==e.projName&&(d=Math.sqrt(1-i*Math.sin(e[1])*Math.sin(e[1])),l=p*n*Math.log(Math.tan(Math.PI/4+e[1]/2))/d),l=p*n*Math.log(Math.tan(Math.PI/4+e[1]/2)),[a+p*n*(e[0]-t),r+l]},this.inverse=function(e){var l=Math.PI/2,d=e[0]-a,p=e[1]-r,c=i,m=s,u=n,h=2*Math.atan(Math.exp(p/(m*u)))-l;if(c){var f,g,v=.001,y=90*Math.PI/180;h=l-2*Math.atan(1/Math.exp(p/u));for(var b=0;b<30;++b){if(f=c*Math.sin(h),Math.abs(h-((!0?Math.asin:function(e){return 2*Math.atan(e)-l})(Math.pow((1+f)/(1-f),.5*c)*Math.exp(p/u))-(l-2*Math.atan(1))))<v)break;h=l-2*Math.atan(Math.pow((1-f)/(1-f),.5*c)*Math.exp(p/u))}if(h<-y&&(h=-y),h>y&&(h=y),!0){var k,w,M,P,S,x;S=(e[1]/o+Math.log(Math.tan(.25*Math.PI+.5*h)))/((1-s*Math.sin(h)*Math.sin(h))/(o*Math.cos(h))),w=h,M=50;do{k=s*Math.sin(w),P=o*(1-k*k*s)/Math.cos(w),S=w-(o*Math.log(Math.tan(.25*Math.PI+.5*w))-s*Math.log(Math.tan(.25*Math.PI+.5*Math.asin(Math.sin(w)*Math.sqrt(s))))-e[1])/P}while(--M&&Math.abs(S)>1e-12&&(w-=S));if(M)h=w}}return[d/(m*u)+t,h]}}}};function Y(e){this.projName="utm",this.units="m",this.zone=e.zone,this.k0=e.k0,this.init=function(){e.k0=e.k0||.9996,e.x0=e.x0||5e5,e.y0=e.y0||(e.southern?"10000000.0":"0.0"),e.long0=6*(e.zone-1)-180+3;var t=g.tmerc(e);t.init(),this.forward=t.forward,this.inverse=t.inverse}}function H(e,t,o,a){return-o*Math.sin(e)-a*Math.cos(e)}function K(e,t,o,a){return-o*Math.cos(e)+a*Math.sin(e)}function Z(e,t,o,a){return o*Math.cos(e)+a*Math.sin(e)}function J(e,t,o,a){return-o*Math.sin(e)+a*Math.cos(e)}function Q(e,t){var o=Math.cos(t),a=Math.sin(t);return[e.a*o,e.b*a]}function $(e,t){var o=Math.cos(t),a=Math.sin(t);return[e.a*o*o-e.b*a*a,e.b*o*o-e.a*a*a]}v={geocent:function(e){this.projName="geocent",this.init=function(){e.a=e.a||o,e.b=e.b||e.a*(1-1/(e.rf||a)),e.es=e.es||1-(e.b*e.b)/(e.a*e.a),e.e2=e.es},this.forward=function(e){var t=e[1],o=e[2],a=Math.cos(t),r=a*Math.cos(e[0]),s=a*Math.sin(e[0]),n=Math.sin(t),i=1-this.es*n*n,l=Math.sqrt(i),d=this.a/l;return[(d+o)*r,(d+o)*s,(this.a*(1-this.es)/l+o)*n]},this.inverse=function(e){var t,o,a,r=Math.sqrt(e[0]*e[0]+e[1]*e[1]),s=1-this.es;if(0<r)o=Math.atan2(e[1],e[0]);else o=0;if((a=Math.atan2(e[2]*this.a,r*this.b))===Math.atan2(e[2],r*s))return[o,a,r-this.a];var n,i=Math.cos(a),l=Math.sin(a),d=this.a*i,p=this.b*l;t=Math.atan2(e[2]+this.e2*p,r),i=Math.cos(t),l=Math.sin(t),d=this.a*i,p=this.b*l,n=Math.sqrt(i*i+(l/s)*(l/s)),r/=i;return r-=this.a/n,[o,t,r]}}},y=Object.assign(g,v),b={tmerc:function(e){var t=e.long0||0,o=e.lat0||0,a=e.x0||0,r=e.y0||0,s=e.k0||1,n=e.a,i=e.es,l=e.e,d=e.ep2,p=i/(1-i);this.init=function(){this.sph=e.sphere,e.sphere?this.forward=this.s_forward:this.forward=this.e_forward,e.sphere?this.inverse=this.s_inverse:this.inverse=this.e_inverse},this.e_forward=function(e){var c,m,u,h,f,g=j(e[0]-t);e[1];var v=Math.cos(e[1]),y=Math.tan(e[1]),b=p*v*v,k=n*L(e,o,e[1]),w=n*s*Math.sin(e[1])*v*g/2,M=n*s*Math.sin(e[1])*Math.pow(v,3)*(5-y*y+9*b+4*b*b)*Math.pow(g,3)/24,P=n*s*Math.sin(e[1])*Math.pow(v,5)*(61-58*y*y+Math.pow(y,4)+270*b-330*b*y*y)*Math.pow(g,5)/720,S=n*s*Math.pow(v,7)*(1385-3111*y*y+543*Math.pow(y,4)-Math.pow(y,6))*Math.pow(g,7)/40320,x=n*s*v*g,z=n*s*Math.pow(v,3)*(1-y*y+b)*Math.pow(g,3)/6,D=n*s*Math.pow(v,5)*(5-18*y*y+Math.pow(y,4)+14*b-58*b*y*y)*Math.pow(g,5)/120,T=n*s*Math.pow(v,7)*(61-479*y*y+179*Math.pow(y,4)-Math.pow(y,6))*Math.pow(g,7)/5040;return e[0]=a+x+z+D+T,e[1]=r+k+w+M+P+S,e},this.e_inverse=function(e){var c,m,u;e[0]-=a,e[1]-=r;var h,f,g=e[1]/s,v=e[0]/s,y=R(e,Math.PI/2,g),b=Math.cos(y),k=Math.tan(y),w=p*b*b,M=n*(1-i)/Math.pow(1-i*Math.pow(Math.sin(y),2),1.5),P=Math.sqrt(1-i*Math.pow(Math.sin(y),2))/(n*b),S=y-k*b*b*Math.pow(P,2)*Math.pow(v,2)/2+k*Math.pow(b,4)*(5+3*k*k+w-9*w*k*k)*Math.pow(P,4)*Math.pow(v,4)/24-k*Math.pow(b,6)*(61+90*k*k+45*Math.pow(k,4))*Math.pow(P,6)*Math.pow(v,6)/720,x=P*v-Math.pow(b,2)*(1+2*k*k+w)*Math.pow(P,3)*Math.pow(v,3)/6+Math.pow(b,4)*(5+28*k*k+24*Math.pow(k,4)+6*w+8*w*k*k)*Math.pow(P,5)*Math.pow(v,5)/120,z=x+t;return e[0]=z,e[1]=S,e},this.s_forward=function(e){var s=j(e[0]-t),n=e[1],i=Math.cos(n),l=i*Math.sin(s);if(Math.abs(Math.abs(l)-1)<=1e-10)return null;var d=Math.log((1+l)/(1-l))/2,p=Math.acos(i*Math.cos(s)/Math.sqrt(1-l*l));n<0&&(p*=-1);var c=a+s*n*d,m=r+s*n*p;return e[0]=c,e[1]=m,e},this.s_inverse=function(e){var s=e[0]-a,n=e[1]-r,i=Math.sqrt(s*s+n*n);if(i<=1e-10)return[t,o];var l=Math.cos(o)*Math.sin(i/(s*n)),d=Math.asin(l),p=t+Math.atan2(s*Math.sin(d),s*n*Math.cos(o)*Math.cos(d)-s*n*Math.sin(o)*Math.sin(d))/Math.cos(d);return e[0]=p,e[1]=d,e}}}};y=Object.assign(y,b),k=Object.assign(y,{utm:Y,longlat:N}),w={};function M(e,t,o){if("string"==typeof e)return t&&V[e]?new V[e](t):g[e]?new g[e](t):V[e]?new V[e](F(t)):k[e]?new k[e](F(t)):w[e]?new w[e](F(t)):void 0;var a={from:M(e,"string"==typeof t?F(o):t),to:M(t,"string"==typeof e?F(o):e)},r=function(e){var t;if(e){if(Array.isArray(e)){t=[];for(var o=0;o<e.length;++o)t.push(r(e[o]));return t}return a.from.forward(e),a.to.inverse(e)};return r.forward=function(e){return a.from.forward(e)},r.inverse=function(e){return a.to.inverse(e)},r.defs=t,r}var P,S;P=Object.assign({},e,{nad83:e.WGS84,esri:4326:e.WGS84,epsg:4326:e.WGS84,EPSG:3857:{"-axis":"swu","+proj":"merc","+a":6378137,"+b":6378137,"+lat_ts":0,"+lon_0":0,"+x_0":0,"+y_0":0,"+k":1,"+units":"m","+nadgrids":"@null","+wktext":!0,"+no_defs":!0}}),S=M,Object.keys(P).forEach(function(e){S.defs(e,P[e])});var x=S;return x.Point=function(e,t,o){var a;if(e instanceof S.Point)return e.hasZ=e.hasZ,new S.Point(e.x,e.y,e.z);if(Array.isArray(e))return e[2]?(a=new S.Point(e[0],e[1],e[2]),a.hasZ=!0):a=new S.Point(e[0],e[1]),a;if("string"==typeof e){var r=e.split(",");return 3===r.length?(a=new S.Point(parseFloat(r[0]),parseFloat(r[1]),parseFloat(r[2])),a.hasZ=!0):2===r.length&&(a=new S.Point(parseFloat(r[0]),parseFloat(r[1]))),a}else"object"==typeof e&&(a=new S.Point(e.x,e.y,e.z),e.z&&(a.hasZ=!0));return a||(a=this),a.x=a.x||e||0,a.y=a.y||t||0,a.z=a.z||o||0,a.hasZ&&(void 0!==a.z&&null!==a.z),a},x.Point.prototype={toArray:function(){var e=[this.x,this.y];return this.hasZ&&e.push(this.z),e},toString:function(){var e=this.x+","+this.y;return this.hasZ&&(e+=","+this.z),e}},x.WGS84=e.WGS84,x.latlon=e.latlon,x.mercator=e.mercator,x.addCoordinateTransforms=function(e,o,a,r){var s=function(t,s){var n=M(e,o,s),i=a.forward(n.forward(t.slice())),l=r.inverse(n.inverse(t.slice()));return[function(e){var t=n.forward(e.slice());return a.forward(t),t},function(e){var t=n.inverse(e.slice());return r.inverse(t),t}]},n=M(e),i=M(o);return i.forward=function(e){return s(e,this).forward},i.inverse=function(e){return s(e,this).inverse},i},x.nadgrid=function(){},x.transform=n,x.proj=x,x.default=x,x.defs=t,x});
//# sourceMappingURL=proj4.js.map
// ***** FIM DAS BIBLIOTECAS EMBUTIDAS *****

// --- CÓDIGO DA APLICAÇÃO ---
document.addEventListener('DOMContentLoaded', () => {

    // --- VARIÁVEIS GLOBAIS ---
    const form = document.getElementById('bioForm');
    const tabLinks = document.querySelectorAll('.tab-link');
    const tabContents = document.querySelectorAll('.tab-content');
    const nextTabBtn = document.getElementById('nextTabBtn');
    const prevTabBtn = document.getElementById('prevTabBtn');
    const saveButton = document.getElementById('saveButton');
    const clearButton = document.getElementById('clearButton');
    const takePhotoButton = document.getElementById('take-photo-btn');
    const photoInput = document.getElementById('photo-input');
    const photoPreviewsContainer = document.getElementById('photo-previews');
    const statusContainer = document.getElementById('status-container');

    let currentTabIndex = 0;
    let photos = []; // Array para armazenar os arquivos de imagem

    // --- INICIALIZAÇÃO ---
    function initializeForm() {
        // Define a data atual
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('data').value = today;

        // Adiciona um TÁXON inicial para invertebrados e vertebrados
        addTaxonRow('invertebrados-container');
        addTaxonRow('vertebrados-container');
        
        // Atualiza o estado dos botões de navegação
        updateNavigationButtons();
    }

    // --- NAVEGAÇÃO POR ABAS ---
    window.openTab = (evt, tabName) => {
        tabContents.forEach(tab => tab.classList.remove('active'));
        tabLinks.forEach(link => link.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        evt.currentTarget.classList.add('active');
        
        // Atualiza o índice da aba atual
        currentTabIndex = Array.from(tabLinks).findIndex(link => link.classList.contains('active'));
        updateNavigationButtons();
    };

    function updateNavigationButtons() {
        prevTabBtn.disabled = currentTabIndex === 0;
        nextTabBtn.disabled = currentTabIndex === tabLinks.length - 1;
    }

    function changeTab(direction) {
        const newIndex = currentTabIndex + direction;
        if (newIndex >= 0 && newIndex < tabLinks.length) {
            tabLinks[newIndex].click();
        }
    }

    prevTabBtn.addEventListener('click', () => changeTab(-1));
    nextTabBtn.addEventListener('click', () => changeTab(1));

    // --- LÓGICA DO FORMULÁRIO (helpers) ---
    window.toggleConditionalText = (radio, textInputId, isDisabled) => {
        document.getElementById(textInputId).disabled = isDisabled;
    };

    window.handleAusente = (checkbox, optionsContainerId) => {
        const container = document.getElementById(optionsContainerId);
        const otherCheckboxes = container.querySelectorAll('input[type="checkbox"]');
        if (checkbox.checked) {
            otherCheckboxes.forEach(cb => {
                cb.checked = false;
                cb.disabled = true;
            });
        } else {
            otherCheckboxes.forEach(cb => cb.disabled = false);
        }
    };
    
    window.uncheckAusente = (checkbox, ausenteCheckboxId) => {
        if (checkbox.checked) {
            document.getElementById(ausenteCheckboxId).checked = false;
        }
    };

    window.addTaxonRow = (containerId) => {
        const container = document.getElementById(containerId);
        const row = document.createElement('div');
        row.className = 'dynamic-row';
        row.style.display = 'flex';
        row.style.gap = '10px';
        row.innerHTML = `
            <input type="text" placeholder="Nome do táxon" class="taxon-name" style="flex-grow: 1;">
            <input type="number" placeholder="Nº" class="taxon-qty" min="0" style="width: 60px;">
            <button type="button" class="remove-taxon-btn">-</button>
        `;
        container.appendChild(row);
        row.querySelector('.remove-taxon-btn').addEventListener('click', () => row.remove());
    };

    window.changeQuantity = (button, amount) => {
        const input = button.parentElement.querySelector('input[type="number"]');
        let currentValue = parseInt(input.value, 10);
        currentValue = isNaN(currentValue) ? 0 : currentValue;
        const newValue = Math.max(0, currentValue + amount);
        input.value = newValue;
    };

    // --- FUNCIONALIDADE GPS ---
    window.getGPS = () => {
        if (!navigator.geolocation) {
            alert('Geolocalização não é suportada por este navegador.');
            return;
        }

        const status = (msg) => document.getElementById('coordenadas').value = msg;
        status('Obtendo coordenadas...');

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                const alt = position.coords.altitude ? position.coords.altitude.toFixed(2) : 'N/A';

                document.getElementById('altitude').value = alt;

                // Converte de WGS84 (lat/lon) para UTM Zona 23S
                // Define as projeções
                proj4.defs("EPSG:4326", "+proj=longlat +datum=WGS84 +no_defs");
                proj4.defs("EPSG:32723", "+proj=utm +zone=23 +south +datum=WGS84 +units=m +no_defs");

                try {
                    const utmCoords = proj4("EPSG:4326", "EPSG:32723", [lon, lat]);
                    const easting = utmCoords[0].toFixed(2);
                    const northing = utmCoords[1].toFixed(2);
                    status(`${easting} E / ${northing} S`);
                } catch (e) {
                    status('Erro na conversão de coordenadas.');
                    console.error("Erro no Proj4js: ", e);
                }
            },
            () => {
                status('Não foi possível obter a localização.');
            },
            { enableHighAccuracy: true }
        );
    };

    // --- MANIPULAÇÃO DE FOTOS ---
    takePhotoButton.addEventListener('click', () => photoInput.click());

    photoInput.addEventListener('change', (event) => {
        const files = event.target.files;
        for (const file of files) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const photoId = 'photo_' + Date.now() + Math.random();
                // Adiciona o arquivo e o Data URL ao array global
                photos.push({ id: photoId, file: file, dataUrl: e.target.result });
                renderPhotoPreviews();
            };
            reader.readAsDataURL(file);
        }
        // Limpa o input para permitir selecionar o mesmo arquivo novamente
        photoInput.value = ''; 
    });

    function renderPhotoPreviews() {
        photoPreviewsContainer.innerHTML = '';
        photos.forEach(photo => {
            const previewWrapper = document.createElement('div');
            previewWrapper.className = 'photo-preview-item';
            
            const img = document.createElement('img');
            img.src = photo.dataUrl;
            img.title = photo.file.name;
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-photo-btn';
            removeBtn.innerHTML = '&times;';
            removeBtn.title = 'Remover foto';
            removeBtn.onclick = () => removePhoto(photo.id);
            
            previewWrapper.appendChild(img);
            previewWrapper.appendChild(removeBtn);
            photoPreviewsContainer.appendChild(previewWrapper);
        });
    }

    function removePhoto(photoId) {
        photos = photos.filter(p => p.id !== photoId);
        renderPhotoPreviews();
    }

    // --- LIMPAR E SALVAR ---
    clearButton.addEventListener('click', () => {
        if (confirm('Tem certeza que deseja limpar todos os campos do formulário?')) {
            form.reset();
            document.getElementById('invertebrados-container').innerHTML = '';
            document.getElementById('vertebrados-container').innerHTML = '';
            addTaxonRow('invertebrados-container');
            addTaxonRow('vertebrados-container');
            photos = [];
            renderPhotoPreviews();
            // Volta para a primeira aba
            tabLinks[0].click(); 
            initializeForm();
            showStatus('Formulário limpo.', 'info');
        }
    });

    saveButton.addEventListener('click', async () => {
        showStatus('Preparando para salvar...', 'info');

        try {
            const zip = new JSZip();
            
            // 1. Gera o relatório HTML
            const reportHTML = generateHTMLReport();
            zip.file("ficha_bioespeleologia.html", reportHTML);

            // 2. Adiciona as fotos em uma pasta
            if (photos.length > 0) {
                const photosFolder = zip.folder("fotos");
                photos.forEach(photo => {
                    photosFolder.file(photo.file.name, photo.file);
                });
            }

            // 3. Gera o arquivo .zip
            const content = await zip.generateAsync({ type: "blob" });

            // 4. Inicia o download
            const link = document.createElement("a");
            const cavidadeNome = document.getElementById('nome_cavidade').value.trim().replace(/\s+/g, '_') || 'sem_nome';
            const data = document.getElementById('data').value || 'sem_data';
            link.href = URL.createObjectURL(content);
            link.download = `Ficha_${cavidadeNome}_${data}.zip`;
            link.click();
            URL.revokeObjectURL(link.href);

            showStatus('Ficha salva com sucesso!', 'success');

        } catch (error) {
            console.error("Erro ao salvar o arquivo ZIP:", error);
            showStatus('Erro ao salvar. Verifique o console.', 'error');
        }
    });

    function showStatus(message, type = 'success') {
        statusContainer.textContent = message;
        statusContainer.style.backgroundColor = type === 'error' ? 'var(--danger-color)' : (type === 'info' ? 'var(--secondary-color)' : 'var(--success-color)');
        statusContainer.style.display = 'block';

        setTimeout(() => {
            statusContainer.style.display = 'none';
        }, 3000);
    }

    // --- GERAÇÃO DO RELATÓRIO HTML ---
    function generateHTMLReport() {
        const formData = new FormData(form);
        let html = `
            <!DOCTYPE html><html lang="pt-br"><head><meta charset="UTF-8"><title>Relatório de Bioespeleologia</title>
            <style>
                body { font-family: sans-serif; margin: 2em; } 
                h1, h2 { color: #2c3e50; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
                .section { margin-bottom: 2em; } 
                .field { margin-bottom: 0.5em; } 
                .field strong { display: inline-block; min-width: 200px; }
                .photo-gallery img { max-width: 400px; margin: 10px; border: 1px solid #ddd; }
                table { border-collapse: collapse; width: 100%; margin-top: 1em; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
            </style></head><body>
            <h1>Relatório de Bioespeleologia</h1>`;

        const sections = {
            'Dados Gerais': ['projeto_localidade', 'equipe', 'nome_cavidade', 'data', 'horario_inicio', 'estacao', 'clima', 'coordenadas', 'altitude'],
            'Características Externas': ['posicao_vertente', 'declividade', 'drenagem_ativa', 'drenagem_presenca_texto', 'vegetacao'],
            'Descrição da Cavidade': ['inclinacao_piso', 'sedimentos', 'umidade', 'hidrologia', 'zonacao_eufotica', 'zonacao_disfotica', 'zonacao_afotica'],
            'Recursos': ['recursos'],
            'Alterações Antrópicas': ['alteracoes_lixo', 'alteracoes_pisoteio', 'alteracoes_poeira'],
            'Material Coletado': ['eppendorf', 'falcon'],
            'Observações': ['observacoes_gerais', 'horario_termino']
        };

        for (const sectionTitle in sections) {
            html += `<div class="section"><h2>${sectionTitle}</h2>`;
            sections[sectionTitle].forEach(fieldName => {
                const fieldLabel = form.querySelector(`label[for="${fieldName}"]`)?.textContent || fieldName.replace(/_/g, ' ');
                let values = formData.getAll(fieldName).filter(v => v);
                if (values.length > 0) {
                     html += `<div class="field"><strong>${fieldLabel}:</strong> ${values.join(', ')}</div>`;
                }
            });
            html += `</div>`;
        }
        
        // Seção de Guano (lógica especial)
        html += `<div class="section"><h2>Guano</h2>`;
        const guanoGeral = formData.get('guano_geral');
        if (guanoGeral === 'Ausente') {
            html += `<div class="field"><strong>Guano:</strong> Ausente</div>`;
        } else {
            const guanoTypes = ['frugivoro', 'hematofago', 'insetivoro', 'nectarivoro'];
            guanoTypes.forEach(type => {
                let values = formData.getAll(`guano_${type}`).filter(v => v);
                if (values.length > 0) {
                    html += `<div class="field"><strong>${type.charAt(0).toUpperCase() + type.slice(1)}:</strong> ${values.join(', ')}</div>`;
                }
            });
        }
        html += `</div>`;

        // Seção de Táxons (lógica especial)
        const invertebrados = Array.from(document.querySelectorAll('#invertebrados-container .dynamic-row'));
        const vertebrados = Array.from(document.querySelectorAll('#vertebrados-container .dynamic-row'));
        html += `<div class="section"><h2>Táxons</h2>`;
        if (invertebrados.length > 0) {
            html += '<h3>Invertebrados</h3><table><tr><th>Nome</th><th>Nº</th></tr>';
            invertebrados.forEach(row => {
                const name = row.querySelector('.taxon-name').value;
                const qty = row.querySelector('.taxon-qty').value;
                if(name) html += `<tr><td>${name}</td><td>${qty}</td></tr>`;
            });
            html += '</table>';
        }
         if (vertebrados.length > 0) {
            html += '<h3>Vertebrados</h3><table><tr><th>Nome</th><th>Nº</th></tr>';
            vertebrados.forEach(row => {
                const name = row.querySelector('.taxon-name').value;
                const qty = row.querySelector('.taxon-qty').value;
                if(name) html += `<tr><td>${name}</td><td>${qty}</td></tr>`;
            });
            html += '</table>';
        }
        html += `</div>`;

        // Seção de Fotos
        if (photos.length > 0) {
            html += `<div class="section"><h2>Fotografias</h2><div class="photo-gallery">`;
            photos.forEach(photo => {
                html += `<figure><img src="fotos/${photo.file.name}" alt="${photo.file.name}"><figcaption>${photo.file.name}</figcaption></figure>`;
            });
            html += `</div></div>`;
        }

        html += `</body></html>`;
        return html;
    }

    // --- INICIA A APLICAÇÃO ---
    initializeForm();
});
</script>
</body>
</html>
