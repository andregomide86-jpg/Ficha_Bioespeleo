const generateCsvFilesContent = () => {
        let allDataTemp = {};
        // MODIFICADO: Substitui 'Coordenadas' pelas colunas separadas
        const orderedKeys = [
            'Data', 'Horário (início)', 'Horário (término)', 'Projeto/Localidade', 'Nome da cavidade', 'Estação', 'Clima', 'Equipe', 
            'Zona', 'E', 'N', 'Altitude',
            'Posição na vertente', 'Declividade', 'Drenagem Ativa', 'Proximidade da drenagem', 'Vegetação',
            'Inclinação predominante do piso', 'Sedimentos Clásticos', 'Umidade', 'Hidrologia', 'Luminosidade', 'Eppendorf', 'Falcon',
            'Pisoteio', 'Lixo', 'Poeira',
            'Recursos encontrados', 'Outros Recursos (Adicionar)',
            'Guano', 'Guano Frugívoros', 'Guano Hematófagos', 'Guano Insetívoros', 'Guano Nectarívoros',
            'Agentes Transportadores',
            'Observações Gerais'
        ];
        form.querySelectorAll('input[type="text"], input[type="date"], input[type="time"], input[type="tel"], input[type="number"], textarea, select, input[type="hidden"]').forEach(el => {
            // Garante que o campo de coordenadas visível não entre na exportação principal
            if (el.id === 'coordenadas') return;

            // MODIFICADO: Lógica para obter labels ou nomes dos campos
            let label = el.closest('.form-group')?.querySelector('label')?.innerText.replace(/:$/, '') || el.name || el.id;
            
            // Adiciona os dados dos campos ocultos de coordenadas
            if (el.id === 'utm_zone') label = 'Zona';
            if (el.id === 'utm_easting') label = 'E';
            if (el.id === 'utm_northing') label = 'N';
            if (el.id === 'utm_altitude') label = 'Altitude';

            if (el.value && (el.type !== 'number' || el.value !== '0')) {
                 allDataTemp[label] = el.value;
            }
        });
        form.querySelectorAll('input[type="radio"]:checked').forEach(el => {
            let labelText = el.closest('.form-group')?.querySelector('label')?.innerText.replace(/:$/, '') || el.name.charAt(0).toUpperCase() + el.name.slice(1);
            allDataTemp[labelText] = el.value;
        });
        const checkboxes = {};
        form.querySelectorAll('input[type="checkbox"]:checked').forEach(el => {
            if (el.name === 'guano_ausente') return;
            let name = el.closest('.panel, .form-group')?.previousElementSibling?.innerText.replace(/:$/, '') || el.closest('.form-group')?.querySelector('label')?.innerText.replace(/:$/, '') || el.name;
            if (!checkboxes[name]) checkboxes[name] = [];
            checkboxes[name].push(el.value);
        });
        for (const [key, value] of Object.entries(checkboxes)) {
            allDataTemp[key] = value;
        }
        const guanoAusenteCheckbox = document.querySelector('input[name="guano_ausente"]');
        if (guanoAusenteCheckbox && guanoAusenteCheckbox.checked) {
            allDataTemp['Guano'] = 'ausente';
        } else {
            const guanoTypes = ['frugivoro', 'hematofago', 'insetivoro', 'nectarivoro'];
            guanoTypes.forEach(type => {
                const states = [];
                document.querySelectorAll(`input[name="guano_${type}_estado"]:checked`).forEach(cb => states.push(cb.value));
                if (states.length > 0) {
                    allDataTemp[`Guano ${type.charAt(0).toUpperCase() + type.slice(1)}s`] = states;
                }
            });
        }
        
        let principalHeaders = [], principalValues = [];
        orderedKeys.forEach(key => {
            if (allDataTemp[key] !== undefined) { // Modificado para incluir valores vazios como altitude
                principalHeaders.push(key);
                let value = Array.isArray(allDataTemp[key]) ? allDataTemp[key].join(', ') : allDataTemp[key];
                principalValues.push(`"${String(value).replace(/"/g, '""')}"`);
            }
        });
        
        const principalCsvContent = (principalHeaders.length > 0) ? `\uFEFF${principalHeaders.join(';')}\n${principalValues.join(';')}` : null;
        
        // --- Modificação para o CSV de Táxons ---
        let taxonRows = [];
        const clean = val => `"${String(val).replace(/"/g, '""')}"`;
        const estacao = form.querySelector('select[name="estacao"]')?.value || '';
        const projeto = document.getElementById('projeto_localidade').value.trim();
        const data = document.getElementById('data').value.trim();
        const horario = document.getElementById('horario').value.trim();
        const cavidade = document.getElementById('nome_cavidade').value.trim();
        
        // Pega os dados dos campos ocultos
        const zona = document.getElementById('utm_zone').value.trim();
        const easting = document.getElementById('utm_easting').value.trim();
        const northing = document.getElementById('utm_northing').value.trim();
        const altitude = document.getElementById('utm_altitude').value.trim();

        form.querySelectorAll('#invertebrados-container .invertebrado-entry').forEach(row => {
            const nome = row.querySelector('input[type="text"]').value;
            const qtd_v = row.querySelector('.quantity-v').value;
            const qtd_c = row.querySelector('.quantity-c').value;
            if (nome && (parseInt(qtd_v, 10) > 0 || parseInt(qtd_c, 10) > 0)) {
                taxonRows.push([clean(data), clean(horario), clean(projeto), clean(cavidade), clean(zona), clean(easting), clean(northing), clean(altitude), clean(estacao), 'Invertebrado', clean(nome), clean(qtd_v), clean(qtd_c)].join(';'));
            }
        });
        form.querySelectorAll('#vertebrados-container .dynamic-row').forEach(row => {
            const nome = row.querySelector('input[type="text"]').value;
            const qtd = row.querySelector('.quantity-v').value;
            if (nome && parseInt(qtd, 10) > 0) {
                taxonRows.push([clean(data), clean(horario), clean(projeto), clean(cavidade), clean(zona), clean(easting), clean(northing), clean(altitude), clean(estacao), 'Vertebrado', clean(nome), clean(qtd), ''].join(';'));
            }
        });
        
        // Modifica o cabeçalho do CSV de táxons
        const taxonCsvHeader = 'Data;Horário;Projeto/Localidade;Nome da cavidade;Zona;E;N;Altitude;Estação;Grupo;Táxon;Quantidade_V;Quantidade_C';
        const taxonCsvContent = (taxonRows.length > 0) ? `\uFEFF${taxonCsvHeader}\n${taxonRows.join('\n')}` : null;

        return { principalCsvContent, taxonCsvContent };
    };
