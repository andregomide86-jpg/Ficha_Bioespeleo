<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subterrânea Pesquisas Ambientais</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f4f4f4;
            font-size: 14px;
            padding-bottom: 70px; /* Espaço para a barra de navegação fixa */
        }
        .main-layout {
            display: flex;
            align-items: flex-start;
        }
        .container {
            max-width: 800px;
            width: 100%;
            margin: 10px;
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            flex-grow: 1;
        }
        h1 { text-align: center; color: #333; font-size: 22px; }
        
        .tab-container-vertical {
            display: flex;
            flex-direction: column;
            background-color: #f1f1f1;
            min-width: 50px;
            padding-bottom: 15px;
            
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            height: 100vh;
            align-self: flex-start;
        }
        .tab-container-vertical button {
            background-color: inherit;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 15px 10px;
            transition: 0.3s;
            font-size: 14px;
            writing-mode: vertical-lr; 
            transform: rotate(180deg);
            text-align: center;
            border-left: 4px solid transparent;
            width: 100%;
        }
        .tab-container-vertical button:hover { background-color: #ddd; }
        .tab-container-vertical button.active {
            background-color: #ccc;
            border-left: 4px solid #4CAF50;
        }
        .action-btn {
            writing-mode: vertical-lr;
            transform: rotate(180deg);
            text-align: center;
            border-left: 4px solid transparent;
            padding: 15px 10px !important;
            margin-top: auto; /* Empurra o botão para o final */
        }

        #take-photo-btn {
            background-color: #007bff; /* Azul */
            color: white;
        }
        #take-photo-btn:hover {
            background-color: #0056b3; /* Um azul mais escuro para o hover */
        }
        
        #exportButton {
            position: fixed;
            bottom: 80px; /* Posição acima da barra de navegação */
            right: 20px;
            z-index: 1000;
            
            background-color: #4CAF50;
            color: white;
            
            width: 60px;
            height: 60px;
            border-radius: 50%; /* Formato circular */
            border: none;
            
            display: flex;
            align-items: center;
            justify-content: center;
            
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #exportButton:hover {
             background-color: #45a049;
        }

        .tab-content-wrapper {
            flex-grow: 1;
            padding: 0 10px;
        }
        .tab-content { display: none; }
        
        .accordion {
            background-color: #eee;
            color: #444;
            cursor: pointer;
            padding: 15px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
            transition: 0.4s;
            border-radius: 4px;
            margin-top: 10px;
        }
        .accordion.active, .accordion:hover { background-color: #ccc; }
        
        .accordion:after {
            content: '\002B';
            color: #777;
            font-weight: bold;
            float: right;
            margin-left: 5px;
        }
        .accordion.active:after {
            content: '\2212';
        }
        
        .panel {
            padding: 10px 18px;
            background-color: white;
            display: none;
            overflow: hidden;
            border: 1px solid #eee;
            border-top: none;
            border-radius: 0 0 4px 4px;
        }
        .panel.show {
            display: block;
        }

        .form-group { margin: 15px 0; }
        .guano-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 8px;
            align-items: center;
        }
        .guano-header { font-weight: bold; text-align: center; font-size: 12px; }
        .guano-label { font-weight: bold; }
        .guano-cell { text-align: center; }
        .guano-cell-span {
            grid-column: span 3;
            text-align: left;
        }

        .impact-grid {
            display: grid;
            grid-template-columns: 100px auto auto;
            gap: 10px;
            align-items: center;
        }
        .impact-grid > div {
            text-align: center;
        }
        .impact-grid > div:first-child {
            font-weight: normal; 
            text-align: left;
        }
        .grid-header {
            font-weight: bold;
        }
        .section-title {
            font-size: 1.1em;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }


        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input[type="text"], input[type="date"], input[type="time"], input[type="number"], input[type="tel"], textarea, select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .options-group { display: flex; flex-wrap: wrap; gap: 15px; }
        .option-item { display: flex; align-items: center; gap: 5px; flex-basis: 45%; }
        .options-group-2-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .dynamic-row { display: flex; gap: 5px; align-items: center; padding-top: 10px; margin-top: 10px; border-top: 1px solid #eee;}
        .dynamic-row:first-child { border-top: none; }
        .invertebrado-entry { border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px; }
        .invertebrado-counters { display: flex; align-items: center; gap: 15px; margin-top: 5px; }
        .counter-label { font-size: 14px; font-weight: bold; }

        .quantity-stepper { display: flex; align-items: center; }
        .quantity-stepper button { width: 28px; height: 28px; padding: 0; font-size: 14px; line-height: 28px; text-align: center; margin: 0; flex-shrink: 0; }
        .quantity-stepper input { width: 40px; text-align: center; border-left: none; border-right: none; height: 28px; padding: 2px; }
        
        .add-row-btn { width: auto; padding: 5px 15px; font-size: 18px; margin-top: 10px; background-color: #007bff; }
        
        #photo-previews img { max-width: 100px; margin: 5px; border-radius: 4px; border: 1px solid #ccc; }
        
        .navigation-arrows {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background-color: #f1f1f1;
            border-top: 1px solid #ccc;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            z-index: 100;
        }
        .navigation-arrows button {
            width: 48%;
            padding: 10px 20px;
            font-size: 15px;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .navigation-arrows button:disabled {
            background-color: #e9e9e9;
            color: #aaa;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

<div class="main-layout">
    
    <div class="tab-container-vertical">
        <button class="tab-link active" onclick="openTab(event, 'tabDadosGerais')">Dados Gerais</button>
        <button class="tab-link" onclick="openTab(event, 'tabCaracteristicas')">Gerais Características</button>
        <button class="tab-link" onclick="openTab(event, 'tabTaxons')">Táxons</button>
        <button class="tab-link" onclick="openTab(event, 'tabRecursos')">Recursos</button>
        <button class="tab-link" onclick="openTab(event, 'tabGuano')">Guano</button>
        <button class="tab-link" onclick="openTab(event, 'tabAporte')">Caract. Outras</button>
        <button class="tab-link" onclick="openTab(event, 'tabObservacoes')">Observações</button>
        
        <button type="button" id="take-photo-btn" class="action-btn">Fotos</button>
    </div>

    <div class="tab-content-wrapper">
        <div class="container">
            <h1>Subterrânea Pesquisas Ambientais</h1>
            <form id="bioForm">
                <div id="tabDadosGerais" class="tab-content" style="display: block;">
                    <div class="form-group"><label for="projeto_localidade">Projeto/Localidade</label><input type="text" id="projeto_localidade" name="projeto_localidade"></div>
                    <div class="form-group"><label for="nome_cavidade">Nome da cavidade</label><input type="text" id="nome_cavidade" name="nome_cavidade"></div>
                    <div class="form-group"><label for="data">Data</label><input type="date" id="data" name="data"></div>
                    <div class="form-group"><label for="horario">Horário</label><input type="time" id="horario" name="horario"></div>
                    <div class="form-group"><label>Estação</label><select id="estacao" name="estacao"><option value="" disabled selected>Estação</option><option value="Seca">Seca</option><option value="Chuvosa">Chuvosa</option></select></div>
                    <div class="form-group"><label>Clima</label><select id="clima" name="clima"><option value="" disabled selected>Clima</option><option value="Ensolarado">Ensolarado</option><option value="Nublado">Nublado</option><option value="Chuvoso">Chuvoso</option></select></div>
                    <div class="form-group"><label for="equipe">Equipe</label><input type="text" id="equipe" name="equipe"></div>
                    <div class="form-group"><label for="coordenadas">Coordenadas</label><input type="tel" id="coordenadas" name="coordenadas"><button type="button" style="width:auto; padding: 8px 12px; font-size:14px; margin-top:5px; background-color:#555; color:white; border:none; border-radius:4px;" onclick="getGPS()">Obter Coordenadas GPS</button></div>
                </div>

                <div id="tabCaracteristicas" class="tab-content">
                    <button type="button" class="accordion">Descrição do Entorno</button>
                    <div class="panel">
                        <div class="form-group"><label>Posição na vertente</label><select id="posicao_vertente" name="posicao_vertente"><option value="" disabled selected>Posição na vertente</option><option value="Alta">Alta</option><option value="Média">Média</option><option value="Baixa">Baixa</option></select></div>
                        <div class="form-group"><label>Declividade</label><select id="declividade" name="declividade"><option value="" disabled selected>Declividade</option><option value="Plana">Plana</option><option value="Suave Ondulada">Suave Ondulada</option><option value="Ondulada">Ondulada</option><option value="Forte Ondulada">Forte Ondulada</option><option value="Montanhosa">Montanhosa</option><option value="Escarpada">Escarpada</option></select></div>
                        <div class="form-group">
                            <label>Drenagem Ativa</label>
                            <div class="options-group">
                                <div class="option-item"><input type="radio" id="drenagem_presenca" name="drenagem" value="Presença" onchange="toggleDrenagem(true)"><label for="drenagem_presenca">Presença</label></div>
                                <div class="option-item"><input type="radio" id="drenagem_ausencia" name="drenagem" value="Ausência" onchange="toggleDrenagem(false)" checked><label for="drenagem_ausencia">Ausência</label></div>
                            </div>
                            <div id="drenagem_proximidade_group" style="display:none; margin-top:10px;">
                                <label for="drenagem_proximidade">Proximidade da drenagem</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="number" id="drenagem_proximidade" name="drenagem_proximidade" style="width: 120px;">
                                    <span>metros</span>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="accordion">Vegetação</button>
                        <div class="panel">
                            <div class="options-group" id="vegetacao-group">
                                <div class="option-item"><input type="checkbox" name="vegetacao" value="Ausente"><label>Ausente</label></div>
                                <div class="option-item"><input type="checkbox" name="vegetacao" value="Rasteira"><label>Rasteira</label></div>
                                <div class="option-item"><input type="checkbox" name="vegetacao" value="Arbustos"><label>Arbustos</label></div>
                                <div class="option-item"><input type="checkbox" name="vegetacao" value="Árvores"><label>Árvores</label></div>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="accordion">Descrição da Cavidade</button>
                    <div class="panel">
                        <div class="form-group"><label>Inclinação predominante do piso</label><select id="inclinacao_piso" name="inclinacao_piso"><option value="" disabled selected>Inclinação</option><option value="Ascendente">Ascendente</option><option value="Descendente">Descendente</option><option value="Plana">Plana</option></select></div>
                        <button type="button" class="accordion">Sedimentos Clásticos</button>
                        <div class="panel">
                            <div class="options-group" id="sedimentos-group">
                                <div class="option-item"><input type="checkbox" name="sedimentos" value="Ausente"><label>Ausente</label></div>
                                <div class="option-item"><input type="checkbox" name="sedimentos" value="Argila/Silte"><label>Argila/Silte</label></div>
                                <div class="option-item"><input type="checkbox" name="sedimentos" value="Areia"><label>Areia</label></div>
                                <div class="option-item"><input type="checkbox" name="sedimentos" value="Seixo"><label>Seixo</label></div>
                                <div class="option-item"><input type="checkbox" name="sedimentos" value="Matacão"><label>Matacão</label></div>
                            </div>
                        </div>
                        <div class="form-group"><label>Umidade</label><select id="umidade" name="umidade"><option value="" disabled selected>Umidade</option><option value="Presença">Presença</option><option value="Ausência">Ausência</option></select></div>
                        <button type="button" class="accordion">Hidrologia</button>
                        <div class="panel">
                            <div class="options-group-2-col" id="hidrologia-group">
                                <div class="option-item"><input type="checkbox" name="hidrologia" value="Ausente"><label>Ausente</label></div>
                                <div class="option-item"><input type="checkbox" name="hidrologia" value="Condensação"><label>Condensação</label></div>
                                <div class="option-item"><input type="checkbox" name="hidrologia" value="Drenagem Efêmera"><label>Drenagem Efêmera</label></div>
                                <div class="option-item"><input type="checkbox" name="hidrologia" value="Drenagem Intermitente"><label>Drenagem Intermitente</label></div>
                                <div class="option-item"><input type="checkbox" name="hidrologia" value="Drenagem Perene"><label>Drenagem Perene</label></div>
                                <div class="option-item"><input type="checkbox" name="hidrologia" value="Escorrimento"><label>Escorrimento</label></div>
                                <div class="option-item"><input type="checkbox" name="hidrologia" value="Empoçamento"><label>Empoçamento</label></div>
                                <div class="option-item"><input type="checkbox" name="hidrologia" value="Exsudação"><label>Exsudação</label></div>
                                <div class="option-item"><input type="checkbox" name="hidrologia" value="Gotejamento"><label>Gotejamento</label></div>
                                <div class="option-item"><input type="checkbox" name="hidrologia" value="Percolação"><label>Percolação</label></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Zonação (%)</label>
                            <div class="options-group" style="flex-direction: column; gap: 10px; align-items: stretch;">
                                <div class="option-item" style="justify-content: space-between;"><label for="zonacao_eufotica">Aufótica</label><input type="number" id="zonacao_eufotica" name="zonacao_eufotica" style="width: 80px;"></div>
                                <div class="option-item" style="justify-content: space-between;"><label for="zonacao_disfotica">Disfótica</label><input type="number" id="zonacao_disfotica" name="zonacao_disfotica" style="width: 80px;"></div>
                                <div class="option-item" style="justify-content: space-between;"><label for="zonacao_afotica">Afótica</label><input type="number" id="zonacao_afotica" name="zonacao_afotica" style="width: 80px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tabTaxons" class="tab-content">
                    <button type="button" class="accordion">Invertebrados</button>
                    <div class="panel">
                        <div id="invertebrados-container"></div>
                        <button type="button" class="add-row-btn" onclick="addInvertebradoRow('invertebrados-container')">+</button>
                    </div>

                    <button type="button" class="accordion">Vertebrados</button>
                    <div class="panel">
                        <div id="vertebrados-container"></div>
                        <button type="button" class="add-row-btn" onclick="addVertebradoRow('vertebrados-container')">+</button>
                    </div>

                    <button type="button" class="accordion">Material Coletado</button>
                    <div class="panel">
                        <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
                            <label for="eppendorf" style="margin-bottom: 0; flex-grow: 1;">Eppendorf</label>
                            <div class="quantity-stepper">
                                <button type="button" onclick="changeQuantity(this, -1)">-</button>
                                <input type="number" id="eppendorf" name="eppendorf" value="0" min="0">
                                <button type="button" onclick="changeQuantity(this, 1)">+</button>
                            </div>
                        </div>
                        <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
                            <label for="falcon" style="margin-bottom: 0; flex-grow: 1;">Falcon</label>
                            <div class="quantity-stepper">
                                <button type="button" onclick="changeQuantity(this, -1)">-</button>
                                <input type="number" id="falcon" name="falcon" value="0" min="0">
                                <button type="button" onclick="changeQuantity(this, 1)">+</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tabRecursos" class="tab-content">
                    <div class="form-group" style="margin-top:0;">
                        <button type="button" class="accordion">Recursos encontrados</button>
                        <div class="panel">
                            <div class="options-group" id="recursos-group">
                                <div class="option-item"><input type="checkbox" name="recursos" value="Ausente"><label>Ausente</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Árvore"><label>Árvore</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Arbusto"><label>Arbusto</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Briófita"><label>Briófita</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Broto"><label>Broto</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Carcaça de vertebrado"><label>Carcaça de vertebrado</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Casca de ovo (vert.)"><label>Casca de ovo (vert.)</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Concha de gastrópode"><label>Concha de gastrópode</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Élitro de besouro"><label>Élitro de besouro</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Detrito animal"><label>Detrito animal</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Detrito vegetal"><label>Detrito vegetal</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Egagrópila"><label>Egagrópila</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Fezes"><label>Fezes</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Fungo"><label>Fungo</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Gramínea"><label>Gramínea</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Líquen amarelo"><label>Líquen amarelo</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Líquen branco"><label>Líquen branco</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Líquen vermelho"><label>Líquen vermelho</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Material vegetal"><label>Material vegetal</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Ninho (ave)"><label>Ninho (ave)</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Ossada"><label>Ossada</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Pena"><label>Pena</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Pteridófita"><label>Pteridófita</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Raiz fina"><label>Raiz fina</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Raiz média"><label>Raiz média</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Raiz grossa"><label>Raiz grossa</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Rizotema"><label>Rizotema</label></div>
                                <div class="option-item"><input type="checkbox" name="recursos" value="Serapilheira"><label>Serapilheira</label></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="outros_recursos">Outros Recursos (Adicionar):</label>
                            <textarea id="outros_recursos" name="outros_recursos" rows="6" placeholder="Liste outros recursos encontrados, um por linha..."></textarea>
                        </div>
                    </div>
                </div>
                
                <div id="tabGuano" class="tab-content">
                    <div class="form-group" id="guano-grid">
                        <label>Tipos e Estados de Guano:</label>
                        <div class="option-item" style="flex-basis: 100%; margin-bottom: 10px;">
                            <input type="checkbox" name="guano_ausente" id="guano_ausente_checkbox">
                            <label for="guano_ausente_checkbox" style="font-weight: bold; margin-bottom: 0;">Ausente</label>
                        </div>
                        <div class="guano-grid">
                            <div class="guano-header">Tipo de Guano</div>
                            <div class="guano-header">Recente</div>
                            <div class="guano-header">Antigo</div>
                            <div class="guano-header">Exaurido</div>

                            <div class="guano-label">Frugívoro</div>
                            <div class="guano-cell"><input type="checkbox" name="guano_frugivoro_estado" value="recente"></div>
                            <div class="guano-cell"><input type="checkbox" name="guano_frugivoro_estado" value="antigo"></div>
                            <div class="guano-cell"><input type="checkbox" name="guano_frugivoro_estado" value="exaurido"></div>

                            <div class="guano-label">Hematófago</div>
                            <div class="guano-cell"><input type="checkbox" name="guano_hematofago_estado" value="recente"></div>
                            <div class="guano-cell"><input type="checkbox" name="guano_hematofago_estado" value="antigo"></div>
                            <div class="guano-cell"><input type="checkbox" name="guano_hematofago_estado" value="exaurido"></div>

                            <div class="guano-label">Insetívoro</div>
                            <div class="guano-cell"><input type="checkbox" name="guano_insetivoro_estado" value="recente"></div>
                            <div class="guano-cell"><input type="checkbox" name="guano_insetivoro_estado" value="antigo"></div>
                            <div class="guano-cell"><input type="checkbox" name="guano_insetivoro_estado" value="exaurido"></div>

                            <div class="guano-label">Nectarívoro</div>
                            <div class="guano-cell"><input type="checkbox" name="guano_nectarivoro_estado" value="recente"></div>
                            <div class="guano-cell"><input type="checkbox" name="guano_nectarivoro_estado" value="antigo"></div>
                            <div class="guano-cell"><input type="checkbox" name="guano_nectarivoro_estado" value="exaurido"></div>
                        </div>
                    </div>
                </div>

                <div id="tabAporte" class="tab-content">
                    <div class="form-group">
                        <label class="section-title">Alterações Antrópicas</label>
                        <div class="impact-grid">
                            <div class="grid-header"></div>
                            <div class="grid-header">Ausente</div>
                            <div class="grid-header">Presente</div>
                            
                            <div><b>Pisoteio</b></div>
                            <div><input type="radio" name="pisoteio" value="Ausência"></div>
                            <div><input type="radio" name="pisoteio" value="Presença"></div>
                            
                            <div><b>Lixo</b></div>
                            <div><input type="radio" name="lixo" value="Ausência"></div>
                            <div><input type="radio" name="lixo" value="Presença"></div>
                            
                            <div><b>Poeira</b></div>
                            <div><input type="radio" name="poeira" value="Ausência"></div>
                            <div><input type="radio" name="poeira" value="Presença"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="section-title">Agentes Transportadores</label>
                        <div class="options-group-2-col" id="agentes-transportadores-group">
                            <div class="option-item"><input type="checkbox" name="agentes_transportadores" value="Água"><label>Água</label></div>
                            <div class="option-item"><input type="checkbox" name="agentes_transportadores" value="Gravidade"><label>Gravidade</label></div>
                            <div class="option-item"><input type="checkbox" name="agentes_transportadores" value="Vento"><label>Vento</label></div>
                            <div class="option-item"><input type="checkbox" name="agentes_transportadores" value="Vertebrados"><label>Vertebrados</label></div>
                        </div>
                    </div>
                </div>
                
                <div id="tabObservacoes" class="tab-content">
                    <div class="form-group">
                        <label for="obs_gerais">Observações Gerais</label>
                        <textarea id="obs_gerais" name="obs_gerais" rows="15"></textarea>
                    </div>
                </div>

                <input type="file" id="photo-input" accept="image/*" capture="camera" multiple style="display:none;">
                <div id="photo-previews"></div>
            </form>
            
            <div class="navigation-arrows">
                <button type="button" id="prevTabBtn">&larr; Voltar</button>
                <button type="button" id="nextTabBtn">Avançar &rarr;</button>
            </div>
        </div>
    </div>
</div>

<button type="button" id="exportButton">Salvar</button>

<script>
// --- LÓGICA DAS ABAS E NAVEGAÇÃO ---
const tabLinks = document.querySelectorAll(".tab-container-vertical .tab-link");
const prevTabBtn = document.getElementById('prevTabBtn');
const nextTabBtn = document.getElementById('nextTabBtn');

function openTab(evt, tabId) {
    let i, tabcontent, allTabLinks;
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    allTabLinks = document.getElementsByClassName("tab-link");
    for (i = 0; i < allTabLinks.length; i++) {
        allTabLinks[i].className = allTabLinks[i].className.replace(" active", "");
    }
    const newTab = document.getElementById(tabId);
    newTab.style.display = "block";
    if (evt) {
        evt.currentTarget.className += " active";
    } else {
        for(let link of allTabLinks){
            if(link.onclick.toString().includes(tabId)){
                link.className += " active";
            }
        }
    }
    
    const accordionsInNewTab = newTab.querySelectorAll('.accordion');
    accordionsInNewTab.forEach(acc => {
        acc.classList.remove('active');
        const panel = acc.nextElementSibling;
        if (panel) {
            panel.classList.remove('show');
        }
    });

    updateNavButtons();
}

function updateNavButtons() {
    let currentIdx = -1;
    tabLinks.forEach((link, idx) => {
        if(link.classList.contains('active')) {
            currentIdx = idx;
        }
    });
    prevTabBtn.disabled = (currentIdx <= 0);
    nextTabBtn.disabled = (currentIdx >= tabLinks.length - 1);
}

prevTabBtn.addEventListener('click', () => {
    let currentIdx = -1;
    tabLinks.forEach((link, idx) => {
        if(link.classList.contains('active')) {
            currentIdx = idx;
        }
    });
    if(currentIdx > 0) {
        tabLinks[currentIdx - 1].click();
    }
});

nextTabBtn.addEventListener('click', () => {
    let currentIdx = -1;
    tabLinks.forEach((link, idx) => {
        if(link.classList.contains('active')) {
            currentIdx = idx;
        }
    });
    if(currentIdx < tabLinks.length - 1) {
        tabLinks[currentIdx + 1].click();
    }
});


// --- LÓGICA DO ACORDEÃO (SEM ANIMAÇÃO) ---
document.querySelectorAll('.accordion').forEach(button => {
    button.addEventListener('click', () => {
        const panel = button.nextElementSibling;
        const wasActive = button.classList.contains('active');
        
        if (button.parentElement.classList.contains('tab-content') || button.parentElement.classList.contains('panel')) {
            const parentContainer = button.parentElement;
            parentContainer.querySelectorAll(':scope > .accordion').forEach(otherButton => {
                if (otherButton !== button) {
                    otherButton.classList.remove('active');
                    otherButton.nextElementSibling.classList.remove('show');
                }
            });
        }
        
        button.classList.toggle('active', !wasActive);
        panel.classList.toggle('show', !wasActive);
    });
});


// --- LÓGICA PARA CAMPO CONDICIONAL (DRENAGEM) ---
function toggleDrenagem(show) {
    document.getElementById('drenagem_proximidade_group').style.display = show ? 'block' : 'none';
}

// --- LÓGICA PARA LINHAS DINÂMICAS ---
function addInvertebradoRow(containerId) {
    const container = document.getElementById(containerId);
    const newRow = document.createElement('div');
    newRow.className = 'invertebrado-entry';
    newRow.innerHTML = `
        <div><input type="text" placeholder="Nome do táxon"></div>
        <div class="invertebrado-counters">
            <label class="counter-label">V</label>
            <div class="quantity-stepper">
                <button type="button" onclick="changeQuantity(this, -1)">-</button>
                <input type="number" value="0" min="0" class="quantity-v">
                <button type="button" onclick="changeQuantity(this, 1)">+</button>
            </div>
            <label class="counter-label">C</label>
            <div class="quantity-stepper">
                <button type="button" onclick="changeQuantity(this, -1)">-</button>
                <input type="number" value="0" min="0" class="quantity-c">
                <button type="button" onclick="changeQuantity(this, 1)">+</button>
            </div>
        </div>
    `;
    container.appendChild(newRow);
}

function addVertebradoRow(containerId) {
    const container = document.getElementById(containerId);
    const newRow = document.createElement('div');
    newRow.className = 'dynamic-row';
    newRow.innerHTML = `
        <input type="text" placeholder="Nome do táxon">
        <div class="quantity-stepper">
            <button type="button" onclick="changeQuantity(this, -1)">-</button>
            <input type="number" value="1" min="0" class="quantity-v">
            <button type="button" onclick="changeQuantity(this, 1)">+</button>
        </div>
    `;
    container.appendChild(newRow);
}

function changeQuantity(btn, amount) {
    const input = btn.parentElement.querySelector('input');
    let currentValue = parseInt(input.value);
    currentValue = isNaN(currentValue) ? 0 : currentValue;
    if (currentValue + amount >= 0) {
        input.value = currentValue + amount;
    }
}

// --- LÓGICA PARA GPS, FOTOS E EXPORTAÇÃO ---
let photoCounters = {};

function getGPS() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            document.getElementById('coordenadas').value = `${pos.coords.latitude}, ${pos.coords.longitude}`;
        }, err => alert(`Erro ao obter GPS: ${err.message}`));
    } else {
        alert('Geolocalização não é suportada por este navegador.');
    }
}

document.getElementById('take-photo-btn').addEventListener('click', () => document.getElementById('photo-input').click());

document.getElementById('photo-input').addEventListener('change', function(event) {
    const files = event.target.files;
    if (!files.length) return;

    const cavidadeBase = document.getElementById('nome_cavidade').value.trim() || 'sem_nome';
    const dataValue = document.getElementById('data').value.trim() || 'sem_data';
    
    if (cavidadeBase === 'sem_nome' || dataValue === 'sem_data') {
        alert('Preencha "Nome da cavidade" e "Data" antes de tirar fotos.');
        event.target.value = '';
        return;
    }

    const sanitizedCavidade = cavidadeBase.replace(/[^a-z0-9.-]/gi, '_');
    const formattedData = dataValue.replace(/-/g, '');
    const filenameBase = `${sanitizedCavidade}_${formattedData}`;

    photoCounters[filenameBase] = photoCounters[filenameBase] || 1;

    Array.from(files).forEach(file => {
        const currentCount = photoCounters[filenameBase]++;
        const filename = `${filenameBase}_(${currentCount}).jpg`;
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(file);
        link.download = filename;
        link.click();

        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        document.getElementById('photo-previews').appendChild(img);
    });
    event.target.value = '';
});

function downloadFile(filename, content, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.setAttribute("download", filename);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

document.getElementById('exportButton').addEventListener('click', function() {
    const form = document.getElementById('bioForm');
    const sanitize = (text) => (text || '').replace(/[^a-z0-9]/gi, '_').toLowerCase();
    
    const cavidadeNomeSanitized = sanitize(document.getElementById('nome_cavidade').value.trim());
    const projetoNome = sanitize(document.getElementById('projeto_localidade').value.trim());
    const dataNome = (document.getElementById('data').value || '').replace(/-/g, '');

    if (!cavidadeNomeSanitized || !projetoNome || !dataNome) {
        alert('Por favor, preencha os campos "Projeto/Localidade", "Nome da cavidade" e "Data" antes de salvar.');
        return;
    }
    
    const baseFilename = `${cavidadeNomeSanitized}_${projetoNome}_${dataNome}`;

    const generateTextFile = () => {
        const getValue = (id) => document.getElementById(id)?.value || '';
        const getSelectedText = (id) => {
            const select = document.getElementById(id);
            return (select && select.selectedIndex > 0) ? select.options[select.selectedIndex].text : '';
        };
        const getSelectedValue = (name) => document.querySelector(`input[name="${name}"]:checked`)?.value || '';
        const getCheckboxValues = (groupId) => Array.from(document.querySelectorAll(`#${groupId} input[type="checkbox"]:checked`)).map(cb => cb.value);

        const data = {
            nomeCavidade: getValue('nome_cavidade').toUpperCase(),
            declividade: getSelectedText('declividade').toLowerCase(),
            posicaoVertente: getSelectedText('posicao_vertente').toLowerCase(),
            vegetacao: getCheckboxValues('vegetacao-group'),
            distanciaDrenagem: getValue('drenagem_proximidade'),
            drenagem: getSelectedValue('drenagem'),
            inclinacaoPiso: getSelectedText('inclinacao_piso').toLowerCase(),
            sedimentos: getCheckboxValues('sedimentos-group'),
            umidade: getSelectedText('umidade'),
            hidrologia: getCheckboxValues('hidrologia-group'),
            zonacao: {
                aufotica: getValue('zonacao_eufotica'),
                disfotica: getValue('zonacao_disfotica'),
                afotica: getValue('zonacao_afotica')
            },
            recursos: getCheckboxValues('recursos-group'),
            outrosRecursos: getValue('outros_recursos'),
            guanoAusente: document.querySelector('input[name="guano_ausente"]:checked'),
            guano: {},
            aporte: getCheckboxValues('agentes-transportadores-group'),
            alteracoes: []
        };
        const guanoTypes = ['frugivoro', 'hematofago', 'insetivoro', 'nectarivoro'];
        guanoTypes.forEach(type => {
            const states = Array.from(document.querySelectorAll(`input[name="guano_${type}_estado"]:checked`)).map(cb => cb.value);
            if (states.length > 0) data.guano[type] = states;
        });
        if (getSelectedValue('pisoteio') === 'Presença') data.alteracoes.push('pisoteio');
        if (getSelectedValue('lixo') === 'Presença') data.alteracoes.push('lixo');
        if (getSelectedValue('poeira') === 'Presença') data.alteracoes.push('poeira');

        const vazio = '<span style="background-color:yellow;">[vazio]</span>';
        const formatList = (items, replaceMap = {}) => {
            if (!items || items.length === 0 || (items.length === 1 && items[0].toLowerCase() === 'ausente')) return vazio;
            const processedItems = items.map(item => (replaceMap[item] || item).toLowerCase());
            if (processedItems.length === 1) return processedItems[0];
            if (processedItems.length === 2) return `${processedItems[0]} e ${processedItems[1]}`;
            return `${processedItems.slice(0, -1).join(', ')} e ${processedItems.slice(-1)}`;
        };

        let s1 = `A cavidade ${data.nomeCavidade || '[N/A]'} está localizada em área com declividade ${data.declividade || vazio} na ${data.posicaoVertente || '[N/A]'} vertente.`;
        
        let s2 = `A vegetação de entorno é composta por espécies de porte ${formatList(data.vegetacao)}`;
        if (data.drenagem === 'Presença' && data.distanciaDrenagem) {
            s2 += ` e ela está a cerca de ${data.distanciaDrenagem} metros de distância de uma drenagem ativa.`;
        } else { s2 += `.`; }
        
        let s3_4 = `A cavidade apresenta uma inclinação predominantemente ${data.inclinacaoPiso || vazio}, sendo seu piso composto por ${formatList(data.sedimentos, {'Argila/Silte': 'sedimentos argilo-arenosos', 'Seixo': 'seixos', 'Matacão': 'matacões'})}.`;
        
        let umidadeTxt = data.umidade === 'Presença' ? 'úmida' : (data.umidade === 'Ausência' ? 'seca' : vazio);
        let hidroTxt = (data.hidrologia.length === 0 || data.hidrologia.some(h => h.toLowerCase() === 'ausente')) ? 'não foram observados processos hidrológicos ativos' : `foram observados processos hidrológicos como ${formatList(data.hidrologia)}`;
        let s5_6 = `A cavidade se encontrava ${umidadeTxt} e ${hidroTxt}.`;

        let lumParts = [];
        if(data.zonacao.aufotica) lumParts.push(`eufótica (${data.zonacao.aufotica}%)`);
        if(data.zonacao.disfotica) lumParts.push(`penumbra (${data.zonacao.disfotica}%)`);
        if(data.zonacao.afotica) lumParts.push(`afótica (${data.zonacao.afotica}%)`);
        let s7 = `Quanto à luminosidade, a cavidade pode ser dividida nas zonações ${lumParts.length > 0 ? formatList(lumParts) : vazio}.`;
        
        let recursosList = [...data.recursos];
        if (data.outrosRecursos) recursosList.push(data.outrosRecursos);
        let s8 = `Os recursos orgânicos são representados por ${formatList(recursosList)}.`;

        let s9 = '';
        if (data.guanoAusente || Object.keys(data.guano).length === 0) {
            s9 = `Guano: ${vazio}.`;
        } else {
            let guanoParts = [];
            for (const tipo in data.guano) {
                guanoParts.push(`${tipo} (${data.guano[tipo].join(' e ')})`);
            }
            s9 = `Há guano de morcegos ${formatList(guanoParts)}.`;
        }
        
        let s10 = `A cavidade recebe recursos tróficos pela ação de ${formatList(data.aporte)}.`;
        let s11 = `Alterações antrópicas são representadas por ${formatList(data.alteracoes)}.`;

        const fullText = [s1, s2, s3_4, s5_6, s7, s8, s9, s10, s11].join(' ');
        const htmlContent = `<!DOCTYPE html><html lang="pt-br"><head><meta charset="UTF-8"><title>${data.nomeCavidade || 'Relatório'}</title><style>body{font-family:Arial,sans-serif;}</style></head><body><p>${fullText}</p></body></html>`;
        
        downloadFile(`${cavidadeNomeSanitized}_texto.html`, htmlContent, 'text/html;charset=utf-8;');
    };

    const generateCsvFiles = () => {
        let allDataTemp = {};
        const orderedKeys = [
            'Data', 'Horário', 'Projeto/Localidade', 'Nome da cavidade', 'Estação', 'Clima', 'Equipe', 'Coordenadas',
            'Posição na vertente', 'Declividade', 'Drenagem Ativa', 'Proximidade da drenagem', 'Vegetação',
            'Inclinação predominante do piso', 'Sedimentos Clásticos', 'Umidade', 'Hidrologia', 'Luminosidade', 'Eppendorf', 'Falcon',
            'Pisoteio', 'Lixo', 'Poeira',
            'Recursos encontrados', 'Outros Recursos (Adicionar)',
            'Guano', 'Guano Frugívoro', 'Guano Hematófago', 'Guano Insetívoro', 'Guano Nectarívoro',
            'Agentes Transportadores',
            'Observações Gerais'
        ];

        form.querySelectorAll('input[type="text"], input[type="date"], input[type="time"], input[type="tel"], input[type="number"], textarea, select').forEach(el => {
            let label = el.closest('.form-group')?.querySelector('label')?.innerText.replace(/:$/, '') || el.name || el.id;
            if (el.value && (el.type !== 'number' || el.value !== '0')) {
                 allDataTemp[label] = el.value;
            }
        });
        form.querySelectorAll('input[type="radio"]:checked').forEach(el => {
            let labelText = el.closest('.form-group')?.querySelector('label')?.innerText.replace(/:$/, '') || el.name.charAt(0).toUpperCase() + el.name.slice(1);
            allDataTemp[labelText] = el.value;
        });
        const checkboxes = {};
        form.querySelectorAll('input[type="checkbox"]:checked').forEach(el => {
            if (el.name === 'guano_ausente') return;
            let name = el.closest('.panel, .form-group')?.previousElementSibling?.innerText.replace(/:$/, '') || el.closest('.form-group')?.querySelector('label')?.innerText.replace(/:$/, '') || el.name;
            if (!checkboxes[name]) checkboxes[name] = [];
            checkboxes[name].push(el.value);
        });
        for (const [key, value] of Object.entries(checkboxes)) {
            allDataTemp[key] = value;
        }
        const guanoAusenteCheckbox = document.querySelector('input[name="guano_ausente"]');
        if (guanoAusenteCheckbox && guanoAusenteCheckbox.checked) {
            allDataTemp['Guano'] = 'ausente';
        } else {
            const guanoTypes = ['frugivoro', 'hematofago', 'insetivoro', 'nectarivoro'];
            guanoTypes.forEach(type => {
                const states = [];
                document.querySelectorAll(`input[name="guano_${type}_estado"]:checked`).forEach(cb => states.push(cb.value));
                if (states.length > 0) {
                    allDataTemp[`Guano ${type.charAt(0).toUpperCase() + type.slice(1)}`] = states;
                }
            });
        }
        
        let principalHeaders = [], principalValues = [];
        orderedKeys.forEach(key => {
            if (allDataTemp[key]) {
                principalHeaders.push(key);
                let value = Array.isArray(allDataTemp[key]) ? allDataTemp[key].join(', ') : allDataTemp[key];
                principalValues.push(`"${String(value).replace(/"/g, '""')}"`);
            }
        });
        
        if(principalHeaders.length > 0){
            downloadFile(`${baseFilename}_principal.csv`, `\uFEFF${principalHeaders.join(';')}\n${principalValues.join(';')}`, 'text/csv;charset=utf-8;');
        }
        
        let taxonRows = [];
        const clean = val => `"${String(val).toLowerCase().replace(/"/g, '""')}"`;
        const estacao = form.querySelector('select[name="estacao"]')?.value || '';
        const projeto = document.getElementById('projeto_localidade').value.trim();
        const data = document.getElementById('data').value.trim();
        const horario = document.getElementById('horario').value.trim();
        const cavidade = document.getElementById('nome_cavidade').value.trim();
        form.querySelectorAll('#invertebrados-container .invertebrado-entry').forEach(row => {
            const nome = row.querySelector('input[type="text"]').value;
            const qtd_v = row.querySelector('.quantity-v').value;
            const qtd_c = row.querySelector('.quantity-c').value;
            if (nome && (parseInt(qtd_v, 10) > 0 || parseInt(qtd_c, 10) > 0)) {
                taxonRows.push([clean(data), clean(horario), clean(projeto), clean(cavidade), clean(estacao), 'Invertebrado', clean(nome), clean(qtd_v), clean(qtd_c)].join(';'));
            }
        });
        form.querySelectorAll('#vertebrados-container .dynamic-row').forEach(row => {
            const nome = row.querySelector('input[type="text"]').value;
            const qtd = row.querySelector('.quantity-v').value;
            if (nome && parseInt(qtd, 10) > 0) {
                taxonRows.push([clean(data), clean(horario), clean(projeto), clean(cavidade), clean(estacao), 'Vertebrado', clean(nome), clean(qtd), ''].join(';'));
            }
        });

        if (taxonRows.length > 0) {
            const taxonHeader = 'Data;Horário;Projeto/Localidade;Nome da cavidade;Estação;Grupo;Táxon;Quantidade_V;Quantidade_C';
            const taxonCsvContent = `\uFEFF${taxonHeader}\n${taxonRows.join('\n')}`;
            downloadFile(`${baseFilename}_taxons.csv`, taxonCsvContent, 'text/csv;charset=utf-8;');
        }
    };

    generateCsvFiles();
    generateTextFile();
});


// --- LÓGICAS DE INTERAÇÃO ---
document.addEventListener('DOMContentLoaded', (event) => {
    openTab(null, 'tabDadosGerais'); 
    addInvertebradoRow('invertebrados-container');
    addVertebradoRow('vertebrados-container');
    updateNavButtons();

    function setupExclusiveAusenteCheckbox(groupId, ausenteValue) {
        const group = document.getElementById(groupId);
        if (!group) return;

        const allCheckboxes = group.querySelectorAll('input[type="checkbox"]');
        const ausenteCheckbox = group.querySelector(`input[value="${ausenteValue}"]`);
        
        if (!ausenteCheckbox) return;

        allCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const isAusente = e.target.value === ausenteValue;
                const isChecked = e.target.checked;

                if (isAusente && isChecked) {
                    allCheckboxes.forEach(cb => {
                        if (cb.value !== ausenteValue) {
                            cb.checked = false;
                            cb.disabled = true;
                        }
                    });
                } else if (isAusente && !isChecked) {
                    allCheckboxes.forEach(cb => {
                        cb.disabled = false;
                    });
                } else if (!isAusente && isChecked) {
                    ausenteCheckbox.checked = false;
                    allCheckboxes.forEach(cb => {
                        cb.disabled = false;
                    });
                }
            });
        });
    }

    setupExclusiveAusenteCheckbox('sedimentos-group', 'Ausente');
    setupExclusiveAusenteCheckbox('recursos-group', 'Ausente');
    setupExclusiveAusenteCheckbox('vegetacao-group', 'Ausente');
    setupExclusiveAusenteCheckbox('hidrologia-group', 'Ausente');

    const guanoGrid = document.getElementById('guano-grid');
    const guanoAusente = guanoGrid.querySelector('input[name="guano_ausente"]');
    const otherGuanoCheckboxes = guanoGrid.querySelectorAll('.guano-grid input[type="checkbox"]');

    guanoAusente.addEventListener('change', (e) => {
        if (e.target.checked) {
            otherGuanoCheckboxes.forEach(cb => {
                cb.checked = false;
                cb.disabled = true;
            });
        } else {
            otherGuanoCheckboxes.forEach(cb => {
                cb.disabled = false;
            });
        }
    });

    otherGuanoCheckboxes.forEach(cb => {
        cb.addEventListener('change', (e) => {
            if (e.target.checked) {
                guanoAusente.checked = false;
                otherGuanoCheckboxes.forEach(other_cb => {
                    other_cb.disabled = false;
                });
            }
        });
    });
});
</script>

</body>
</html>