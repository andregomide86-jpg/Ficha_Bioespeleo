const generateTextFileContent = () => {
    const getValue = (id) => document.getElementById(id)?.value || '';
    const getSelectedText = (id) => {
        const select = document.getElementById(id);
        return (select && select.selectedIndex > 0) ? select.options[select.selectedIndex].text : '';
    };
    const getSelectedValue = (name) => document.querySelector(`input[name="${name}"]:checked`)?.value || '';
    const getCheckboxValues = (groupId) => Array.from(document.querySelectorAll(`#${groupId} input[type="checkbox"]:checked`)).map(cb => cb.value);

    const data = {
        nomeCavidade: getValue('nome_cavidade').toUpperCase(),
        declividade: getSelectedText('declividade').toLowerCase(),
        posicaoVertente: getSelectedText('posicao_vertente').toLowerCase(),
        vegetacao: getCheckboxValues('vegetacao-group'),
        distanciaDrenagem: getValue('drenagem_proximidade'),
        drenagem: getSelectedValue('drenagem'),
        inclinacaoPiso: getSelectedText('inclinacao_piso').toLowerCase(),
        sedimentos: getCheckboxValues('sedimentos-group'),
        umidade: getSelectedText('umidade'),
        estacao: getSelectedText('estacao').toLowerCase(),
        hidrologia: getCheckboxValues('hidrologia-group'),
        zonacao: {
            eufotica: getValue('zonacao_eufotica'),
            disfotica: getValue('zonacao_disfotica'),
            afotica: getValue('zonacao_afotica')
        },
        recursos: getCheckboxValues('recursos-group'),
        outrosRecursos: getValue('outros_recursos'),
        guanoAusente: document.querySelector('input[name="guano_ausente"]:checked'),
        guano: {},
        aporte: getCheckboxValues('agentes-transportadores-group'),
        alteracoes: []
    };
    const guanoTypes = ['frugivoros', 'hematofagos', 'insetivoros', 'nectarivoros'];
    guanoTypes.forEach(type => {
        const states = Array.from(document.querySelectorAll(`input[name="guano_${type.slice(0,-1)}_estado"]:checked`)).map(cb => cb.value);
        if (states.length > 0) data.guano[type] = states;
    });
    if (getSelectedValue('pisoteio') === 'Presença') data.alteracoes.push('pisoteio');
    if (getSelectedValue('lixo') === 'Presença') data.alteracoes.push('lixo');
    if (getSelectedValue('poeira') === 'Presença') data.alteracoes.push('poeira');

    const vazio = '<span style="background-color:yellow;">[vazio]</span>';
    const formatList = (items, replaceMap = {}) => {
        if (!items || items.length === 0 || (items.length === 1 && items[0].toLowerCase() === 'ausente')) return vazio;
        const processedItems = items.map(item => (replaceMap[item] || item).toLowerCase());
        if (processedItems.length === 1) return processedItems[0];
        if (processedItems.length === 2) return `${processedItems[0]} e ${processedItems[1]}`;
        return `${processedItems.slice(0, -1).join(', ')} e ${processedItems.slice(-1)}`;
    };

    // --- GERAÇÃO DE TEXTO ATUALIZADA ---

    let s1 = `A cavidade ${data.nomeCavidade || '[N/A]'} está situada em uma área de declividade ${data.declividade.replace(' ', ' e ') || vazio} na ${data.posicaoVertente || '[N/A]'} vertente.`;
    
    let s2 = `O entorno é composto por vegetação de porte ${formatList(data.vegetacao)}`;
    if (data.drenagem === 'Presença' && data.distanciaDrenagem) {
        s2 += `, e a localização fica a aproximadamente ${data.distanciaDrenagem} metros de uma drenagem ativa.`;
    } else { s2 += `.`; }
    
    let s3_4 = `A inclinação interna é predominantemente ${data.inclinacaoPiso || vazio}, com o piso formado por ${formatList(data.sedimentos, {'Argila/Silte': 'sedimentos argilo-arenosos', 'Seixo': 'seixos', 'Matacão': 'matacões'})}.`;
    
    let umidadeTxt = data.umidade === 'Presença' ? 'úmida' : (data.umidade === 'Ausência' ? 'seca' : vazio);
    let estacaoTxt = data.estacao ? ` na estação ${data.estacao}` : '';
    let s5_6;
    if (data.hidrologia.length === 0 || data.hidrologia.some(h => h.toLowerCase() === 'ausente')) {
        s5_6 = `Encontrava-se ${umidadeTxt}${estacaoTxt} e não foram observados processos hidrológicos ativos.`;
    } else {
        s5_6 = `Encontrava-se ${umidadeTxt}${estacaoTxt}, apresentando processos hidrológicos como ${formatList(data.hidrologia)}.`;
    }

    let lumParts = [];
    if(data.zonacao.eufotica) lumParts.push(`eufótica (${data.zonacao.eufotica}%)`);
    if(data.zonacao.disfotica) lumParts.push(`penumbra (${data.zonacao.disfotica}%)`);
    if(data.zonacao.afotica) lumParts.push(`afótica (${data.zonacao.afotica}%)`);
    let s7 = `Em relação à luminosidade, a cavidade pode ser dividida nas zonas ${lumParts.length > 0 ? formatList(lumParts) : vazio}.`;
    
    // --- LÓGICA ATUALIZADA PARA A FRASE DE RECURSOS (s8) ---
    let recursosList = [...data.recursos];
    if (data.outrosRecursos) {
        const outros = data.outrosRecursos.split('\n').filter(item => item.trim() !== '');
        recursosList.push(...outros);
    }
    
    let s8;
    const chunkSize = 4;

    if (!recursosList || recursosList.length === 0 || (recursosList.length === 1 && recursosList[0].toLowerCase() === 'ausente')) {
        s8 = `Os recursos orgânicos são representados por ${vazio}.`;
    } else {
        const firstChunk = recursosList.slice(0, chunkSize);
        s8 = `Os recursos orgânicos são representados por ${formatList(firstChunk)}.`;

        const remainingChunk = recursosList.slice(chunkSize);
        if (remainingChunk.length > 0) {
            if (remainingChunk.length === 1) {
                const item = remainingChunk[0];
                const capitalizedItem = item.charAt(0).toUpperCase() + item.slice(1);
                s8 += ` ${capitalizedItem} também foi observado.`;
            } else {
                s8 += ` Também foram observados ${formatList(remainingChunk)}.`;
            }
        }
    }
    // --- FIM DA LÓGICA ATUALIZADA ---
    
    let s9 = '';
    if (data.guanoAusente || Object.keys(data.guano).length === 0) {
        s9 = `Guano: ${vazio}.`;
    } else {
        let guanoParts = [];
        for (const tipo in data.guano) {
            guanoParts.push(`${tipo.slice(0, -1)}s (${data.guano[tipo].join(', ')})`);
        }
        s9 = `Foi identificado guano de morcegos ${formatList(guanoParts)}.`;
    }
    
    let s10 = `Os recursos tróficos chegam pela ação de ${formatList(data.aporte)}.`;
    let s11 = `Alterações antrópicas são representadas por ${formatList(data.alteracoes)}.`;

    const fullText = [s1, s2, s3_4, s5_6, s7, s8, s9, s10, s11].join(' ');
    const htmlContent = `<!DOCTYPE html><html lang="pt-br"><head><meta charset="UTF-8"><title>${data.nomeCavidade || 'Relatório'}</title><style>body{font-family:Arial,sans-serif;}</style></head><body><p>${fullText}</p></body></html>`;
    
    return htmlContent;
};
